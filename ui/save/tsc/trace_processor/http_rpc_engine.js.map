{"version":3,"file":"http_rpc_engine.js","sourceRoot":"","sources":["../../../src/trace_processor/http_rpc_engine.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2019 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport protos from '../protos';\nimport {fetchWithTimeout} from '../base/http_utils';\nimport {assertExists} from '../base/logging';\nimport {EngineBase} from '../trace_processor/engine';\n\nconst RPC_CONNECT_TIMEOUT_MS = 2000;\n\nexport interface HttpRpcState {\n  connected: boolean;\n  status?: protos.StatusResult;\n  failure?: string;\n}\n\nexport class HttpRpcEngine extends EngineBase {\n  readonly mode = 'HTTP_RPC';\n  readonly id: string;\n  private requestQueue = new Array<Uint8Array>();\n  private websocket?: WebSocket;\n  private connected = false;\n  private disposed = false;\n\n  // Can be changed by frontend/index.ts when passing ?rpc_port=1234 .\n  static rpcPort = '9001';\n\n  constructor(id: string) {\n    super();\n    this.id = id;\n  }\n\n  rpcSendRequestBytes(data: Uint8Array): void {\n    if (this.websocket === undefined) {\n      if (this.disposed) return;\n      const wsUrl = `ws://${HttpRpcEngine.hostAndPort}/websocket`;\n      this.websocket = new WebSocket(wsUrl);\n      this.websocket.onopen = () => this.onWebsocketConnected();\n      this.websocket.onmessage = (e) => this.onWebsocketMessage(e);\n      this.websocket.onclose = (e) => this.onWebsocketClosed(e);\n      this.websocket.onerror = (e) =>\n        super.fail(\n          `WebSocket error rs=${(e.target as WebSocket)?.readyState} (ERR:ws)`,\n        );\n    }\n\n    if (this.connected) {\n      this.websocket.send(data);\n    } else {\n      this.requestQueue.push(data); // onWebsocketConnected() will flush this.\n    }\n  }\n\n  private onWebsocketConnected() {\n    for (;;) {\n      const queuedMsg = this.requestQueue.shift();\n      if (queuedMsg === undefined) break;\n      assertExists(this.websocket).send(queuedMsg);\n    }\n    this.connected = true;\n  }\n\n  private onWebsocketClosed(e: CloseEvent) {\n    if (this.disposed) return;\n    if (e.code === 1006 && this.connected) {\n      // On macbooks the act of closing the lid / suspending often causes socket\n      // disconnections. Try to gracefully re-connect.\n      console.log('Websocket closed, reconnecting');\n      this.websocket = undefined;\n      this.connected = false;\n      this.rpcSendRequestBytes(new Uint8Array()); // Triggers a reconnection.\n    } else {\n      super.fail(`Websocket closed (${e.code}: ${e.reason}) (ERR:ws)`);\n    }\n  }\n\n  private onWebsocketMessage(e: MessageEvent) {\n    assertExists(e.data as Blob)\n      .arrayBuffer()\n      .then((buf) => {\n        super.onRpcResponseBytes(new Uint8Array(buf));\n      });\n  }\n\n  static async checkConnection(): Promise<HttpRpcState> {\n    const RPC_URL = `http://${HttpRpcEngine.hostAndPort}/`;\n    const httpRpcState: HttpRpcState = {connected: false};\n    console.info(\n      `It's safe to ignore the ERR_CONNECTION_REFUSED on ${RPC_URL} below. ` +\n        `That might happen while probing the external native accelerator. The ` +\n        `error is non-fatal and unlikely to be the culprit for any UI bug.`,\n    );\n    try {\n      const resp = await fetchWithTimeout(\n        RPC_URL + 'status',\n        {method: 'post', cache: 'no-cache'},\n        RPC_CONNECT_TIMEOUT_MS,\n      );\n      if (resp.status !== 200) {\n        httpRpcState.failure = `${resp.status} - ${resp.statusText}`;\n      } else {\n        const buf = new Uint8Array(await resp.arrayBuffer());\n        httpRpcState.connected = true;\n        httpRpcState.status = protos.StatusResult.decode(buf);\n      }\n    } catch (err) {\n      httpRpcState.failure = `${err}`;\n    }\n    return httpRpcState;\n  }\n\n  static get hostAndPort() {\n    return `127.0.0.1:${HttpRpcEngine.rpcPort}`;\n  }\n\n  [Symbol.dispose]() {\n    this.disposed = true;\n    const websocket = this.websocket;\n    this.websocket = undefined;\n    websocket?.close();\n  }\n}\n"]}