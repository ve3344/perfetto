{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/chrome_extension/index.ts"],"names":[],"mappings":";AAAA,qDAAqD;AACrD,EAAE;AACF,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,kDAAkD;AAClD,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;;AAEjC,uDAAkD;AAClD,2EAAoE;AAEpE,IAAI,qBAAqB,GAAwC,SAAS,CAAC;AAE3E,wBAAwB,EAAE,CAAC;AAE3B,4CAA4C;AAC5C,yEAAyE;AACzE,IAAI,UAAU,CAAC,MAAM,EAAE,CAAC;IACtB,MAAM,CAAC,OAAO,CAAC,iBAAiB,CAAC,WAAW,CAAC,CAAC,IAAI,EAAE,EAAE;QACpD,qBAAqB,GAAG,IAAI,mDAAuB,CAAC,IAAI,CAAC,CAAC;QAC1D,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;IAC1C,CAAC,CAAC,CAAC;AACL,CAAC;AAED,SAAS,WAAW,CAClB,OAA8C,EAC9C,IAAyB;IAEzB,IAAI,OAAO,CAAC,MAAM,KAAK,kBAAkB,EAAE,CAAC;QAC1C,IAAI,CAAC,WAAW,CAAC,EAAC,OAAO,EAAE,MAAM,CAAC,OAAO,CAAC,WAAW,EAAE,CAAC,OAAO,EAAC,CAAC,CAAC;QAClE,OAAO;IACT,CAAC;IACD,OAAO,CAAC,MAAM,CAAC,qBAAqB,KAAK,SAAS,CAAC,CAAC;IACpD,IAAI,CAAC,qBAAqB;QAAE,OAAO;IACnC,uEAAuE;IACvE,oDAAoD;IACpD,MAAM,gBAAgB,GAAe,OAAO,CAAC,WAAW;QACtD,CAAC,CAAC,IAAA,2BAAY,EAAC,OAAO,CAAC,WAAW,CAAC;QACnC,CAAC,CAAC,IAAI,UAAU,EAAE,CAAC;IACrB,qBAAqB,CAAC,aAAa,CAAC,OAAO,CAAC,MAAM,EAAE,gBAAgB,CAAC,CAAC;AACxE,CAAC;AAED,SAAS,wBAAwB;IAC/B,SAAS,sBAAsB,CAAC,MAAc;QAC5C,OAAO;YACL,UAAU,EAAE;gBACV,IAAI,MAAM,CAAC,kBAAkB,CAAC,gBAAgB,CAAC;oBAC7C,OAAO,EAAE,EAAC,UAAU,EAAE,MAAM,EAAC;iBAC9B,CAAC;aACH;YACD,OAAO,EAAE,CAAC,IAAI,MAAM,CAAC,kBAAkB,CAAC,cAAc,EAAE,CAAC;SAC1D,CAAC;IACJ,CAAC;IACD,MAAM,CAAC,kBAAkB,CAAC,aAAa,CAAC,WAAW,CAAC,SAAS,EAAE,GAAG,EAAE;QAClE,MAAM,CAAC,kBAAkB,CAAC,aAAa,CAAC,QAAQ,CAAC;YAC/C,sBAAsB,CAAC,WAAW,CAAC;YACnC,sBAAsB,CAAC,WAAW,CAAC;YACnC,sBAAsB,CAAC,eAAe,CAAC;YACvC,sBAAsB,CAAC,yBAAyB,CAAC;SAClD,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC","sourcesContent":["// Copyright (C) 2019 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {binaryDecode} from '../base/string_utils';\nimport {ChromeTracingController} from './chrome_tracing_controller';\n\nlet chromeTraceController: ChromeTracingController | undefined = undefined;\n\nenableOnlyOnPerfettoHost();\n\n// Listen for messages from the perfetto ui.\n// eslint-disable-next-line @typescript-eslint/strict-boolean-expressions\nif (globalThis.chrome) {\n  chrome.runtime.onConnectExternal.addListener((port) => {\n    chromeTraceController = new ChromeTracingController(port);\n    port.onMessage.addListener(onUIMessage);\n  });\n}\n\nfunction onUIMessage(\n  message: {method: string; requestData: string},\n  port: chrome.runtime.Port,\n) {\n  if (message.method === 'ExtensionVersion') {\n    port.postMessage({version: chrome.runtime.getManifest().version});\n    return;\n  }\n  console.assert(chromeTraceController !== undefined);\n  if (!chromeTraceController) return;\n  // ChromeExtensionConsumerPort sends the request data as string because\n  // chrome.runtime.port doesn't support ArrayBuffers.\n  const requestDataArray: Uint8Array = message.requestData\n    ? binaryDecode(message.requestData)\n    : new Uint8Array();\n  chromeTraceController.handleCommand(message.method, requestDataArray);\n}\n\nfunction enableOnlyOnPerfettoHost() {\n  function enableOnHostWithSuffix(suffix: string) {\n    return {\n      conditions: [\n        new chrome.declarativeContent.PageStateMatcher({\n          pageUrl: {hostSuffix: suffix},\n        }),\n      ],\n      actions: [new chrome.declarativeContent.ShowPageAction()],\n    };\n  }\n  chrome.declarativeContent.onPageChanged.removeRules(undefined, () => {\n    chrome.declarativeContent.onPageChanged.addRules([\n      enableOnHostWithSuffix('localhost'),\n      enableOnHostWithSuffix('127.0.0.1'),\n      enableOnHostWithSuffix('.perfetto.dev'),\n      enableOnHostWithSuffix('.storage.googleapis.com'),\n    ]);\n  });\n}\n"]}