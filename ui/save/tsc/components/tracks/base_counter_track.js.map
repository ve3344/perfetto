{"version":3,"file":"base_counter_track.js","sourceRoot":"","sources":["../../../../src/components/tracks/base_counter_track.ts"],"names":[],"mappings":";AAAA,qDAAqD;AACrD,EAAE;AACF,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,kDAAkD;AAClD,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;;;;AAEjC,8DAAwB;AACxB,4DAAuD;AACvD,gDAAiE;AACjE,0CAA2C;AAC3C,0CAA0C;AAC1C,0DAA8D;AAC9D,4DAA6C;AAC7C,qDAA0C;AAE1C,iDAA4C;AAC5C,6CAAqE;AACrE,qEAA6D;AAC7D,kDAAmD;AACnD,kEAAiE;AAGjE,SAAS,SAAS,CAAC,CAAS;IAC1B,MAAM,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;IAC5D,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,EAAE,EAAE,GAAG,CAAC,CAAC;IAChC,OAAO,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,CAAC,KAAK,GAAG,EAAE,CAAC,CAAC,GAAG,CAAC,KAAK,GAAG,EAAE,CAAC,CAAC,CAAC;AAC/E,CAAC;AAED,SAAS,OAAO,CAAC,CAAS;IACxB,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;QACZ,OAAO,GAAG,CAAC;IACb,CAAC;IACD,MAAM,KAAK,GAAuB;QAChC,CAAC,WAAW,EAAE,GAAG,CAAC;QAClB,CAAC,QAAQ,EAAE,GAAG,CAAC;QACf,CAAC,KAAK,EAAE,GAAG,CAAC;QACZ,CAAC,CAAC,EAAE,EAAE,CAAC;QACP,CAAC,IAAI,EAAE,GAAG,CAAC;QACX,CAAC,IAAI,GAAG,IAAI,EAAE,GAAG,CAAC;QAClB,CAAC,IAAI,GAAG,IAAI,GAAG,IAAI,EAAE,GAAG,CAAC;QACzB,CAAC,IAAI,GAAG,IAAI,GAAG,IAAI,GAAG,IAAI,EAAE,GAAG,CAAC;KACjC,CAAC;IACF,IAAI,iBAAiB,CAAC;IACtB,IAAI,WAAW,CAAC;IAChB,CAAC,iBAAiB,EAAE,WAAW,CAAC,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;IAC5C,MAAM,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;IACzB,KAAK,MAAM,CAAC,UAAU,EAAE,IAAI,CAAC,IAAI,KAAK,EAAE,CAAC;QACvC,IAAI,UAAU,GAAG,IAAI,EAAE,CAAC;YACtB,MAAM;QACR,CAAC;QACD,CAAC,iBAAiB,EAAE,WAAW,CAAC,GAAG,CAAC,UAAU,EAAE,IAAI,CAAC,CAAC;IACxD,CAAC;IACD,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,GAAG,iBAAiB,CAAC,GAAG,WAAW,EAAE,CAAC;AAC9D,CAAC;AAED,MAAM,WAAW;IACf,MAAM,CAAC,SAAS,CAAe;IAE/B,MAAM,CAAC,GAAG;QACR,IAAI,WAAW,CAAC,SAAS,KAAK,SAAS,EAAE,CAAC;YACxC,WAAW,CAAC,SAAS,GAAG,IAAI,WAAW,EAAE,CAAC;QAC5C,CAAC;QACD,OAAO,WAAW,CAAC,SAAS,CAAC;IAC/B,CAAC;IAEO,UAAU,CAAgC;IAC1C,YAAY,CAAuB;IAE3C;QACE,IAAI,CAAC,UAAU,GAAG,IAAI,GAAG,EAAE,CAAC;QAC5B,IAAI,CAAC,YAAY,GAAG,IAAI,GAAG,EAAE,CAAC;IAChC,CAAC;IAED,SAAS,CAAC,GAAW;QACnB,MAAM,KAAK,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QACzC,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;YACxB,OAAO,IAAI,CAAC;QACd,CAAC;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAED,UAAU,CAAC,GAAW,EAAE,OAAgB;QACtC,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;IACtC,CAAC;IAED,KAAK,CACH,OAAuB,EACvB,CAAC,GAAG,EAAE,GAAG,CAAmB;QAE5B,MAAM,GAAG,GAAG,OAAO,CAAC,gBAAgB,CAAC;QACrC,IAAI,GAAG,KAAK,SAAS,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,EAAE,CAAC;YAC9C,OAAO,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;QACpB,CAAC;QAED,MAAM,GAAG,GAAG,GAAG,OAAO,CAAC,gBAAgB,IAAI,OAAO,CAAC,KAAK,IACtD,OAAO,CAAC,QACV,IAAI,CAAC,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;QACxB,MAAM,WAAW,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAC7C,IAAI,WAAW,KAAK,SAAS,EAAE,CAAC;YAC9B,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC;YACrC,OAAO,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;QACpB,CAAC;QAED,WAAW,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;QAC/C,WAAW,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;QAE/C,OAAO,CAAC,WAAW,CAAC,CAAC,CAAC,EAAE,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;IAC1C,CAAC;CACF;AAUD,wCAAwC;AACxC,MAAM,UAAU,GAAG,GAAG,CAAC;AAsDvB,MAAsB,gBAAgB;IA0Df;IACA;IACA;IA3DX,SAAS,GAAG,IAAA,gBAAS,GAAE,CAAC;IAElC,0CAA0C;IAClC,WAAW,GAAa,yBAAQ,CAAC,IAAI,EAAE,CAAC;IAExC,QAAQ,GAAgB;QAC9B,UAAU,EAAE,IAAI,aAAa,CAAC,CAAC,CAAC;QAChC,gBAAgB,EAAE,IAAI,YAAY,CAAC,CAAC,CAAC;QACrC,gBAAgB,EAAE,IAAI,YAAY,CAAC,CAAC,CAAC;QACrC,iBAAiB,EAAE,IAAI,YAAY,CAAC,CAAC,CAAC;QACtC,iBAAiB,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;KAC1B,CAAC;IAEM,MAAM,CAAiB;IAEvB,QAAQ,GAAG,EAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAC,CAAC;IACxB,KAAK,CAAuB;IAC5B,OAAO,CAAkB;IAEhB,KAAK,CAAuB;IAErC,iBAAiB;QACvB,IAAI,IAAI,CAAC,OAAO,KAAK,SAAS,EAAE,CAAC;YAC/B,MAAM,OAAO,GAAG,IAAI,CAAC,wBAAwB,EAAE,CAAC;YAChD,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,IAAI,CAAC,cAAc,CAAC,EAAE,CAAC;gBAC/D,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;oBACxB,8DAA8D;oBAC7D,OAAe,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;gBAChC,CAAC;YACH,CAAC;YACD,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACzB,CAAC;QACD,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAED,oBAAoB;IAEpB,oEAAoE;IACpE,gEAAgE;IAChE,6DAA6D;IAC7D,gEAAgE;IAChE,+BAA+B;IAC/B,KAAK,CAAC,MAAM,KAAqC,CAAC;IAKxC,wBAAwB;QAChC,OAAO;YACL,MAAM,EAAE,KAAK;YACb,cAAc,EAAE,gBAAgB;YAChC,KAAK,EAAE,OAAO;YACd,QAAQ,EAAE,MAAM;SACjB,CAAC;IACJ,CAAC;IAED,YACqB,KAAY,EACZ,GAAW,EACX,iBAA0C,EAAE;QAF5C,UAAK,GAAL,KAAK,CAAO;QACZ,QAAG,GAAH,GAAG,CAAQ;QACX,mBAAc,GAAd,cAAc,CAA8B;QAE/D,IAAI,CAAC,KAAK,GAAG,IAAI,uCAAoB,EAAE,CAAC;IAC1C,CAAC;IAED,SAAS;QACP,MAAM,MAAM,GAAG,EAAE,CAAC;QAClB,OAAO,IAAI,CAAC,iBAAiB,EAAE,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC;IAChE,CAAC;IAED,0DAA0D;IAC1D,mEAAmE;IACnE,gBAAgB;IACN,0BAA0B;QAClC,MAAM,OAAO,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;QAEzC,OAAO;YACL,IAAA,iBAAC,EACC,eAAQ,EACR;gBACE,KAAK,EAAE,uBAAuB,OAAO,CAAC,QAAQ,GAAG;aAClD,EAED,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,YAAY;gBACnB,IAAI,EACF,OAAO,CAAC,QAAQ,KAAK,MAAM;oBACzB,CAAC,CAAC,sBAAsB;oBACxB,CAAC,CAAC,wBAAwB;gBAC9B,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,QAAQ,GAAG,MAAM,CAAC;oBAC1B,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC,EAEF,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,SAAS;gBAChB,IAAI,EACF,OAAO,CAAC,QAAQ,KAAK,QAAQ;oBAC3B,CAAC,CAAC,sBAAsB;oBACxB,CAAC,CAAC,wBAAwB;gBAC9B,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,QAAQ,GAAG,QAAQ,CAAC;oBAC5B,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC,EAEF,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,KAAK;gBACZ,IAAI,EACF,OAAO,CAAC,QAAQ,KAAK,KAAK;oBACxB,CAAC,CAAC,sBAAsB;oBACxB,CAAC,CAAC,wBAAwB;gBAC9B,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,QAAQ,GAAG,KAAK,CAAC;oBACzB,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC,CACH;YAED,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,gBAAgB;gBACvB,IAAI,EACF,OAAO,CAAC,MAAM,KAAK,UAAU;oBAC3B,CAAC,CAAC,WAAW;oBACb,CAAC,CAAC,yBAAyB;gBAC/B,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,MAAM,GAAG,OAAO,CAAC,MAAM,KAAK,UAAU,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,UAAU,CAAC;oBACpE,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC;YAEF,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,SAAS;gBAChB,IAAI,EAAE,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,yBAAyB;gBAC/D,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,OAAO,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC;oBACnC,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC;YAEF,OAAO,CAAC,gBAAgB;gBACtB,IAAA,iBAAC,EAAC,eAAQ,EAAE;oBACV,KAAK,EAAE,8BAA8B,OAAO,CAAC,gBAAgB,GAAG;oBAChE,IAAI,EAAE,WAAW,CAAC,GAAG,EAAE,CAAC,SAAS,CAAC,OAAO,CAAC,gBAAgB,CAAC;wBACzD,CAAC,CAAC,WAAW;wBACb,CAAC,CAAC,yBAAyB;oBAC7B,OAAO,EAAE,GAAG,EAAE;wBACZ,MAAM,GAAG,GAAG,OAAO,CAAC,gBAAgB,CAAC;wBACrC,IAAI,GAAG,KAAK,SAAS,EAAE,CAAC;4BACtB,OAAO;wBACT,CAAC;wBACD,MAAM,MAAM,GAAG,WAAW,CAAC,GAAG,EAAE,CAAC;wBACjC,MAAM,CAAC,UAAU,CAAC,GAAG,EAAE,CAAC,MAAM,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC;wBAC/C,IAAI,CAAC,UAAU,EAAE,CAAC;oBACpB,CAAC;iBACF,CAAC;YAEJ,IAAA,iBAAC,EAAC,kBAAW,CAAC;YACd,IAAA,iBAAC,EACC,eAAQ,EACR;gBACE,KAAK,EAAE,oBAAoB,OAAO,CAAC,KAAK,GAAG;aAC5C,EAED,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,OAAO;gBACd,IAAI,EACF,OAAO,CAAC,KAAK,KAAK,OAAO;oBACvB,CAAC,CAAC,sBAAsB;oBACxB,CAAC,CAAC,wBAAwB;gBAC9B,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,KAAK,GAAG,OAAO,CAAC;oBACxB,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC,EAEF,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,OAAO;gBACd,IAAI,EACF,OAAO,CAAC,KAAK,KAAK,OAAO;oBACvB,CAAC,CAAC,sBAAsB;oBACxB,CAAC,CAAC,wBAAwB;gBAC9B,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,KAAK,GAAG,OAAO,CAAC;oBACxB,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC,EAEF,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,MAAM;gBACb,IAAI,EACF,OAAO,CAAC,KAAK,KAAK,MAAM;oBACtB,CAAC,CAAC,sBAAsB;oBACxB,CAAC,CAAC,wBAAwB;gBAC9B,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,KAAK,GAAG,MAAM,CAAC;oBACvB,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC,CACH;YACD,IAAA,iBAAC,EAAC,eAAQ,EAAE;gBACV,KAAK,EAAE,oBAAoB;gBAC3B,IAAI,EACF,OAAO,CAAC,cAAc,KAAK,gBAAgB;oBACzC,CAAC,CAAC,WAAW;oBACb,CAAC,CAAC,yBAAyB;gBAC/B,OAAO,EAAE,GAAG,EAAE;oBACZ,OAAO,CAAC,cAAc;wBACpB,OAAO,CAAC,cAAc,KAAK,gBAAgB;4BACzC,CAAC,CAAC,QAAQ;4BACV,CAAC,CAAC,gBAAgB,CAAC;oBACvB,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,CAAC;aACF,CAAC;SACH,CAAC;IACJ,CAAC;IAES,UAAU;QAClB,IAAI,CAAC,MAAM,GAAG,SAAS,CAAC;QACxB,IAAI,CAAC,WAAW,GAAG,yBAAQ,CAAC,IAAI,EAAE,CAAC;QACnC,IAAI,CAAC,QAAQ,GAAG;YACd,UAAU,EAAE,IAAI,aAAa,CAAC,CAAC,CAAC;YAChC,gBAAgB,EAAE,IAAI,YAAY,CAAC,CAAC,CAAC;YACrC,gBAAgB,EAAE,IAAI,YAAY,CAAC,CAAC,CAAC;YACrC,iBAAiB,EAAE,IAAI,YAAY,CAAC,CAAC,CAAC;YACtC,iBAAiB,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;SAC1B,CAAC;QACF,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;QAEvB,mBAAG,CAAC,kBAAkB,EAAE,CAAC;IAC3B,CAAC;IAED,6EAA6E;IAC7E,8EAA8E;IAC9E,kEAAkE;IACxD,qBAAqB;QAC7B,OAAO,IAAA,iBAAC,EACN,iBAAU,EACV;YACE,OAAO,EAAE,IAAA,iBAAC,EAAC,eAAM,EAAE,EAAC,IAAI,EAAE,YAAY,EAAE,OAAO,EAAE,IAAI,EAAC,CAAC;SACxD,EACD,IAAI,CAAC,0BAA0B,EAAE,CAClC,CAAC;IACJ,CAAC;IAED,oBAAoB;QAClB,OAAO,IAAI,CAAC,qBAAqB,EAAE,CAAC;IACtC,CAAC;IAED,KAAK,CAAC,QAAQ;QACZ,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,MAAM,EAAE,CAAC;QACnC,MAAM,IAAI,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACjC,IAAI,CAAC,MAAM,GAAG,MAAM,IAAI,CAAC,yBAAyB,CAAC,KAAK,CAAC,CAAC;IAC5D,CAAC;IAED,KAAK,CAAC,QAAQ,CAAC,EAAC,aAAa,EAAE,IAAI,EAAqB;QACtD,MAAM,YAAY,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,CAAC;QAC7C,MAAM,QAAQ,GAAG,aAAa,CAAC,UAAU,EAAE,CAAC;QAC5C,MAAM,cAAc,GAAG,yBAAQ,CAAC,MAAM,CACpC,QAAQ,CAAC,KAAK,EACd,QAAQ,CAAC,GAAG,EACZ,YAAY,CACb,CAAC;QAEF,iEAAiE;QACjE,+CAA+C;QAC/C,MAAM,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,CAAC;IAC9C,CAAC;IAED,MAAM,CAAC,EAAC,GAAG,EAAE,IAAI,EAAE,SAAS,EAAqB;QAC/C,wEAAwE;QACxE,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;QAC3B,MAAM,IAAI,GAAG,IAAI,CAAC,QAAQ,CAAC;QAE3B,IAAI,IAAI,CAAC,UAAU,CAAC,MAAM,KAAK,CAAC,IAAI,MAAM,KAAK,SAAS,EAAE,CAAC;YACzD,IAAA,iCAAkB,EAChB,GAAG,EACH,IAAI,CAAC,SAAS,EAAE,EAChB,CAAC,EACD,IAAI,CAAC,KAAK,EACV,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,EAC1C,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CACzC,CAAC;YACF,OAAO;QACT,CAAC;QAED,IAAA,oBAAU,EAAC,IAAI,CAAC,UAAU,CAAC,MAAM,KAAK,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAAC;QACpE,IAAA,oBAAU,EAAC,IAAI,CAAC,UAAU,CAAC,MAAM,KAAK,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAAC;QACpE,IAAA,oBAAU,EAAC,IAAI,CAAC,UAAU,CAAC,MAAM,KAAK,IAAI,CAAC,iBAAiB,CAAC,MAAM,CAAC,CAAC;QAErE,MAAM,OAAO,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;QAEzC,MAAM,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC;QACnC,MAAM,SAAS,GAAG,IAAI,CAAC,gBAAgB,CAAC;QACxC,MAAM,SAAS,GAAG,IAAI,CAAC,gBAAgB,CAAC;QACxC,MAAM,UAAU,GAAG,IAAI,CAAC,iBAAiB,CAAC;QAE1C,gCAAgC;QAChC,MAAM,EAAC,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,MAAM,EAAC,GAAG,IAAI,CAAC,aAAa,CACrD,MAAM,EACN,IAAI,CAAC,iBAAiB,CACvB,CAAC;QAEF,MAAM,eAAe,GAAG,IAAI,CAAC,SAAS,EAAE,GAAG,UAAU,CAAC;QACtD,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;QAEzB,0DAA0D;QAC1D,MAAM,GAAG,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;QACrD,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;QACvC,MAAM,GAAG,GAAG,CAAC,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,GAAG,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC,GAAG,GAAG,CAAC;QAElE,GAAG,CAAC,SAAS,GAAG,OAAO,GAAG,aAAa,CAAC;QACxC,GAAG,CAAC,WAAW,GAAG,OAAO,GAAG,aAAa,CAAC;QAE1C,MAAM,UAAU,GAAG,CAAC,EAAQ,EAAE,EAAE;YAC9B,OAAO,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC;QAC5C,CAAC,CAAC;QACF,MAAM,UAAU,GAAG,CAAC,KAAa,EAAE,EAAE;YACnC,OAAO,CACL,UAAU;gBACV,eAAe;gBACf,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,KAAK,GAAG,IAAI,CAAC,GAAG,MAAM,CAAC,GAAG,eAAe,CAAC,CACxD,CAAC;QACJ,CAAC,CAAC;QACF,IAAI,KAAK,CAAC;QACV,IAAI,IAAI,IAAI,CAAC,EAAE,CAAC;YACd,KAAK,GAAG,eAAe,GAAG,UAAU,CAAC;QACvC,CAAC;aAAM,IAAI,IAAI,GAAG,CAAC,EAAE,CAAC;YACpB,KAAK,GAAG,UAAU,CAAC;QACrB,CAAC;aAAM,CAAC;YACN,KAAK,GAAG,eAAe,GAAG,CAAC,IAAI,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC,CAAC,GAAG,UAAU,CAAC;QAChE,CAAC;QAED,GAAG,CAAC,SAAS,EAAE,CAAC;QAChB,MAAM,SAAS,GAAG,WAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;QAC9C,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,UAAU,CAAC,SAAS,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;QACtD,IAAI,UAAU,GAAG,KAAK,CAAC;QACvB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YAC3C,MAAM,SAAS,GAAG,WAAI,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;YAC9C,MAAM,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC;YAC7C,MAAM,IAAI,GAAG,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;YACtC,MAAM,IAAI,GAAG,UAAU,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;YACtC,MAAM,KAAK,GAAG,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;YAExC,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,UAAU,CAAC,CAAC;YAC1B,IAAI,IAAI,KAAK,IAAI,EAAE,CAAC;gBAClB,IAAA,oBAAU,EAAC,KAAK,KAAK,IAAI,CAAC,CAAC;gBAC3B,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;YACvB,CAAC;iBAAM,CAAC;gBACN,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;gBACpB,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;gBACpB,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;YACvB,CAAC;YACD,UAAU,GAAG,KAAK,CAAC;QACrB,CAAC;QACD,GAAG,CAAC,MAAM,CAAC,KAAK,EAAE,UAAU,CAAC,CAAC;QAC9B,GAAG,CAAC,MAAM,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;QACzB,GAAG,CAAC,SAAS,EAAE,CAAC;QAChB,GAAG,CAAC,IAAI,EAAE,CAAC;QACX,GAAG,CAAC,MAAM,EAAE,CAAC;QAEb,IAAI,IAAI,GAAG,CAAC,IAAI,IAAI,GAAG,CAAC,EAAE,CAAC;YACzB,4BAA4B;YAC5B,GAAG,CAAC,WAAW,GAAG,OAAO,GAAG,aAAa,CAAC;YAC1C,GAAG,CAAC,SAAS,EAAE,CAAC;YAChB,GAAG,CAAC,WAAW,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;YACxB,GAAG,CAAC,MAAM,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;YACrB,GAAG,CAAC,MAAM,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;YACzB,GAAG,CAAC,SAAS,EAAE,CAAC;YAChB,GAAG,CAAC,MAAM,EAAE,CAAC;YACb,GAAG,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;QACtB,CAAC;QACD,GAAG,CAAC,IAAI,GAAG,uBAAuB,CAAC;QAEnC,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;QACzB,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;YACxB,IAAI,IAAI,GAAG,GAAG,KAAK,CAAC,gBAAgB,CAAC,cAAc,EAAE,EAAE,CAAC;YAExD,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;YACvB,QAAQ,OAAO,CAAC,KAAK,EAAE,CAAC;gBACtB,KAAK,OAAO;oBACV,IAAI,GAAG,GAAG,IAAI,IAAI,IAAI,EAAE,CAAC;oBACzB,MAAM;gBACR,KAAK,OAAO;oBACV,IAAI,GAAG,GAAG,IAAI,UAAU,IAAI,EAAE,CAAC;oBAC/B,MAAM;gBACR,KAAK,MAAM;oBACT,IAAI,GAAG,GAAG,IAAI,UAAU,IAAI,IAAI,CAAC;oBACjC,MAAM;gBACR;oBACE,IAAA,2BAAiB,EAAC,OAAO,CAAC,KAAK,CAAC,CAAC;oBACjC,MAAM;YACV,CAAC;YAED,GAAG,CAAC,SAAS,GAAG,OAAO,GAAG,aAAa,CAAC;YACxC,GAAG,CAAC,WAAW,GAAG,OAAO,GAAG,aAAa,CAAC;YAE1C,MAAM,SAAS,GAAG,UAAU,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;YACvC,MAAM,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,SAAS,CAAC,CAAC;YACtC,MAAM,IAAI,GACR,KAAK,CAAC,KAAK,KAAK,SAAS;gBACvB,CAAC,CAAC,KAAK;gBACP,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,QAAQ,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC;YAClD,MAAM,CAAC,GACL,UAAU;gBACV,eAAe;gBACf,IAAI,CAAC,KAAK,CACR,CAAC,CAAC,KAAK,CAAC,gBAAgB,GAAG,IAAI,CAAC,GAAG,MAAM,CAAC,GAAG,eAAe,CAC7D,CAAC;YAEJ,kBAAkB;YAClB,GAAG,CAAC,SAAS,EAAE,CAAC;YAChB,GAAG,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;YACtB,GAAG,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;YACpB,GAAG,CAAC,SAAS,GAAG,CAAC,CAAC;YAClB,GAAG,CAAC,MAAM,EAAE,CAAC;YACb,GAAG,CAAC,SAAS,GAAG,CAAC,CAAC;YAElB,6CAA6C;YAC7C,IAAI,SAAS,IAAI,CAAC,CAAC,EAAE,CAAC;gBACpB,GAAG,CAAC,SAAS,EAAE,CAAC;gBAChB,GAAG,CAAC,GAAG,CACL,MAAM,EACN,CAAC,EACD,CAAC,CAAC,MAAM,EACR,CAAC,CAAC,gBAAgB,EAClB,CAAC,GAAG,IAAI,CAAC,EAAE,CAAC,cAAc,CAC3B,CAAC;gBACF,GAAG,CAAC,IAAI,EAAE,CAAC;gBACX,GAAG,CAAC,MAAM,EAAE,CAAC;YACf,CAAC;YAED,oBAAoB;YACpB,IAAA,oCAAqB,EAAC,GAAG,EAAE,IAAI,CAAC,QAAQ,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;QACxD,CAAC;QAED,4CAA4C;QAC5C,GAAG,CAAC,SAAS,GAAG,0BAA0B,CAAC;QAC3C,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,EAAE,EAAE,CAAC,CAAC;QAC3B,GAAG,CAAC,SAAS,GAAG,MAAM,CAAC;QACvB,GAAG,CAAC,SAAS,GAAG,MAAM,CAAC;QACvB,GAAG,CAAC,YAAY,GAAG,YAAY,CAAC;QAChC,GAAG,CAAC,QAAQ,CAAC,GAAG,MAAM,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC;QAEjC,mDAAmD;QACnD,CAAC;YACC,MAAM,YAAY,GAAG,QAAQ,CAAC;YAC9B,gBAAgB;YAChB,IAAI,YAAY,GAAG,KAAK,EAAE,CAAC;gBACzB,GAAG,CAAC,SAAS,GAAG,WAAW,CAAC;gBAC5B,GAAG,CAAC,QAAQ,CAAC,YAAY,EAAE,CAAC,EAAE,KAAK,GAAG,YAAY,EAAE,IAAI,CAAC,SAAS,EAAE,CAAC,CAAC;YACxE,CAAC;QACH,CAAC;QAED,uEAAuE;QACvE,mDAAmD;QACnD,IAAA,iCAAkB,EAChB,GAAG,EACH,IAAI,CAAC,SAAS,EAAE,EAChB,CAAC,EACD,IAAI,CAAC,KAAK,EACV,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,EAC1C,SAAS,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CACzC,CAAC;IACJ,CAAC;IAED,WAAW,CAAC,EAAC,CAAC,EAAE,CAAC,EAAE,SAAS,EAAkB;QAC5C,MAAM,IAAI,GAAG,IAAI,CAAC,QAAQ,CAAC;QAC3B,IAAI,IAAI,KAAK,SAAS;YAAE,OAAO;QAC/B,IAAI,CAAC,QAAQ,GAAG,EAAC,CAAC,EAAE,CAAC,EAAC,CAAC;QACvB,MAAM,IAAI,GAAG,SAAS,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;QAErC,MAAM,CAAC,IAAI,EAAE,KAAK,CAAC,GAAG,IAAA,6BAAa,EAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC;QAEpE,IAAI,IAAI,KAAK,CAAC,CAAC,EAAE,CAAC;YAChB,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;YACvB,OAAO;QACT,CAAC;QAED,MAAM,EAAE,GAAG,WAAI,CAAC,OAAO,CAAC,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC,CAAC;QAC/C,MAAM,KAAK,GACT,KAAK,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,WAAI,CAAC,OAAO,CAAC,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC,CAAC;QAClE,MAAM,gBAAgB,GAAG,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;QACtD,IAAI,CAAC,KAAK,GAAG;YACX,EAAE;YACF,KAAK;YACL,gBAAgB;SACjB,CAAC;IACJ,CAAC;IAED,UAAU;QACR,IAAI,CAAC,KAAK,GAAG,SAAS,CAAC;IACzB,CAAC;IAED,KAAK,CAAC,SAAS;QACb,MAAM,IAAI,CAAC,KAAK,CAAC,YAAY,EAAE,CAAC;IAClC,CAAC;IAED,0DAA0D;IAClD,aAAa,CACnB,MAAqB,EACrB,UAA4B;QAO5B,MAAM,OAAO,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;QAEzC,IAAI,IAAI,GAAG,MAAM,CAAC,eAAe,CAAC;QAClC,IAAI,IAAI,GAAG,MAAM,CAAC,eAAe,CAAC;QAElC,IAAI,OAAO,CAAC,MAAM,KAAK,UAAU,EAAE,CAAC;YAClC,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,UAAU,CAAC;QAC5B,CAAC;QAED,IAAI,OAAO,CAAC,QAAQ,KAAK,MAAM,EAAE,CAAC;YAChC,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;YACzB,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;QAC3B,CAAC;QAED,IAAI,OAAO,CAAC,gBAAgB,KAAK,SAAS,EAAE,CAAC;YAC3C,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,gBAAgB,EAAE,IAAI,CAAC,CAAC;QAClD,CAAC;QAED,IAAI,OAAO,CAAC,gBAAgB,KAAK,SAAS,EAAE,CAAC;YAC3C,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,gBAAgB,EAAE,IAAI,CAAC,CAAC;QAClD,CAAC;QAED,IAAI,OAAO,CAAC,cAAc,KAAK,gBAAgB,EAAE,CAAC;YAChD,IAAI,OAAO,CAAC,QAAQ,KAAK,KAAK,EAAE,CAAC;gBAC/B,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;gBAC3C,IAAI,GAAG,IAAI,CAAC,GAAG,CAAC,SAAS,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YAC7C,CAAC;iBAAM,CAAC;gBACN,IAAI,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC;gBACvB,IAAI,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC;YACzB,CAAC;QACH,CAAC;QAED,MAAM,MAAM,GAAG,WAAW,CAAC,GAAG,EAAE,CAAC;QACjC,CAAC,IAAI,EAAE,IAAI,CAAC,GAAG,MAAM,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC,CAAC;QAEnD,IAAI,MAAc,CAAC;QAEnB,IAAI,OAAO,CAAC,QAAQ,KAAK,QAAQ,EAAE,CAAC;YAClC,MAAM,GAAG,WAAW,CAAC;QACvB,CAAC;aAAM,CAAC;YACN,IAAI,GAAG,GAAG,IAAI,CAAC;YACf,IAAI,GAAG,GAAG,IAAI,CAAC;YACf,IAAI,OAAO,CAAC,QAAQ,KAAK,KAAK,EAAE,CAAC;gBAC/B,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;gBACpB,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YACtB,CAAC;YACD,IAAI,GAAG,GAAG,CAAC,EAAE,CAAC;gBACZ,MAAM,GAAG,OAAO,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC;YAC9B,CAAC;iBAAM,CAAC;gBACN,MAAM,GAAG,OAAO,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC;YAC9B,CAAC;QACH,CAAC;QAED,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC;QACvB,QAAQ,OAAO,CAAC,KAAK,EAAE,CAAC;YACtB,KAAK,OAAO;gBACV,MAAM,IAAI,IAAI,IAAI,EAAE,CAAC;gBACrB,MAAM;YACR,KAAK,OAAO;gBACV,MAAM,IAAI,SAAS,IAAI,EAAE,CAAC;gBAC1B,MAAM;YACR,KAAK,MAAM;gBACT,MAAM,IAAI,SAAS,IAAI,IAAI,CAAC;gBAC5B,MAAM;YACR;gBACE,IAAA,2BAAiB,EAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QACrC,CAAC;QAED,IAAI,OAAO,CAAC,QAAQ,KAAK,KAAK,EAAE,CAAC;YAC/B,MAAM,GAAG,OAAO,MAAM,GAAG,CAAC;QAC5B,CAAC;QAED,OAAO;YACL,IAAI;YACJ,IAAI;YACJ,MAAM;YACN,MAAM,EAAE,IAAI,GAAG,IAAI;SACpB,CAAC;IACJ,CAAC;IAED,qDAAqD;IAC7C,kBAAkB;QACxB,MAAM,OAAO,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;QAEzC,IAAI,SAAS,CAAC;QACd,QAAQ,OAAO,CAAC,KAAK,EAAE,CAAC;YACtB,KAAK,OAAO;gBACV,SAAS,GAAG,OAAO,CAAC;gBACpB,MAAM;YACR,KAAK,OAAO;gBACV,SAAS,GAAG,kDAAkD,CAAC;gBAC/D,MAAM;YACR,KAAK,MAAM;gBACT,SAAS;oBACP,yGAAyG,CAAC;gBAC5G,MAAM;YACR;gBACE,IAAA,2BAAiB,EAAC,OAAO,CAAC,KAAK,CAAC,CAAC;QACrC,CAAC;QAED,IAAI,OAAO,CAAC,QAAQ,KAAK,KAAK,EAAE,CAAC;YAC/B,OAAO,aAAa,SAAS,OAAO,CAAC;QACvC,CAAC;aAAM,CAAC;YACN,OAAO,SAAS,CAAC;QACnB,CAAC;IACH,CAAC;IAEO,YAAY;QAClB,OAAO,WAAW,IAAI,CAAC,SAAS,EAAE,CAAC;IACrC,CAAC;IAEO,KAAK,CAAC,gBAAgB,CAAC,cAAwB;QACrD,IAAI,cAAc,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC;YACjD,OAAO,CAAC,iDAAiD;QAC3D,CAAC;QAED,MAAM,WAAW,GAAG,cAAc,CAAC,SAAS,EAAE,CAAC;QAC/C,IAAI,CAAC,cAAc,CAAC,WAAW,CAAC,WAAW,CAAC,EAAE,CAAC;YAC7C,MAAM,IAAI,KAAK,CACb,uBAAuB,WAAW,CAAC,QAAQ,EAAE,IAAI,cAAc,CAAC,QAAQ,EAAE,EAAE,CAC7E,CAAC;QACJ,CAAC;QAED,IAAI,IAAI,CAAC,MAAM,KAAK,SAAS,EAAE,CAAC;YAC9B,IAAI,CAAC,MAAM,GAAG,MAAM,IAAI,CAAC,yBAAyB,CAAC,IAAI,CAAC,CAAC;QAC3D,CAAC;QAED,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC;;;;;;aAMhC,IAAI,CAAC,YAAY,EAAE;UACtB,WAAW,CAAC,KAAK;UACjB,WAAW,CAAC,GAAG;UACf,WAAW,CAAC,UAAU;;KAE3B,CAAC,CAAC;QAEH,MAAM,EAAE,GAAG,QAAQ,CAAC,IAAI,CAAC;YACvB,EAAE,EAAE,mBAAI;YACR,eAAe,EAAE,kBAAG;YACpB,eAAe,EAAE,kBAAG;YACpB,gBAAgB,EAAE,kBAAG;SACtB,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,QAAQ,CAAC,OAAO,EAAE,CAAC;QACnC,MAAM,IAAI,GAAgB;YACxB,UAAU,EAAE,IAAI,aAAa,CAAC,OAAO,CAAC;YACtC,gBAAgB,EAAE,IAAI,YAAY,CAAC,OAAO,CAAC;YAC3C,gBAAgB,EAAE,IAAI,YAAY,CAAC,OAAO,CAAC;YAC3C,iBAAiB,EAAE,IAAI,YAAY,CAAC,OAAO,CAAC;YAC5C,iBAAiB,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC;SAC1B,CAAC;QAEF,IAAI,GAAG,GAAG,CAAC,CAAC;QACZ,IAAI,GAAG,GAAG,CAAC,CAAC;QACZ,KAAK,IAAI,GAAG,GAAG,CAAC,EAAE,EAAE,CAAC,KAAK,EAAE,EAAE,EAAE,CAAC,IAAI,EAAE,EAAE,GAAG,EAAE,EAAE,CAAC;YAC/C,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,GAAG,WAAI,CAAC,OAAO,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YAC3C,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,eAAe,CAAC;YAChD,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,eAAe,CAAC;YAChD,IAAI,CAAC,iBAAiB,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC,gBAAgB,CAAC;YAClD,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,EAAE,CAAC,eAAe,CAAC,CAAC;YACxC,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,EAAE,EAAE,CAAC,eAAe,CAAC,CAAC;QAC1C,CAAC;QAED,IAAI,CAAC,iBAAiB,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;QAEpC,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;QAC/B,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;QAErB,mBAAG,CAAC,oBAAoB,EAAE,CAAC;IAC7B,CAAC;IAEO,KAAK,CAAC,yBAAyB,CACrC,SAAkB;QAElB,MAAM,SAAS,GAAG,SAAS,CAAC,CAAC,CAAC,cAAc,IAAI,CAAC,YAAY,EAAE,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC;QACxE,MAAM,iBAAiB,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC;QAC9C,SAAS;6BACY,IAAI,CAAC,YAAY,EAAE;;;;YAIpC,IAAI,CAAC,kBAAkB,EAAE;gBACrB,IAAI,CAAC,YAAY,EAAE;;;;;aAKtB,IAAI,CAAC,YAAY,EAAE;;;KAG3B,CAAC,CAAC;QAEH,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,KAAK,IAAI,EAAE;YAC1B,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,wBAAwB,IAAI,CAAC,YAAY,EAAE,EAAE,CAAC,CAAC;QACtE,CAAC,CAAC,CAAC;QAEH,MAAM,EAAC,eAAe,EAAE,eAAe,EAAC,GAAG,iBAAiB,CAAC,QAAQ,CAAC;YACpE,eAAe,EAAE,kBAAG;YACpB,eAAe,EAAE,kBAAG;SACrB,CAAC,CAAC;QAEH,OAAO;YACL,eAAe;YACf,eAAe;SAChB,CAAC;IACJ,CAAC;IAED,IAAI,IAAI;QACN,OAAO,IAAI,CAAC,iBAAiB,EAAE,CAAC,IAAI,IAAI,EAAE,CAAC;IAC7C,CAAC;IAED,IAAc,MAAM;QAClB,OAAO,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;IAC3B,CAAC;CACF;AAvtBD,4CAutBC","sourcesContent":["// Copyright (C) 2023 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {searchSegment} from '../../base/binary_search';\nimport {assertTrue, assertUnreachable} from '../../base/logging';\nimport {Time, time} from '../../base/time';\nimport {uuidv4Sql} from '../../base/uuid';\nimport {drawTrackHoverTooltip} from '../../base/canvas_utils';\nimport {raf} from '../../core/raf_scheduler';\nimport {CacheKey} from './timeline_cache';\nimport {Track, TrackMouseEvent, TrackRenderContext} from '../../public/track';\nimport {Button} from '../../widgets/button';\nimport {MenuDivider, MenuItem, PopupMenu2} from '../../widgets/menu';\nimport {LONG, NUM} from '../../trace_processor/query_result';\nimport {checkerboardExcept} from '../checkerboard';\nimport {AsyncDisposableStack} from '../../base/disposable_stack';\nimport {Trace} from '../../public/trace';\n\nfunction roundAway(n: number): number {\n  const exp = Math.ceil(Math.log10(Math.max(Math.abs(n), 1)));\n  const pow10 = Math.pow(10, exp);\n  return Math.sign(n) * (Math.ceil(Math.abs(n) / (pow10 / 20)) * (pow10 / 20));\n}\n\nfunction toLabel(n: number): string {\n  if (n === 0) {\n    return '0';\n  }\n  const units: [number, string][] = [\n    [0.000000001, 'n'],\n    [0.000001, 'u'],\n    [0.001, 'm'],\n    [1, ''],\n    [1000, 'K'],\n    [1000 * 1000, 'M'],\n    [1000 * 1000 * 1000, 'G'],\n    [1000 * 1000 * 1000 * 1000, 'T'],\n  ];\n  let largestMultiplier;\n  let largestUnit;\n  [largestMultiplier, largestUnit] = units[0];\n  const absN = Math.abs(n);\n  for (const [multiplier, unit] of units) {\n    if (multiplier > absN) {\n      break;\n    }\n    [largestMultiplier, largestUnit] = [multiplier, unit];\n  }\n  return `${Math.round(n / largestMultiplier)}${largestUnit}`;\n}\n\nclass RangeSharer {\n  static singleton?: RangeSharer;\n\n  static get(): RangeSharer {\n    if (RangeSharer.singleton === undefined) {\n      RangeSharer.singleton = new RangeSharer();\n    }\n    return RangeSharer.singleton;\n  }\n\n  private tagToRange: Map<string, [number, number]>;\n  private keyToEnabled: Map<string, boolean>;\n\n  constructor() {\n    this.tagToRange = new Map();\n    this.keyToEnabled = new Map();\n  }\n\n  isEnabled(key: string): boolean {\n    const value = this.keyToEnabled.get(key);\n    if (value === undefined) {\n      return true;\n    }\n    return value;\n  }\n\n  setEnabled(key: string, enabled: boolean): void {\n    this.keyToEnabled.set(key, enabled);\n  }\n\n  share(\n    options: CounterOptions,\n    [min, max]: [number, number],\n  ): [number, number] {\n    const key = options.yRangeSharingKey;\n    if (key === undefined || !this.isEnabled(key)) {\n      return [min, max];\n    }\n\n    const tag = `${options.yRangeSharingKey}-${options.yMode}-${\n      options.yDisplay\n    }-${!!options.enlarge}`;\n    const cachedRange = this.tagToRange.get(tag);\n    if (cachedRange === undefined) {\n      this.tagToRange.set(tag, [min, max]);\n      return [min, max];\n    }\n\n    cachedRange[0] = Math.min(min, cachedRange[0]);\n    cachedRange[1] = Math.max(max, cachedRange[1]);\n\n    return [cachedRange[0], cachedRange[1]];\n  }\n}\n\ninterface CounterData {\n  timestamps: BigInt64Array;\n  minDisplayValues: Float64Array;\n  maxDisplayValues: Float64Array;\n  lastDisplayValues: Float64Array;\n  displayValueRange: [number, number];\n}\n\n// 0.5 Makes the horizontal lines sharp.\nconst MARGIN_TOP = 3.5;\n\ninterface CounterLimits {\n  maxDisplayValue: number;\n  minDisplayValue: number;\n}\n\ninterface CounterTooltipState {\n  lastDisplayValue: number;\n  ts: time;\n  tsEnd?: time;\n}\n\nexport interface CounterOptions {\n  // Mode for computing the y value. Options are:\n  // value = v[t] directly the value of the counter at time t\n  // delta = v[t] - v[t-1] delta between value and previous value\n  // rate = (v[t] - v[t-1]) / dt as delta but normalized for time\n  yMode: 'value' | 'delta' | 'rate';\n\n  // Whether Y scale should cover all of the possible values (and therefore, be\n  // static) or whether it should be dynamic and cover only the visible values.\n  yRange: 'all' | 'viewport';\n\n  // Whether the Y scale should:\n  // zero = y-axis scale should cover the origin (zero)\n  // minmax = y-axis scale should cover just the range of yRange\n  // log = as minmax but also use a log scale\n  yDisplay: 'zero' | 'minmax' | 'log';\n\n  // Whether the range boundaries should be strict and use the precise min/max\n  // values or whether they should be rounded down/up to the nearest human\n  // readable value.\n  yRangeRounding: 'strict' | 'human_readable';\n\n  // Allows *extending* the range of the y-axis counter increasing\n  // the maximum (via yOverrideMaximum) or decreasing the minimum\n  // (via yOverrideMinimum). This is useful for percentage counters\n  // where the range (0-100) is known statically upfront and even if\n  // the trace only includes smaller values.\n  yOverrideMaximum?: number;\n  yOverrideMinimum?: number;\n\n  // If set all counters with the same key share a range.\n  yRangeSharingKey?: string;\n\n  // Show the chart as 4x the height.\n  enlarge?: boolean;\n\n  // unit for the counter. This is displayed in the tooltip and\n  // legend.\n  unit?: string;\n}\n\nexport abstract class BaseCounterTrack implements Track {\n  protected trackUuid = uuidv4Sql();\n\n  // This is the over-skirted cached bounds:\n  private countersKey: CacheKey = CacheKey.zero();\n\n  private counters: CounterData = {\n    timestamps: new BigInt64Array(0),\n    minDisplayValues: new Float64Array(0),\n    maxDisplayValues: new Float64Array(0),\n    lastDisplayValues: new Float64Array(0),\n    displayValueRange: [0, 0],\n  };\n\n  private limits?: CounterLimits;\n\n  private mousePos = {x: 0, y: 0};\n  private hover?: CounterTooltipState;\n  private options?: CounterOptions;\n\n  private readonly trash: AsyncDisposableStack;\n\n  private getCounterOptions(): CounterOptions {\n    if (this.options === undefined) {\n      const options = this.getDefaultCounterOptions();\n      for (const [key, value] of Object.entries(this.defaultOptions)) {\n        if (value !== undefined) {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          (options as any)[key] = value;\n        }\n      }\n      this.options = options;\n    }\n    return this.options;\n  }\n\n  // Extension points.\n\n  // onInit hook lets you do asynchronous set up e.g. creating a table\n  // etc. We guarantee that this will be resolved before doing any\n  // queries using the result of getSqlSource(). All persistent\n  // state in trace_processor should be cleaned up when dispose is\n  // called on the returned hook.\n  async onInit(): Promise<AsyncDisposable | void> {}\n\n  // This should be an SQL expression returning the columns `ts` and `value`.\n  abstract getSqlSource(): string;\n\n  protected getDefaultCounterOptions(): CounterOptions {\n    return {\n      yRange: 'all',\n      yRangeRounding: 'human_readable',\n      yMode: 'value',\n      yDisplay: 'zero',\n    };\n  }\n\n  constructor(\n    protected readonly trace: Trace,\n    protected readonly uri: string,\n    protected readonly defaultOptions: Partial<CounterOptions> = {},\n  ) {\n    this.trash = new AsyncDisposableStack();\n  }\n\n  getHeight() {\n    const height = 40;\n    return this.getCounterOptions().enlarge ? height * 4 : height;\n  }\n\n  // A method to render menu items for switching the defualt\n  // rendering options.  Useful if a subclass wants to incorporate it\n  // as a submenu.\n  protected getCounterContextMenuItems(): m.Children {\n    const options = this.getCounterOptions();\n\n    return [\n      m(\n        MenuItem,\n        {\n          label: `Display (currently: ${options.yDisplay})`,\n        },\n\n        m(MenuItem, {\n          label: 'Zero-based',\n          icon:\n            options.yDisplay === 'zero'\n              ? 'radio_button_checked'\n              : 'radio_button_unchecked',\n          onclick: () => {\n            options.yDisplay = 'zero';\n            this.invalidate();\n          },\n        }),\n\n        m(MenuItem, {\n          label: 'Min/Max',\n          icon:\n            options.yDisplay === 'minmax'\n              ? 'radio_button_checked'\n              : 'radio_button_unchecked',\n          onclick: () => {\n            options.yDisplay = 'minmax';\n            this.invalidate();\n          },\n        }),\n\n        m(MenuItem, {\n          label: 'Log',\n          icon:\n            options.yDisplay === 'log'\n              ? 'radio_button_checked'\n              : 'radio_button_unchecked',\n          onclick: () => {\n            options.yDisplay = 'log';\n            this.invalidate();\n          },\n        }),\n      ),\n\n      m(MenuItem, {\n        label: 'Zoom on scroll',\n        icon:\n          options.yRange === 'viewport'\n            ? 'check_box'\n            : 'check_box_outline_blank',\n        onclick: () => {\n          options.yRange = options.yRange === 'viewport' ? 'all' : 'viewport';\n          this.invalidate();\n        },\n      }),\n\n      m(MenuItem, {\n        label: `Enlarge`,\n        icon: options.enlarge ? 'check_box' : 'check_box_outline_blank',\n        onclick: () => {\n          options.enlarge = !options.enlarge;\n          this.invalidate();\n        },\n      }),\n\n      options.yRangeSharingKey &&\n        m(MenuItem, {\n          label: `Share y-axis scale (group: ${options.yRangeSharingKey})`,\n          icon: RangeSharer.get().isEnabled(options.yRangeSharingKey)\n            ? 'check_box'\n            : 'check_box_outline_blank',\n          onclick: () => {\n            const key = options.yRangeSharingKey;\n            if (key === undefined) {\n              return;\n            }\n            const sharer = RangeSharer.get();\n            sharer.setEnabled(key, !sharer.isEnabled(key));\n            this.invalidate();\n          },\n        }),\n\n      m(MenuDivider),\n      m(\n        MenuItem,\n        {\n          label: `Mode (currently: ${options.yMode})`,\n        },\n\n        m(MenuItem, {\n          label: 'Value',\n          icon:\n            options.yMode === 'value'\n              ? 'radio_button_checked'\n              : 'radio_button_unchecked',\n          onclick: () => {\n            options.yMode = 'value';\n            this.invalidate();\n          },\n        }),\n\n        m(MenuItem, {\n          label: 'Delta',\n          icon:\n            options.yMode === 'delta'\n              ? 'radio_button_checked'\n              : 'radio_button_unchecked',\n          onclick: () => {\n            options.yMode = 'delta';\n            this.invalidate();\n          },\n        }),\n\n        m(MenuItem, {\n          label: 'Rate',\n          icon:\n            options.yMode === 'rate'\n              ? 'radio_button_checked'\n              : 'radio_button_unchecked',\n          onclick: () => {\n            options.yMode = 'rate';\n            this.invalidate();\n          },\n        }),\n      ),\n      m(MenuItem, {\n        label: 'Round y-axis scale',\n        icon:\n          options.yRangeRounding === 'human_readable'\n            ? 'check_box'\n            : 'check_box_outline_blank',\n        onclick: () => {\n          options.yRangeRounding =\n            options.yRangeRounding === 'human_readable'\n              ? 'strict'\n              : 'human_readable';\n          this.invalidate();\n        },\n      }),\n    ];\n  }\n\n  protected invalidate() {\n    this.limits = undefined;\n    this.countersKey = CacheKey.zero();\n    this.counters = {\n      timestamps: new BigInt64Array(0),\n      minDisplayValues: new Float64Array(0),\n      maxDisplayValues: new Float64Array(0),\n      lastDisplayValues: new Float64Array(0),\n      displayValueRange: [0, 0],\n    };\n    this.hover = undefined;\n\n    raf.scheduleFullRedraw();\n  }\n\n  // A method to render a context menu corresponding to switching the rendering\n  // modes. By default, getTrackShellButtons renders it, but a subclass can call\n  // it manually, if they want to customise rendering track buttons.\n  protected getCounterContextMenu(): m.Child {\n    return m(\n      PopupMenu2,\n      {\n        trigger: m(Button, {icon: 'show_chart', compact: true}),\n      },\n      this.getCounterContextMenuItems(),\n    );\n  }\n\n  getTrackShellButtons(): m.Children {\n    return this.getCounterContextMenu();\n  }\n\n  async onCreate(): Promise<void> {\n    const result = await this.onInit();\n    result && this.trash.use(result);\n    this.limits = await this.createTableAndFetchLimits(false);\n  }\n\n  async onUpdate({visibleWindow, size}: TrackRenderContext): Promise<void> {\n    const windowSizePx = Math.max(1, size.width);\n    const timespan = visibleWindow.toTimeSpan();\n    const rawCountersKey = CacheKey.create(\n      timespan.start,\n      timespan.end,\n      windowSizePx,\n    );\n\n    // If the visible time range is outside the cached area, requests\n    // asynchronously new data from the SQL engine.\n    await this.maybeRequestData(rawCountersKey);\n  }\n\n  render({ctx, size, timescale}: TrackRenderContext): void {\n    // In any case, draw whatever we have (which might be stale/incomplete).\n    const limits = this.limits;\n    const data = this.counters;\n\n    if (data.timestamps.length === 0 || limits === undefined) {\n      checkerboardExcept(\n        ctx,\n        this.getHeight(),\n        0,\n        size.width,\n        timescale.timeToPx(this.countersKey.start),\n        timescale.timeToPx(this.countersKey.end),\n      );\n      return;\n    }\n\n    assertTrue(data.timestamps.length === data.minDisplayValues.length);\n    assertTrue(data.timestamps.length === data.maxDisplayValues.length);\n    assertTrue(data.timestamps.length === data.lastDisplayValues.length);\n\n    const options = this.getCounterOptions();\n\n    const timestamps = data.timestamps;\n    const minValues = data.minDisplayValues;\n    const maxValues = data.maxDisplayValues;\n    const lastValues = data.lastDisplayValues;\n\n    // Choose a range for the y-axis\n    const {yRange, yMin, yMax, yLabel} = this.computeYRange(\n      limits,\n      data.displayValueRange,\n    );\n\n    const effectiveHeight = this.getHeight() - MARGIN_TOP;\n    const endPx = size.width;\n\n    // Use hue to differentiate the scale of the counter value\n    const exp = Math.ceil(Math.log10(Math.max(yMax, 1)));\n    const expCapped = Math.min(exp - 3, 9);\n    const hue = (180 - Math.floor(expCapped * (180 / 6)) + 360) % 360;\n\n    ctx.fillStyle = `hsl(${hue}, 45%, 75%)`;\n    ctx.strokeStyle = `hsl(${hue}, 45%, 45%)`;\n\n    const calculateX = (ts: time) => {\n      return Math.floor(timescale.timeToPx(ts));\n    };\n    const calculateY = (value: number) => {\n      return (\n        MARGIN_TOP +\n        effectiveHeight -\n        Math.round(((value - yMin) / yRange) * effectiveHeight)\n      );\n    };\n    let zeroY;\n    if (yMin >= 0) {\n      zeroY = effectiveHeight + MARGIN_TOP;\n    } else if (yMax < 0) {\n      zeroY = MARGIN_TOP;\n    } else {\n      zeroY = effectiveHeight * (yMax / (yMax - yMin)) + MARGIN_TOP;\n    }\n\n    ctx.beginPath();\n    const timestamp = Time.fromRaw(timestamps[0]);\n    ctx.moveTo(Math.max(0, calculateX(timestamp)), zeroY);\n    let lastDrawnY = zeroY;\n    for (let i = 0; i < timestamps.length; i++) {\n      const timestamp = Time.fromRaw(timestamps[i]);\n      const x = Math.max(0, calculateX(timestamp));\n      const minY = calculateY(minValues[i]);\n      const maxY = calculateY(maxValues[i]);\n      const lastY = calculateY(lastValues[i]);\n\n      ctx.lineTo(x, lastDrawnY);\n      if (minY === maxY) {\n        assertTrue(lastY === minY);\n        ctx.lineTo(x, lastY);\n      } else {\n        ctx.lineTo(x, minY);\n        ctx.lineTo(x, maxY);\n        ctx.lineTo(x, lastY);\n      }\n      lastDrawnY = lastY;\n    }\n    ctx.lineTo(endPx, lastDrawnY);\n    ctx.lineTo(endPx, zeroY);\n    ctx.closePath();\n    ctx.fill();\n    ctx.stroke();\n\n    if (yMin < 0 && yMax > 0) {\n      // Draw the Y=0 dashed line.\n      ctx.strokeStyle = `hsl(${hue}, 10%, 71%)`;\n      ctx.beginPath();\n      ctx.setLineDash([2, 4]);\n      ctx.moveTo(0, zeroY);\n      ctx.lineTo(endPx, zeroY);\n      ctx.closePath();\n      ctx.stroke();\n      ctx.setLineDash([]);\n    }\n    ctx.font = '10px Roboto Condensed';\n\n    const hover = this.hover;\n    if (hover !== undefined) {\n      let text = `${hover.lastDisplayValue.toLocaleString()}`;\n\n      const unit = this.unit;\n      switch (options.yMode) {\n        case 'value':\n          text = `${text} ${unit}`;\n          break;\n        case 'delta':\n          text = `${text} \\u0394${unit}`;\n          break;\n        case 'rate':\n          text = `${text} \\u0394${unit}/s`;\n          break;\n        default:\n          assertUnreachable(options.yMode);\n          break;\n      }\n\n      ctx.fillStyle = `hsl(${hue}, 45%, 75%)`;\n      ctx.strokeStyle = `hsl(${hue}, 45%, 45%)`;\n\n      const rawXStart = calculateX(hover.ts);\n      const xStart = Math.max(0, rawXStart);\n      const xEnd =\n        hover.tsEnd === undefined\n          ? endPx\n          : Math.floor(timescale.timeToPx(hover.tsEnd));\n      const y =\n        MARGIN_TOP +\n        effectiveHeight -\n        Math.round(\n          ((hover.lastDisplayValue - yMin) / yRange) * effectiveHeight,\n        );\n\n      // Highlight line.\n      ctx.beginPath();\n      ctx.moveTo(xStart, y);\n      ctx.lineTo(xEnd, y);\n      ctx.lineWidth = 3;\n      ctx.stroke();\n      ctx.lineWidth = 1;\n\n      // Draw change marker if it would be visible.\n      if (rawXStart >= -6) {\n        ctx.beginPath();\n        ctx.arc(\n          xStart,\n          y,\n          3 /* r*/,\n          0 /* start angle*/,\n          2 * Math.PI /* end angle*/,\n        );\n        ctx.fill();\n        ctx.stroke();\n      }\n\n      // Draw the tooltip.\n      drawTrackHoverTooltip(ctx, this.mousePos, size, text);\n    }\n\n    // Write the Y scale on the top left corner.\n    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';\n    ctx.fillRect(0, 0, 42, 13);\n    ctx.fillStyle = '#666';\n    ctx.textAlign = 'left';\n    ctx.textBaseline = 'alphabetic';\n    ctx.fillText(`${yLabel}`, 5, 11);\n\n    // TODO(hjd): Refactor this into checkerboardExcept\n    {\n      const counterEndPx = Infinity;\n      // Grey out RHS.\n      if (counterEndPx < endPx) {\n        ctx.fillStyle = '#0000001f';\n        ctx.fillRect(counterEndPx, 0, endPx - counterEndPx, this.getHeight());\n      }\n    }\n\n    // If the cached trace slices don't fully cover the visible time range,\n    // show a gray rectangle with a \"Loading...\" label.\n    checkerboardExcept(\n      ctx,\n      this.getHeight(),\n      0,\n      size.width,\n      timescale.timeToPx(this.countersKey.start),\n      timescale.timeToPx(this.countersKey.end),\n    );\n  }\n\n  onMouseMove({x, y, timescale}: TrackMouseEvent) {\n    const data = this.counters;\n    if (data === undefined) return;\n    this.mousePos = {x, y};\n    const time = timescale.pxToHpTime(x);\n\n    const [left, right] = searchSegment(data.timestamps, time.toTime());\n\n    if (left === -1) {\n      this.hover = undefined;\n      return;\n    }\n\n    const ts = Time.fromRaw(data.timestamps[left]);\n    const tsEnd =\n      right === -1 ? undefined : Time.fromRaw(data.timestamps[right]);\n    const lastDisplayValue = data.lastDisplayValues[left];\n    this.hover = {\n      ts,\n      tsEnd,\n      lastDisplayValue,\n    };\n  }\n\n  onMouseOut() {\n    this.hover = undefined;\n  }\n\n  async onDestroy(): Promise<void> {\n    await this.trash.asyncDispose();\n  }\n\n  // Compute the range of values to display and range label.\n  private computeYRange(\n    limits: CounterLimits,\n    dataLimits: [number, number],\n  ): {\n    yMin: number;\n    yMax: number;\n    yRange: number;\n    yLabel: string;\n  } {\n    const options = this.getCounterOptions();\n\n    let yMin = limits.minDisplayValue;\n    let yMax = limits.maxDisplayValue;\n\n    if (options.yRange === 'viewport') {\n      [yMin, yMax] = dataLimits;\n    }\n\n    if (options.yDisplay === 'zero') {\n      yMin = Math.min(0, yMin);\n      yMax = Math.max(0, yMax);\n    }\n\n    if (options.yOverrideMaximum !== undefined) {\n      yMax = Math.max(options.yOverrideMaximum, yMax);\n    }\n\n    if (options.yOverrideMinimum !== undefined) {\n      yMin = Math.min(options.yOverrideMinimum, yMin);\n    }\n\n    if (options.yRangeRounding === 'human_readable') {\n      if (options.yDisplay === 'log') {\n        yMax = Math.log(roundAway(Math.exp(yMax)));\n        yMin = Math.log(roundAway(Math.exp(yMin)));\n      } else {\n        yMax = roundAway(yMax);\n        yMin = roundAway(yMin);\n      }\n    }\n\n    const sharer = RangeSharer.get();\n    [yMin, yMax] = sharer.share(options, [yMin, yMax]);\n\n    let yLabel: string;\n\n    if (options.yDisplay === 'minmax') {\n      yLabel = 'min - max';\n    } else {\n      let max = yMax;\n      let min = yMin;\n      if (options.yDisplay === 'log') {\n        max = Math.exp(max);\n        min = Math.exp(min);\n      }\n      if (max < 0) {\n        yLabel = toLabel(min - max);\n      } else {\n        yLabel = toLabel(max - min);\n      }\n    }\n\n    const unit = this.unit;\n    switch (options.yMode) {\n      case 'value':\n        yLabel += ` ${unit}`;\n        break;\n      case 'delta':\n        yLabel += `\\u0394${unit}`;\n        break;\n      case 'rate':\n        yLabel += `\\u0394${unit}/s`;\n        break;\n      default:\n        assertUnreachable(options.yMode);\n    }\n\n    if (options.yDisplay === 'log') {\n      yLabel = `log(${yLabel})`;\n    }\n\n    return {\n      yMin,\n      yMax,\n      yLabel,\n      yRange: yMax - yMin,\n    };\n  }\n\n  // The underlying table has `ts` and `value` columns.\n  private getValueExpression(): string {\n    const options = this.getCounterOptions();\n\n    let valueExpr;\n    switch (options.yMode) {\n      case 'value':\n        valueExpr = 'value';\n        break;\n      case 'delta':\n        valueExpr = 'lead(value, 1, value) over (order by ts) - value';\n        break;\n      case 'rate':\n        valueExpr =\n          '(lead(value, 1, value) over (order by ts) - value) / ((lead(ts, 1, 100) over (order by ts) - ts) / 1e9)';\n        break;\n      default:\n        assertUnreachable(options.yMode);\n    }\n\n    if (options.yDisplay === 'log') {\n      return `ifnull(ln(${valueExpr}), 0)`;\n    } else {\n      return valueExpr;\n    }\n  }\n\n  private getTableName(): string {\n    return `counter_${this.trackUuid}`;\n  }\n\n  private async maybeRequestData(rawCountersKey: CacheKey) {\n    if (rawCountersKey.isCoveredBy(this.countersKey)) {\n      return; // We have the data already, no need to re-query.\n    }\n\n    const countersKey = rawCountersKey.normalize();\n    if (!rawCountersKey.isCoveredBy(countersKey)) {\n      throw new Error(\n        `Normalization error ${countersKey.toString()} ${rawCountersKey.toString()}`,\n      );\n    }\n\n    if (this.limits === undefined) {\n      this.limits = await this.createTableAndFetchLimits(true);\n    }\n\n    const queryRes = await this.engine.query(`\n      SELECT\n        min_value as minDisplayValue,\n        max_value as maxDisplayValue,\n        last_ts as ts,\n        last_value as lastDisplayValue\n      FROM ${this.getTableName()}(\n        ${countersKey.start},\n        ${countersKey.end},\n        ${countersKey.bucketSize}\n      );\n    `);\n\n    const it = queryRes.iter({\n      ts: LONG,\n      minDisplayValue: NUM,\n      maxDisplayValue: NUM,\n      lastDisplayValue: NUM,\n    });\n\n    const numRows = queryRes.numRows();\n    const data: CounterData = {\n      timestamps: new BigInt64Array(numRows),\n      minDisplayValues: new Float64Array(numRows),\n      maxDisplayValues: new Float64Array(numRows),\n      lastDisplayValues: new Float64Array(numRows),\n      displayValueRange: [0, 0],\n    };\n\n    let min = 0;\n    let max = 0;\n    for (let row = 0; it.valid(); it.next(), row++) {\n      data.timestamps[row] = Time.fromRaw(it.ts);\n      data.minDisplayValues[row] = it.minDisplayValue;\n      data.maxDisplayValues[row] = it.maxDisplayValue;\n      data.lastDisplayValues[row] = it.lastDisplayValue;\n      min = Math.min(min, it.minDisplayValue);\n      max = Math.max(max, it.maxDisplayValue);\n    }\n\n    data.displayValueRange = [min, max];\n\n    this.countersKey = countersKey;\n    this.counters = data;\n\n    raf.scheduleCanvasRedraw();\n  }\n\n  private async createTableAndFetchLimits(\n    dropTable: boolean,\n  ): Promise<CounterLimits> {\n    const dropQuery = dropTable ? `drop table ${this.getTableName()};` : '';\n    const displayValueQuery = await this.engine.query(`\n      ${dropQuery}\n      create virtual table ${this.getTableName()}\n      using __intrinsic_counter_mipmap((\n        select\n          ts,\n          ${this.getValueExpression()} as value\n        from (${this.getSqlSource()})\n      ));\n      select\n        min_value as minDisplayValue,\n        max_value as maxDisplayValue\n      from ${this.getTableName()}(\n        trace_start(), trace_end(), trace_dur()\n      );\n    `);\n\n    this.trash.defer(async () => {\n      this.engine.tryQuery(`drop table if exists ${this.getTableName()}`);\n    });\n\n    const {minDisplayValue, maxDisplayValue} = displayValueQuery.firstRow({\n      minDisplayValue: NUM,\n      maxDisplayValue: NUM,\n    });\n\n    return {\n      minDisplayValue,\n      maxDisplayValue,\n    };\n  }\n\n  get unit(): string {\n    return this.getCounterOptions().unit ?? '';\n  }\n\n  protected get engine() {\n    return this.trace.engine;\n  }\n}\n"]}