{"version":3,"file":"argument_selector.js","sourceRoot":"","sources":["../../../../../../src/components/widgets/sql/legacy_table/argument_selector.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2024 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {raf} from '../../../../core/raf_scheduler';\nimport {Spinner} from '../../../../widgets/spinner';\nimport {\n  LegacyTableColumn,\n  tableColumnId,\n  LegacyTableColumnSet,\n  LegacyTableManager,\n} from './column';\nimport {TextInput} from '../../../../widgets/text_input';\nimport {scheduleFullRedraw} from '../../../../widgets/raf';\nimport {hasModKey, modKey} from '../../../../base/hotkeys';\nimport {MenuItem} from '../../../../widgets/menu';\nimport {uuidv4} from '../../../../base/uuid';\n\nconst MAX_ARGS_TO_DISPLAY = 15;\n\ninterface ArgumentSelectorAttrs {\n  tableManager: LegacyTableManager;\n  columnSet: LegacyTableColumnSet;\n  alreadySelectedColumnIds: Set<string>;\n  onArgumentSelected: (column: LegacyTableColumn) => void;\n}\n\n// This class is responsible for rendering a menu which allows user to select which column out of ColumnSet to add.\nexport class ArgumentSelector\n  implements m.ClassComponent<ArgumentSelectorAttrs>\n{\n  searchText = '';\n  columns?: {key: string; column: LegacyTableColumn | LegacyTableColumnSet}[];\n\n  constructor({attrs}: m.Vnode<ArgumentSelectorAttrs>) {\n    this.load(attrs);\n  }\n\n  private async load(attrs: ArgumentSelectorAttrs) {\n    this.columns = await attrs.columnSet.discover(attrs.tableManager);\n    raf.scheduleFullRedraw();\n  }\n\n  view({attrs}: m.Vnode<ArgumentSelectorAttrs>) {\n    const columns = this.columns;\n    if (columns === undefined) return m(Spinner);\n\n    // Candidates are the columns which have not been selected yet.\n    const candidates = columns.filter(\n      ({column}) =>\n        column instanceof LegacyTableColumnSet ||\n        !attrs.alreadySelectedColumnIds.has(tableColumnId(column)),\n    );\n\n    // Filter the candidates based on the search text.\n    const filtered = candidates.filter(({key}) => {\n      return key.toLowerCase().includes(this.searchText.toLowerCase());\n    });\n\n    const displayed = filtered.slice(0, MAX_ARGS_TO_DISPLAY);\n\n    const extraItems = Math.max(0, filtered.length - MAX_ARGS_TO_DISPLAY);\n\n    const firstButtonUuid = uuidv4();\n\n    return [\n      m(\n        '.pf-search-bar',\n        m(TextInput, {\n          autofocus: true,\n          oninput: (event: Event) => {\n            const eventTarget = event.target as HTMLTextAreaElement;\n            this.searchText = eventTarget.value;\n            scheduleFullRedraw();\n          },\n          onkeydown: (event: KeyboardEvent) => {\n            if (filtered.length === 0) return;\n            if (event.key === 'Enter') {\n              // If there is only one item or Mod-Enter was pressed, select the first element.\n              if (filtered.length === 1 || hasModKey(event)) {\n                const params = {bubbles: true};\n                if (hasModKey(event)) {\n                  Object.assign(params, modKey());\n                }\n                const pointerEvent = new PointerEvent('click', params);\n                (\n                  document.getElementById(firstButtonUuid) as HTMLElement | null\n                )?.dispatchEvent(pointerEvent);\n              }\n            }\n          },\n          value: this.searchText,\n          placeholder: 'Filter...',\n          className: 'pf-search-box',\n        }),\n      ),\n      ...displayed.map(({key, column}, index) =>\n        m(\n          MenuItem,\n          {\n            id: index === 0 ? firstButtonUuid : undefined,\n            label: key,\n            onclick: (event) => {\n              if (column instanceof LegacyTableColumnSet) return;\n              attrs.onArgumentSelected(column);\n              // For Control-Click, we don't want to close the menu to allow the user\n              // to select multiple items in one go.\n              if (hasModKey(event)) {\n                event.stopPropagation();\n              }\n              // Otherwise this popup will be closed.\n            },\n          },\n          column instanceof LegacyTableColumnSet &&\n            m(ArgumentSelector, {\n              columnSet: column,\n              alreadySelectedColumnIds: attrs.alreadySelectedColumnIds,\n              onArgumentSelected: attrs.onArgumentSelected,\n              tableManager: attrs.tableManager,\n            }),\n        ),\n      ),\n      Boolean(extraItems) && m('i', `+${extraItems} more`),\n    ];\n  }\n}\n"]}