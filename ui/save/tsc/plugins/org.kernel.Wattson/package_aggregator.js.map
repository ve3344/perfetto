{"version":3,"file":"package_aggregator.js","sourceRoot":"","sources":["../../../../src/plugins/org.kernel.Wattson/package_aggregator.ts"],"names":[],"mappings":";AAAA,qDAAqD;AACrD,EAAE;AACF,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,kDAAkD;AAClD,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;;;AAEjC,4CAAwC;AAIxC,qEAAuD;AACvD,0DAA8D;AAG9D,MAAa,iCAAiC;IAGnC,EAAE,GAAG,6BAA6B,CAAC;IAE5C,KAAK,CAAC,mBAAmB,CAAC,MAAc,EAAE,IAAmB;QAC3D,MAAM,MAAM,CAAC,KAAK,CAAC,uBAAuB,IAAI,CAAC,EAAE,GAAG,CAAC,CAAC;QAEtD,MAAM,WAAW,GAAG,MAAM,MAAM,CAAC,KAAK,CAAC;;;;KAItC,CAAC,CAAC;QACH,IAAI,WAAW,CAAC,QAAQ,CAAC,EAAC,OAAO,EAAE,kBAAG,EAAC,CAAC,CAAC,OAAO,KAAK,CAAC;YAAE,OAAO,KAAK,CAAC;QAErE,MAAM,YAAY,GAAa,EAAE,CAAC;QAClC,KAAK,MAAM,SAAS,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;YACpC,IAAI,SAAS,EAAE,IAAI,EAAE,IAAI,KAAK,kCAAoB,EAAE,CAAC;gBACnD,IAAA,cAAM,EAAC,SAAS,CAAC,IAAI,CAAC,GAAG,CAAC,IAAI,YAAY,CAAC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACtE,CAAC;QACH,CAAC;QACD,IAAI,YAAY,CAAC,MAAM,KAAK,CAAC;YAAE,OAAO,KAAK,CAAC;QAE5C,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC;QAEvC,2EAA2E;QAC3E,iDAAiD;QACjD,MAAM,CAAC,KAAK,CAAC;;oBAEG,IAAI,CAAC,EAAE;;iCAEM,QAAQ;;;;;;;KAOpC,CAAC,CAAC;QAEH,OAAO,IAAI,CAAC;IACd,CAAC;IAED,oBAAoB;QAClB,OAAO;YACL;gBACE,KAAK,EAAE,cAAc;gBACrB,IAAI,EAAE,QAAQ;gBACd,iBAAiB,EAAE,WAAW;gBAC9B,QAAQ,EAAE,cAAc;aACzB;YACD;gBACE,KAAK,EAAE,iBAAiB;gBACxB,IAAI,EAAE,QAAQ;gBACd,iBAAiB,EAAE,WAAW;gBAC9B,QAAQ,EAAE,KAAK;aAChB;YACD;gBACE,KAAK,EAAE,qBAAqB;gBAC5B,IAAI,EAAE,QAAQ;gBACd,iBAAiB,EAAE,YAAY;gBAC/B,QAAQ,EAAE,QAAQ;aACnB;YACD;gBACE,KAAK,EAAE,6BAA6B;gBACpC,IAAI,EAAE,QAAQ;gBACd,iBAAiB,EAAE,YAAY;gBAC/B,QAAQ,EAAE,WAAW;gBACrB,GAAG,EAAE,IAAI;aACV;YACD;gBACE,KAAK,EAAE,+BAA+B;gBACtC,IAAI,EAAE,QAAQ;gBACd,iBAAiB,EAAE,YAAY;gBAC/B,QAAQ,EAAE,YAAY;gBACtB,GAAG,EAAE,IAAI;aACV;SACF,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,QAAQ,KAAI,CAAC;IAEnB,UAAU;QACR,OAAO,oBAAoB,CAAC;IAC9B,CAAC;IAED,iBAAiB;QACf,OAAO,EAAC,MAAM,EAAE,YAAY,EAAE,SAAS,EAAE,MAAM,EAAC,CAAC;IACnD,CAAC;CACF;AAzFD,8EAyFC","sourcesContent":["// Copyright (C) 2024 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {exists} from '../../base/utils';\nimport {ColumnDef, Sorting} from '../../public/aggregation';\nimport {AreaSelection} from '../../public/selection';\nimport {Engine} from '../../trace_processor/engine';\nimport {NUM} from '../../trace_processor/query_result';\nimport {CPU_SLICE_TRACK_KIND} from '../../public/track_kinds';\nimport {AreaSelectionAggregator} from '../../public/selection';\n\nexport class WattsonPackageSelectionAggregator\n  implements AreaSelectionAggregator\n{\n  readonly id = 'wattson_package_aggregation';\n\n  async createAggregateView(engine: Engine, area: AreaSelection) {\n    await engine.query(`drop view if exists ${this.id};`);\n\n    const packageInfo = await engine.query(`\n      INCLUDE PERFETTO MODULE android.process_metadata;\n      SELECT COUNT(*) as isValid FROM android_process_metadata\n      WHERE package_name IS NOT NULL\n    `);\n    if (packageInfo.firstRow({isValid: NUM}).isValid === 0) return false;\n\n    const selectedCpus: number[] = [];\n    for (const trackInfo of area.tracks) {\n      if (trackInfo?.tags?.kind === CPU_SLICE_TRACK_KIND) {\n        exists(trackInfo.tags.cpu) && selectedCpus.push(trackInfo.tags.cpu);\n      }\n    }\n    if (selectedCpus.length === 0) return false;\n\n    const duration = area.end - area.start;\n\n    // Prerequisite tables are already generated by Wattson thread aggregation,\n    // which is run prior to execution of this module\n    engine.query(`\n      -- Grouped by UID and made CPU agnostic\n      CREATE VIEW ${this.id} AS\n      SELECT\n        ROUND(SUM(total_pws) / ${duration}, 2) as active_mw,\n        ROUND(SUM(total_pws) / 1000000000, 2) as active_mws,\n        ROUND(SUM(dur) / 1000000.0, 2) as dur_ms,\n        uid,\n        package_name\n      FROM _unioned_per_cpu_total\n      GROUP BY uid;\n    `);\n\n    return true;\n  }\n\n  getColumnDefinitions(): ColumnDef[] {\n    return [\n      {\n        title: 'Package Name',\n        kind: 'STRING',\n        columnConstructor: Uint16Array,\n        columnId: 'package_name',\n      },\n      {\n        title: 'Android app UID',\n        kind: 'NUMBER',\n        columnConstructor: Uint16Array,\n        columnId: 'uid',\n      },\n      {\n        title: 'Total Duration (ms)',\n        kind: 'NUMBER',\n        columnConstructor: Float64Array,\n        columnId: 'dur_ms',\n      },\n      {\n        title: 'Active power (estimated mW)',\n        kind: 'NUMBER',\n        columnConstructor: Float64Array,\n        columnId: 'active_mw',\n        sum: true,\n      },\n      {\n        title: 'Active energy (estimated mWs)',\n        kind: 'NUMBER',\n        columnConstructor: Float64Array,\n        columnId: 'active_mws',\n        sum: true,\n      },\n    ];\n  }\n\n  async getExtra() {}\n\n  getTabName() {\n    return 'Wattson by package';\n  }\n\n  getDefaultSorting(): Sorting {\n    return {column: 'active_mws', direction: 'DESC'};\n  }\n}\n"]}