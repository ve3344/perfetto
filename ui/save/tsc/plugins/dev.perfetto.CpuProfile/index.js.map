{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/plugins/dev.perfetto.CpuProfile/index.ts"],"names":[],"mappings":";AAAA,qDAAqD;AACrD,EAAE;AACF,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,kDAAkD;AAClD,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;;;AAEjC,0DAAgE;AAGhE,qEAA2E;AAC3E,2DAAoD;AACpD,8CAAsD;AACtD,4CAAwC;AACxC,sDAAiD;AACjD,mHAA4E;AAE5E;IACE,MAAM,CAAU,EAAE,GAAG,yBAAyB,CAAC;IAC/C,MAAM,CAAU,YAAY,GAAG,CAAC,0CAAyB,CAAC,CAAC;IAE3D,KAAK,CAAC,WAAW,CAAC,GAAU;QAC1B,MAAM,MAAM,GAAG,MAAM,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC;;;;;;;;;;;;;KAarC,CAAC,CAAC;QAEH,MAAM,EAAE,GAAG,MAAM,CAAC,IAAI,CAAC;YACrB,IAAI,EAAE,kBAAG;YACT,IAAI,EAAE,uBAAQ;YACd,GAAG,EAAE,uBAAQ;YACb,UAAU,EAAE,uBAAQ;SACrB,CAAC,CAAC;QACH,OAAO,EAAE,CAAC,KAAK,EAAE,EAAE,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC;YAC7B,MAAM,IAAI,GAAG,EAAE,CAAC,IAAI,CAAC;YACrB,MAAM,IAAI,GAAG,EAAE,CAAC,IAAI,CAAC;YACrB,MAAM,UAAU,GAAG,EAAE,CAAC,UAAU,CAAC;YACjC,MAAM,GAAG,GAAG,GAAG,IAAA,0BAAkB,EAAC,IAAI,EAAE,IAAI,CAAC,cAAc,CAAC;YAC5D,MAAM,KAAK,GAAG,GAAG,UAAU,sBAAsB,CAAC;YAClD,GAAG,CAAC,MAAM,CAAC,aAAa,CAAC;gBACvB,GAAG;gBACH,KAAK;gBACL,IAAI,EAAE;oBACJ,IAAI,EAAE,oCAAsB;oBAC5B,IAAI;oBACJ,GAAG,CAAC,IAAA,cAAM,EAAC,IAAI,CAAC,IAAI,EAAC,IAAI,EAAC,CAAC;iBAC5B;gBACD,KAAK,EAAE,IAAI,mCAAe,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,CAAC;aAC3C,CAAC,CAAC;YACH,MAAM,KAAK,GAAG,GAAG,CAAC,OAAO;iBACtB,SAAS,CAAC,0CAAyB,CAAC;iBACpC,iBAAiB,CAAC,IAAI,CAAC,CAAC;YAC3B,MAAM,KAAK,GAAG,IAAI,qBAAS,CAAC,EAAC,GAAG,EAAE,KAAK,EAAE,SAAS,EAAE,CAAC,EAAE,EAAC,CAAC,CAAC;YAC1D,KAAK,EAAE,eAAe,CAAC,KAAK,CAAC,CAAC;QAChC,CAAC;IACH,CAAC;;AAhDH,4BAiDC","sourcesContent":["// Copyright (C) 2021 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {CPU_PROFILE_TRACK_KIND} from '../../public/track_kinds';\nimport {Trace} from '../../public/trace';\nimport {PerfettoPlugin} from '../../public/plugin';\nimport {NUM, NUM_NULL, STR_NULL} from '../../trace_processor/query_result';\nimport {CpuProfileTrack} from './cpu_profile_track';\nimport {getThreadUriPrefix} from '../../public/utils';\nimport {exists} from '../../base/utils';\nimport {TrackNode} from '../../public/workspace';\nimport ProcessThreadGroupsPlugin from '../dev.perfetto.ProcessThreadGroups';\n\nexport default class implements PerfettoPlugin {\n  static readonly id = 'dev.perfetto.CpuProfile';\n  static readonly dependencies = [ProcessThreadGroupsPlugin];\n\n  async onTraceLoad(ctx: Trace): Promise<void> {\n    const result = await ctx.engine.query(`\n      with thread_cpu_sample as (\n        select distinct utid\n        from cpu_profile_stack_sample\n        where utid != 0\n      )\n      select\n        utid,\n        tid,\n        upid,\n        thread.name as threadName\n      from thread_cpu_sample\n      join thread using(utid)\n    `);\n\n    const it = result.iter({\n      utid: NUM,\n      upid: NUM_NULL,\n      tid: NUM_NULL,\n      threadName: STR_NULL,\n    });\n    for (; it.valid(); it.next()) {\n      const utid = it.utid;\n      const upid = it.upid;\n      const threadName = it.threadName;\n      const uri = `${getThreadUriPrefix(upid, utid)}_cpu_samples`;\n      const title = `${threadName} (CPU Stack Samples)`;\n      ctx.tracks.registerTrack({\n        uri,\n        title,\n        tags: {\n          kind: CPU_PROFILE_TRACK_KIND,\n          utid,\n          ...(exists(upid) && {upid}),\n        },\n        track: new CpuProfileTrack(ctx, uri, utid),\n      });\n      const group = ctx.plugins\n        .getPlugin(ProcessThreadGroupsPlugin)\n        .getGroupForThread(utid);\n      const track = new TrackNode({uri, title, sortOrder: -40});\n      group?.addChildInOrder(track);\n    }\n  }\n}\n"]}