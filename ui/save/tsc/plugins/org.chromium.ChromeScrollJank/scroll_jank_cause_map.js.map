{"version":3,"file":"scroll_jank_cause_map.js","sourceRoot":"","sources":["../../../../src/plugins/org.chromium.ChromeScrollJank/scroll_jank_cause_map.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2023 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {exists} from '../../base/utils';\nimport {Engine} from '../../trace_processor/engine';\nimport {STR} from '../../trace_processor/query_result';\n\nexport enum CauseProcess {\n  UNKNOWN,\n  BROWSER = 'Browser',\n  RENDERER = 'Renderer',\n  GPU = 'GPU',\n}\n\nexport enum CauseThread {\n  UNKNOWN,\n  BROWSER_MAIN = 'CrBrowserMain',\n  RENDERER_MAIN = 'CrRendererMain',\n  COMPOSITOR = 'Compositor',\n  CHROME_CHILD_IO_THREAD = 'Chrome_ChildIOThread',\n  VIZ_COMPOSITOR = 'VizCompositorThread',\n  SURFACE_FLINGER = 'surfaceflinger',\n}\n\nexport interface ScrollJankCause {\n  description: string;\n  process: CauseProcess;\n  thread: CauseThread;\n}\n\nexport interface EventLatencyStageDetails {\n  description: string;\n  jankCauses: ScrollJankCause[];\n}\n\nexport interface ScrollJankCauseMapInternal {\n  // Key corresponds with the EventLatency stage.\n  [key: string]: EventLatencyStageDetails;\n}\n\nfunction getScrollJankProcess(process: string): CauseProcess {\n  switch (process) {\n    case CauseProcess.BROWSER:\n      return CauseProcess.BROWSER;\n    case CauseProcess.RENDERER:\n      return CauseProcess.RENDERER;\n    case CauseProcess.GPU:\n      return CauseProcess.GPU;\n    default:\n      return CauseProcess.UNKNOWN;\n  }\n}\n\nfunction getScrollJankThread(thread: string): CauseThread {\n  switch (thread) {\n    case CauseThread.BROWSER_MAIN:\n      return CauseThread.BROWSER_MAIN;\n    case CauseThread.RENDERER_MAIN:\n      return CauseThread.RENDERER_MAIN;\n    case CauseThread.CHROME_CHILD_IO_THREAD:\n      return CauseThread.CHROME_CHILD_IO_THREAD;\n    case CauseThread.COMPOSITOR:\n      return CauseThread.COMPOSITOR;\n    case CauseThread.VIZ_COMPOSITOR:\n      return CauseThread.VIZ_COMPOSITOR;\n    case CauseThread.SURFACE_FLINGER:\n      return CauseThread.SURFACE_FLINGER;\n    default:\n      return CauseThread.UNKNOWN;\n  }\n}\n\nexport class ScrollJankCauseMap {\n  private static instance: ScrollJankCauseMap;\n  private causes: ScrollJankCauseMapInternal;\n\n  private constructor() {\n    this.causes = {};\n  }\n\n  private async initializeCauseMap(engine: Engine) {\n    const queryResult = await engine.query(`\n      INCLUDE PERFETTO MODULE chrome.scroll_jank.scroll_jank_cause_map;\n\n      SELECT\n        IFNULL(name, '') AS name,\n        IFNULL(description, '') AS description,\n        IFNULL(cause_process, '') AS causeProcess,\n        IFNULL(cause_thread, '') AS causeThread,\n        IFNULL(cause_description, '') AS causeDescription\n      FROM chrome_scroll_jank_causes_with_event_latencies;\n    `);\n\n    const iter = queryResult.iter({\n      name: STR,\n      description: STR,\n      causeProcess: STR,\n      causeThread: STR,\n      causeDescription: STR,\n    });\n\n    for (; iter.valid(); iter.next()) {\n      const eventLatencyStage = iter.name;\n      if (!(eventLatencyStage in this.causes)) {\n        this.causes[eventLatencyStage] = {\n          description: iter.description,\n          jankCauses: [] as ScrollJankCause[],\n        };\n      }\n\n      const causeProcess = getScrollJankProcess(iter.causeProcess);\n      const causeThread = getScrollJankThread(iter.causeThread);\n\n      this.causes[eventLatencyStage].jankCauses.push({\n        description: iter.causeDescription,\n        process: causeProcess,\n        thread: causeThread,\n      });\n    }\n  }\n\n  // Must be called before this item is accessed, as the object is populated\n  // from SQL data.\n  public static async initialize(engine: Engine) {\n    if (!exists(ScrollJankCauseMap.instance)) {\n      ScrollJankCauseMap.instance = new ScrollJankCauseMap();\n      await ScrollJankCauseMap.instance.initializeCauseMap(engine);\n    }\n  }\n\n  public static getEventLatencyDetails(\n    eventLatency: string,\n  ): EventLatencyStageDetails | undefined {\n    if (eventLatency in ScrollJankCauseMap.instance.causes) {\n      return ScrollJankCauseMap.instance.causes[eventLatency];\n    }\n    return undefined;\n  }\n}\n"]}