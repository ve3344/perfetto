{"version":3,"file":"scroll_details_panel.js","sourceRoot":"","sources":["../../../../src/plugins/org.chromium.ChromeScrollJank/scroll_details_panel.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2023 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {duration, Time, time} from '../../base/time';\nimport {exists} from '../../base/utils';\nimport {\n  ColumnDescriptor,\n  Table,\n  TableData,\n  widgetColumn,\n} from '../../widgets/table';\nimport {DurationWidget} from '../../components/widgets/duration';\nimport {Timestamp} from '../../components/widgets/timestamp';\nimport {\n  LONG,\n  LONG_NULL,\n  NUM,\n  NUM_NULL,\n  STR,\n} from '../../trace_processor/query_result';\nimport {DetailsShell} from '../../widgets/details_shell';\nimport {GridLayout, GridLayoutColumn} from '../../widgets/grid_layout';\nimport {Section} from '../../widgets/section';\nimport {SqlRef} from '../../widgets/sql_ref';\nimport {MultiParagraphText, TextParagraph} from '../../widgets/text_paragraph';\nimport {dictToTreeNodes, Tree} from '../../widgets/tree';\nimport {\n  buildScrollOffsetsGraph,\n  getInputScrollDeltas,\n  getJankIntervals,\n  getPredictorJankDeltas,\n  getPresentedScrollDeltas,\n} from './scroll_delta_graph';\nimport {JANKS_TRACK_URI, renderSliceRef} from './selection_utils';\nimport {TrackEventDetailsPanel} from '../../public/details_panel';\nimport {Trace} from '../../public/trace';\n\ninterface Data {\n  // Scroll ID.\n  id: number;\n  // Timestamp of the beginning of this slice in nanoseconds.\n  ts: time;\n  // DurationWidget of this slice in nanoseconds.\n  dur: duration;\n}\n\ninterface Metrics {\n  inputEventCount?: number;\n  frameCount?: number;\n  presentedFrameCount?: number;\n  jankyFrameCount?: number;\n  jankyFramePercent?: number;\n  missedVsyncs?: number;\n  startOffset?: number;\n  endOffset?: number;\n  totalPixelsScrolled?: number;\n}\n\ninterface JankSliceDetails {\n  cause: string;\n  id: number;\n  ts: time;\n  dur?: duration;\n  delayVsync?: number;\n}\n\nexport class ScrollDetailsPanel implements TrackEventDetailsPanel {\n  private data?: Data;\n  private metrics: Metrics = {};\n  private orderedJankSlices: JankSliceDetails[] = [];\n\n  // TODO(altimin): Don't store Mithril vnodes between render cycles.\n  private scrollDeltas: m.Child;\n\n  constructor(\n    private readonly trace: Trace,\n    private readonly id: number,\n  ) {}\n\n  async load() {\n    const queryResult = await this.trace.engine.query(`\n      WITH scrolls AS (\n        SELECT\n          id,\n          IFNULL(gesture_scroll_begin_ts, ts) AS start_ts,\n          CASE\n            WHEN gesture_scroll_end_ts IS NOT NULL THEN gesture_scroll_end_ts\n            WHEN gesture_scroll_begin_ts IS NOT NULL\n              THEN gesture_scroll_begin_ts + dur\n            ELSE ts + dur\n          END AS end_ts\n        FROM chrome_scrolls WHERE id = ${this.id})\n      SELECT\n        id,\n        start_ts AS ts,\n        end_ts - start_ts AS dur\n      FROM scrolls`);\n\n    const iter = queryResult.firstRow({\n      id: NUM,\n      ts: LONG,\n      dur: LONG,\n    });\n    this.data = {\n      id: iter.id,\n      ts: Time.fromRaw(iter.ts),\n      dur: iter.dur,\n    };\n\n    await this.loadMetrics();\n  }\n\n  private async loadMetrics() {\n    await this.loadInputEventCount();\n    await this.loadFrameStats();\n    await this.loadDelayData();\n    await this.loadScrollOffsets();\n  }\n\n  private async loadInputEventCount() {\n    if (exists(this.data)) {\n      const queryResult = await this.trace.engine.query(`\n        SELECT\n          COUNT(*) AS inputEventCount\n        FROM slice s\n        WHERE s.name = \"EventLatency\"\n          AND EXTRACT_ARG(arg_set_id, 'event_latency.event_type') = 'TOUCH_MOVED'\n          AND s.ts >= ${this.data.ts}\n          AND s.ts + s.dur <= ${this.data.ts + this.data.dur}\n      `);\n\n      const iter = queryResult.firstRow({\n        inputEventCount: NUM,\n      });\n\n      this.metrics.inputEventCount = iter.inputEventCount;\n    }\n  }\n\n  private async loadFrameStats() {\n    if (exists(this.data)) {\n      const queryResult = await this.trace.engine.query(`\n        SELECT\n          IFNULL(frame_count, 0) AS frameCount,\n          IFNULL(missed_vsyncs, 0) AS missedVsyncs,\n          IFNULL(presented_frame_count, 0) AS presentedFrameCount,\n          IFNULL(janky_frame_count, 0) AS jankyFrameCount,\n          ROUND(IFNULL(janky_frame_percent, 0), 2) AS jankyFramePercent\n        FROM chrome_scroll_stats\n        WHERE scroll_id = ${this.data.id}\n      `);\n      const iter = queryResult.iter({\n        frameCount: NUM,\n        missedVsyncs: NUM,\n        presentedFrameCount: NUM,\n        jankyFrameCount: NUM,\n        jankyFramePercent: NUM,\n      });\n\n      for (; iter.valid(); iter.next()) {\n        this.metrics.frameCount = iter.frameCount;\n        this.metrics.missedVsyncs = iter.missedVsyncs;\n        this.metrics.presentedFrameCount = iter.presentedFrameCount;\n        this.metrics.jankyFrameCount = iter.jankyFrameCount;\n        this.metrics.jankyFramePercent = iter.jankyFramePercent;\n        return;\n      }\n    }\n  }\n\n  private async loadDelayData() {\n    if (exists(this.data)) {\n      const queryResult = await this.trace.engine.query(`\n        SELECT\n          id,\n          ts,\n          dur,\n          IFNULL(sub_cause_of_jank, IFNULL(cause_of_jank, 'Unknown')) AS cause,\n          event_latency_id AS eventLatencyId,\n          delayed_frame_count AS delayVsync\n        FROM chrome_janky_frame_presentation_intervals s\n        WHERE s.ts >= ${this.data.ts}\n          AND s.ts + s.dur <= ${this.data.ts + this.data.dur}\n        ORDER by dur DESC;\n      `);\n\n      const it = queryResult.iter({\n        id: NUM,\n        ts: LONG,\n        dur: LONG_NULL,\n        cause: STR,\n        eventLatencyId: NUM_NULL,\n        delayVsync: NUM_NULL,\n      });\n\n      for (; it.valid(); it.next()) {\n        this.orderedJankSlices.push({\n          id: it.id,\n          ts: Time.fromRaw(it.ts),\n          dur: it.dur ?? undefined,\n          cause: it.cause,\n          delayVsync: it.delayVsync ?? undefined,\n        });\n      }\n    }\n  }\n\n  private async loadScrollOffsets() {\n    if (exists(this.data)) {\n      const inputDeltas = await getInputScrollDeltas(\n        this.trace.engine,\n        this.data.id,\n      );\n      const presentedDeltas = await getPresentedScrollDeltas(\n        this.trace.engine,\n        this.data.id,\n      );\n      const predictorDeltas = await getPredictorJankDeltas(\n        this.trace.engine,\n        this.data.id,\n      );\n      const jankIntervals = await getJankIntervals(\n        this.trace.engine,\n        this.data.ts,\n        this.data.dur,\n      );\n      this.scrollDeltas = buildScrollOffsetsGraph(\n        inputDeltas,\n        presentedDeltas,\n        predictorDeltas,\n        jankIntervals,\n      );\n\n      if (presentedDeltas.length > 0) {\n        this.metrics.startOffset = presentedDeltas[0].scrollOffset;\n        this.metrics.endOffset =\n          presentedDeltas[presentedDeltas.length - 1].scrollOffset;\n\n        let pixelsScrolled = 0;\n        for (let i = 0; i < presentedDeltas.length; i++) {\n          pixelsScrolled += Math.abs(presentedDeltas[i].scrollDelta);\n        }\n\n        if (pixelsScrolled != 0) {\n          this.metrics.totalPixelsScrolled = pixelsScrolled;\n        }\n      }\n    }\n  }\n\n  private renderMetricsDictionary(): m.Child[] {\n    const metrics: {[key: string]: m.Child} = {};\n    metrics['Total Finger Input Event Count'] = this.metrics.inputEventCount;\n    metrics['Total Vsyncs within Scrolling period'] = this.metrics.frameCount;\n    metrics['Total Chrome Presented Frames'] = this.metrics.presentedFrameCount;\n    metrics['Total Janky Frames'] = this.metrics.jankyFrameCount;\n    metrics['Number of Vsyncs Janky Frames were Delayed by'] =\n      this.metrics.missedVsyncs;\n\n    if (this.metrics.jankyFramePercent !== undefined) {\n      metrics[\n        'Janky Frame Percentage (Total Janky Frames / Total Chrome Presented Frames)'\n      ] = `${this.metrics.jankyFramePercent}%`;\n    }\n\n    if (this.metrics.startOffset != undefined) {\n      metrics['Starting Offset'] = this.metrics.startOffset;\n    }\n\n    if (this.metrics.endOffset != undefined) {\n      metrics['Ending Offset'] = this.metrics.endOffset;\n    }\n\n    if (\n      this.metrics.startOffset != undefined &&\n      this.metrics.endOffset != undefined\n    ) {\n      metrics['Net Pixels Scrolled'] = Math.abs(\n        this.metrics.endOffset - this.metrics.startOffset,\n      );\n    }\n\n    if (this.metrics.totalPixelsScrolled != undefined) {\n      metrics['Total Pixels Scrolled (all directions)'] =\n        this.metrics.totalPixelsScrolled;\n    }\n\n    return dictToTreeNodes(metrics);\n  }\n\n  private getDelayTable(): m.Child {\n    if (this.orderedJankSlices.length > 0) {\n      const columns: ColumnDescriptor<JankSliceDetails>[] = [\n        widgetColumn<JankSliceDetails>('Cause', (jankSlice) =>\n          renderSliceRef({\n            trace: this.trace,\n            id: jankSlice.id,\n            trackUri: JANKS_TRACK_URI,\n            title: jankSlice.cause,\n          }),\n        ),\n        widgetColumn<JankSliceDetails>('Duration', (jankSlice) =>\n          jankSlice.dur !== undefined\n            ? m(DurationWidget, {dur: jankSlice.dur})\n            : 'NULL',\n        ),\n        widgetColumn<JankSliceDetails>(\n          'Delayed Vsyncs',\n          (jankSlice) => jankSlice.delayVsync,\n        ),\n      ];\n\n      const tableData = new TableData(this.orderedJankSlices);\n\n      return m(Table, {\n        data: tableData,\n        columns: columns,\n      });\n    } else {\n      return 'None';\n    }\n  }\n\n  private getDescriptionText(): m.Child {\n    return m(\n      MultiParagraphText,\n      m(TextParagraph, {\n        text: `The interval during which the user has started a scroll ending\n                 after their finger leaves the screen and any resulting fling\n                 animations have finished.`,\n      }),\n      m(TextParagraph, {\n        text: `Note: This can contain periods of time where the finger is down\n                 and not moving and no active scrolling is occurring.`,\n      }),\n      m(TextParagraph, {\n        text: `Note: Sometimes if a user touches the screen quickly after\n                 letting go or Chrome was hung and got into a bad state. A new\n                 scroll will start which will result in a slightly overlapping\n                 scroll. This can occur due to the last scroll still outputting\n                 frames (to get caught up) and the \"new\" scroll having started\n                 producing frames after the user has started scrolling again.`,\n      }),\n    );\n  }\n\n  private getGraphText(): m.Child {\n    return m(\n      MultiParagraphText,\n      m(TextParagraph, {\n        text: `The scroll offset is the discrepancy in physical screen pixels\n                 between two consecutive frames.`,\n      }),\n      m(TextParagraph, {\n        text: `The overall curve of the graph indicates the direction (up or\n                 down) by which the user scrolled over time.`,\n      }),\n      m(TextParagraph, {\n        text: `Grey blocks in the graph represent intervals of jank\n                 corresponding with the Chrome Scroll Janks track.`,\n      }),\n      m(TextParagraph, {\n        text: `Yellow dots represent frames that were presented (sae as the red\n                 dots), but that we suspect are visible to users as unsmooth\n                 velocity/stutter (predictor jank).`,\n      }),\n    );\n  }\n\n  render() {\n    if (this.data == undefined) {\n      return m('h2', 'Loading');\n    }\n\n    const details = dictToTreeNodes({\n      'Scroll ID': this.data.id,\n      'Start time': m(Timestamp, {ts: this.data.ts}),\n      'Duration': m(DurationWidget, {dur: this.data.dur}),\n      'SQL ID': m(SqlRef, {table: 'chrome_scrolls', id: this.id}),\n    });\n\n    return m(\n      DetailsShell,\n      {\n        title: 'Scroll',\n      },\n      m(\n        GridLayout,\n        m(\n          GridLayoutColumn,\n          m(Section, {title: 'Details'}, m(Tree, details)),\n          m(\n            Section,\n            {title: 'Slice Metrics'},\n            m(Tree, this.renderMetricsDictionary()),\n          ),\n          m(\n            Section,\n            {title: 'Frame Presentation Delays'},\n            this.getDelayTable(),\n          ),\n        ),\n        m(\n          GridLayoutColumn,\n          m(Section, {title: 'Description'}, this.getDescriptionText()),\n          m(\n            Section,\n            {title: 'Scroll Offsets Plot'},\n            m(\".div[style='padding-bottom:5px']\", this.getGraphText()),\n            this.scrollDeltas,\n          ),\n        ),\n      ),\n    );\n  }\n}\n"]}