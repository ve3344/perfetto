{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/plugins/org.chromium.ChromeScrollJank/index.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2022 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {uuidv4Sql} from '../../base/uuid';\nimport {generateSqlWithInternalLayout} from '../../components/sql_utils/layout';\nimport {Trace} from '../../public/trace';\nimport {PerfettoPlugin} from '../../public/plugin';\nimport {EventLatencyTrack, JANKY_LATENCY_NAME} from './event_latency_track';\nimport {ScrollJankV3Track} from './scroll_jank_v3_track';\nimport {ScrollTimelineTrack} from './scroll_timeline_track';\nimport {TopLevelScrollTrack} from './scroll_track';\nimport {ScrollJankCauseMap} from './scroll_jank_cause_map';\nimport {TrackNode} from '../../public/workspace';\n\nexport default class implements PerfettoPlugin {\n  static readonly id = 'org.chromium.ChromeScrollJank';\n  async onTraceLoad(ctx: Trace): Promise<void> {\n    const group = new TrackNode({\n      title: 'Chrome Scroll Jank',\n      sortOrder: -30,\n      isSummary: true,\n    });\n    await this.addTopLevelScrollTrack(ctx, group);\n    await this.addEventLatencyTrack(ctx, group);\n    await this.addScrollJankV3ScrollTrack(ctx, group);\n    await ScrollJankCauseMap.initialize(ctx.engine);\n    this.addScrollTimelineTrack(ctx, group);\n    ctx.workspace.addChildInOrder(group);\n    group.expand();\n  }\n\n  private async addTopLevelScrollTrack(\n    ctx: Trace,\n    group: TrackNode,\n  ): Promise<void> {\n    await ctx.engine.query(`\n      INCLUDE PERFETTO MODULE chrome.chrome_scrolls;\n      INCLUDE PERFETTO MODULE chrome.scroll_jank.scroll_offsets;\n      INCLUDE PERFETTO MODULE chrome.event_latency;\n    `);\n\n    const uri = 'org.chromium.ChromeScrollJank#toplevelScrolls';\n    const title = 'Chrome Scrolls';\n\n    ctx.tracks.registerTrack({\n      uri,\n      title,\n      track: new TopLevelScrollTrack(ctx, uri),\n    });\n\n    const track = new TrackNode({uri, title});\n    group.addChildInOrder(track);\n  }\n\n  private async addEventLatencyTrack(\n    ctx: Trace,\n    group: TrackNode,\n  ): Promise<void> {\n    const subTableSql = generateSqlWithInternalLayout({\n      columns: ['id', 'ts', 'dur', 'track_id', 'name'],\n      sourceTable: 'chrome_event_latencies',\n      ts: 'ts',\n      dur: 'dur',\n      whereClause: `\n        event_type IN (\n          'FIRST_GESTURE_SCROLL_UPDATE',\n          'GESTURE_SCROLL_UPDATE',\n          'INERTIAL_GESTURE_SCROLL_UPDATE')\n        AND is_presented`,\n    });\n\n    // Table name must be unique - it cannot include '-' characters or begin\n    // with a numeric value.\n    const baseTable = `table_${uuidv4Sql()}_janky_event_latencies_v3`;\n    const tableDefSql = `CREATE TABLE ${baseTable} AS\n        WITH\n        event_latencies AS MATERIALIZED (\n          ${subTableSql}\n        ),\n        latency_stages AS (\n          SELECT\n            stage.id,\n            stage.ts,\n            stage.dur,\n            stage.track_id,\n            stage.name,\n            stage.depth,\n            event.id as event_latency_id,\n            event.depth as event_latency_depth\n          FROM event_latencies event\n          JOIN descendant_slice(event.id) stage\n          UNION ALL\n          SELECT\n            event.id,\n            event.ts,\n            event.dur,\n            event.track_id,\n            IIF(\n              id IN (SELECT id FROM chrome_janky_event_latencies_v3),\n              '${JANKY_LATENCY_NAME}',\n              name\n            ) as name,\n            0 as depth,\n            event.id as event_latency_id,\n            event.depth as event_latency_depth\n          FROM event_latencies event\n        ),\n        -- Event latencies have already had layout computed, but the width of event latency can vary (3 or 4),\n        -- so we have to compute the max stage depth for each event latency depth to compute offset for each\n        -- event latency row.\n        event_latency_height_per_row AS (\n          SELECT\n            event_latency_depth,\n            MAX(depth) AS max_depth\n          FROM latency_stages\n          GROUP BY event_latency_depth\n        ),\n        -- Compute the offset for each event latency depth using max depth info for each depth.\n        event_latency_layout_offset AS (\n          SELECT\n            event_latency_depth,\n            -- As the sum is exclusive, it will return NULL for the first row â€” we need to set it to 0 explicitly.\n            IFNULL(\n              SUM(max_depth + 1) OVER (\n                ORDER BY event_latency_depth\n                ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING\n              ),\n            0) as offset\n          FROM event_latency_height_per_row\n        )\n      SELECT\n        stage.id,\n        stage.ts,\n        stage.dur,\n        stage.name,\n        stage.depth + (\n          (\n            SELECT offset.offset\n            FROM event_latencies event\n            JOIN event_latency_layout_offset offset ON event.depth = offset.event_latency_depth\n            WHERE id = stage.event_latency_id\n          )\n        ) AS depth\n      FROM latency_stages stage;`;\n\n    await ctx.engine.query(\n      `INCLUDE PERFETTO MODULE chrome.scroll_jank.scroll_jank_intervals`,\n    );\n    await ctx.engine.query(tableDefSql);\n\n    const uri = 'org.chromium.ChromeScrollJank#eventLatency';\n    const title = 'Chrome Scroll Input Latencies';\n\n    ctx.tracks.registerTrack({\n      uri,\n      title,\n      track: new EventLatencyTrack(ctx, uri, baseTable),\n    });\n\n    const track = new TrackNode({uri, title});\n    group.addChildInOrder(track);\n  }\n\n  private async addScrollJankV3ScrollTrack(\n    ctx: Trace,\n    group: TrackNode,\n  ): Promise<void> {\n    await ctx.engine.query(\n      `INCLUDE PERFETTO MODULE chrome.scroll_jank.scroll_jank_intervals`,\n    );\n\n    const uri = 'org.chromium.ChromeScrollJank#scrollJankV3';\n    const title = 'Chrome Scroll Janks';\n\n    ctx.tracks.registerTrack({\n      uri,\n      title,\n      track: new ScrollJankV3Track(ctx, uri),\n    });\n\n    const track = new TrackNode({uri, title});\n    group.addChildInOrder(track);\n  }\n\n  private addScrollTimelineTrack(ctx: Trace, group: TrackNode) {\n    const uri = 'org.chromium.ChromeScrollJank#scrollTimeline';\n    const title = 'Chrome Scroll Timeline';\n\n    ctx.tracks.registerTrack({\n      uri,\n      title,\n      track: new ScrollTimelineTrack(ctx, uri),\n    });\n\n    const track = new TrackNode({uri, title});\n    group.addChildInOrder(track);\n  }\n}\n"]}