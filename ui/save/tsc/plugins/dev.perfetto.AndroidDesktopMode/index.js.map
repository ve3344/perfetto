{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/plugins/dev.perfetto.AndroidDesktopMode/index.ts"],"names":[],"mappings":";AAAA,qDAAqD;AACrD,EAAE;AACF,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,kDAAkD;AAClD,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;;AAEjC,iFAAgF;AAGhF,sDAAiD;AAEjD,MAAM,4BAA4B,GAAG,8CAA8C,CAAC;AAEpF,MAAM,KAAK,GAAG;;;;;;;;CAQb,CAAC;AAEF,MAAM,OAAO,GAAG,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,EAAE,MAAM,CAAC,CAAC;AAC5C,MAAM,UAAU,GAAG,sBAAsB,CAAC;AAC1C,MAAM,SAAS,GAAG,kBAAkB,CAAC;AAErC;IACE,MAAM,CAAU,EAAE,GAAG,iCAAiC,CAAC;IAEvD,KAAK,CAAC,WAAW,CAAC,GAAU;QAC1B,MAAM,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,4BAA4B,CAAC,CAAC;QACrD,MAAM,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;QACrC,GAAG,CAAC,QAAQ,CAAC,eAAe,CAAC;YAC3B,EAAE,EAAE,kDAAkD;YACtD,IAAI,EAAE,aAAa,GAAG,UAAU;YAChC,QAAQ,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC;SACzC,CAAC,CAAC;IACL,CAAC;IAEO,KAAK,CAAC,aAAa,CAAC,GAAU,EAAE,GAAW;QACjD,MAAM,KAAK,GAAG,MAAM,IAAA,yCAAqB,EAAC;YACxC,KAAK,EAAE,GAAG;YACV,GAAG,EAAE,SAAS;YACd,IAAI,EAAE;gBACJ,SAAS,EAAE,GAAG;gBACd,OAAO,EAAE,OAAO;aACjB;SACF,CAAC,CAAC;QACH,GAAG,CAAC,MAAM,CAAC,aAAa,CAAC;YACvB,GAAG,EAAE,SAAS;YACd,KAAK,EAAE,UAAU;YACjB,KAAK;SACN,CAAC,CAAC;IACL,CAAC;IAEO,cAAc,CAAC,GAAU;QAC/B,MAAM,SAAS,GAAG,IAAI,qBAAS,CAAC,EAAC,GAAG,EAAE,SAAS,EAAE,KAAK,EAAE,UAAU,EAAC,CAAC,CAAC;QACrE,GAAG,CAAC,SAAS,CAAC,eAAe,CAAC,SAAS,CAAC,CAAC;QACzC,SAAS,CAAC,GAAG,EAAE,CAAC;IAClB,CAAC;;AAjCH,4BAkCC","sourcesContent":["// Copyright (C) 2024 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {createQuerySliceTrack} from '../../components/tracks/query_slice_track';\nimport {PerfettoPlugin} from '../../public/plugin';\nimport {Trace} from '../../public/trace';\nimport {TrackNode} from '../../public/workspace';\n\nconst INCLUDE_DESKTOP_MODULE_QUERY = `INCLUDE PERFETTO MODULE android.desktop_mode`;\n\nconst QUERY = `\nSELECT\n  ROW_NUMBER() OVER (ORDER BY ts) AS id,\n  ts,\n  dur,\n  ifnull(p.package_name, 'uid=' || dw.uid) AS name\nFROM android_desktop_mode_windows dw\nLEFT JOIN package_list p ON CAST (dw.uid AS INT) % 100000 = p.uid AND p.uid != 1000\n`;\n\nconst COLUMNS = ['id', 'ts', 'dur', 'name'];\nconst TRACK_NAME = 'Desktop Mode Windows';\nconst TRACK_URI = '/desktop_windows';\n\nexport default class implements PerfettoPlugin {\n  static readonly id = 'dev.perfetto.AndroidDesktopMode';\n\n  async onTraceLoad(ctx: Trace): Promise<void> {\n    await ctx.engine.query(INCLUDE_DESKTOP_MODULE_QUERY);\n    await this.registerTrack(ctx, QUERY);\n    ctx.commands.registerCommand({\n      id: 'dev.perfetto.DesktopMode#AddTrackDesktopWindowss',\n      name: 'Add Track: ' + TRACK_NAME,\n      callback: () => this.addSimpleTrack(ctx),\n    });\n  }\n\n  private async registerTrack(ctx: Trace, sql: string) {\n    const track = await createQuerySliceTrack({\n      trace: ctx,\n      uri: TRACK_URI,\n      data: {\n        sqlSource: sql,\n        columns: COLUMNS,\n      },\n    });\n    ctx.tracks.registerTrack({\n      uri: TRACK_URI,\n      title: TRACK_NAME,\n      track,\n    });\n  }\n\n  private addSimpleTrack(ctx: Trace) {\n    const trackNode = new TrackNode({uri: TRACK_URI, title: TRACK_NAME});\n    ctx.workspace.addChildInOrder(trackNode);\n    trackNode.pin();\n  }\n}\n"]}