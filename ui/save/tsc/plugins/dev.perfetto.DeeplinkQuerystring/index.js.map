{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/plugins/dev.perfetto.DeeplinkQuerystring/index.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2024 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// When deep linking into Perfetto UI it is possible to pass arguments in the\n// query string to automatically select a slice or run a query once the\n// trace is loaded. This plugin deals with kicking off the relevant logic\n// once the trace has loaded.\n\nimport {Trace} from '../../public/trace';\nimport {PerfettoPlugin} from '../../public/plugin';\nimport {addQueryResultsTab} from '../../components/query_table/query_result_tab';\nimport {Time} from '../../base/time';\nimport {RouteArgs} from '../../public/route_schema';\nimport {App} from '../../public/app';\nimport {exists} from '../../base/utils';\nimport {NUM} from '../../trace_processor/query_result';\n\nlet routeArgsForFirstTrace: RouteArgs | undefined;\n\n/**\n * Uses URL args (table, ts, dur) to select events on trace load.\n *\n * E.g. ?table=thread_state&ts=39978672284068&dur=18995809\n *\n * Note: `ts` and `dur` are used rather than id as id is not stable over TP\n * versions.\n *\n * The table passed must have `ts`, `dur` (if a dur value is supplied) and `id`\n * columns, and SQL resolvers must be available for those tables (usually from\n * plugins).\n */\nexport default class implements PerfettoPlugin {\n  static readonly id = 'dev.perfetto.DeeplinkQuerystring';\n\n  static onActivate(app: App): void {\n    routeArgsForFirstTrace = app.initialRouteArgs;\n  }\n\n  async onTraceLoad(trace: Trace) {\n    trace.onTraceReady.addListener(async () => {\n      const initialRouteArgs = routeArgsForFirstTrace;\n      routeArgsForFirstTrace = undefined;\n      if (initialRouteArgs === undefined) return;\n\n      await selectInitialRouteArgs(trace, initialRouteArgs);\n      if (\n        initialRouteArgs.visStart !== undefined &&\n        initialRouteArgs.visEnd !== undefined\n      ) {\n        zoomPendingDeeplink(\n          trace,\n          initialRouteArgs.visStart,\n          initialRouteArgs.visEnd,\n        );\n      }\n      if (initialRouteArgs.query !== undefined) {\n        addQueryResultsTab(trace, {\n          query: initialRouteArgs.query,\n          title: 'Deeplink Query',\n        });\n      }\n    });\n  }\n}\n\nfunction zoomPendingDeeplink(trace: Trace, visStart: string, visEnd: string) {\n  const visualStart = Time.fromRaw(BigInt(visStart));\n  const visualEnd = Time.fromRaw(BigInt(visEnd));\n  if (\n    !(\n      visualStart < visualEnd &&\n      trace.traceInfo.start <= visualStart &&\n      visualEnd <= trace.traceInfo.end\n    )\n  ) {\n    return;\n  }\n  trace.timeline.setViewportTime(visualStart, visualEnd);\n}\n\nasync function selectInitialRouteArgs(trace: Trace, args: RouteArgs) {\n  const {table = 'slice', ts, dur} = args;\n\n  // We need at least a ts\n  if (!exists(ts)) {\n    return;\n  }\n\n  const conditions = [];\n  conditions.push(`ts = ${ts}`);\n  exists(dur) && conditions.push(`dur = ${dur}`);\n\n  // Find the id of the slice with this ts & dur in the given table\n  const result = await trace.engine.query(`\n    select\n      id\n    from\n      ${table}\n    where ${conditions.join(' AND ')}\n  `);\n\n  if (result.numRows() === 0) {\n    return;\n  }\n\n  const {id} = result.firstRow({\n    id: NUM,\n  });\n\n  trace.selection.selectSqlEvent(table, id, {\n    scrollToSelection: true,\n    switchToCurrentSelectionTab: false,\n  });\n}\n"]}