{"version":3,"file":"query_history.js","sourceRoot":"","sources":["../../../../src/plugins/dev.perfetto.QueryPage/query_history.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2022 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {Icons} from '../../base/semantic_icons';\nimport {assertTrue} from '../../base/logging';\nimport {Icon} from '../../widgets/icon';\nimport {z} from 'zod';\nimport {Trace} from '../../public/trace';\n\nconst QUERY_HISTORY_KEY = 'queryHistory';\n\nexport interface QueryHistoryComponentAttrs {\n  trace: Trace;\n  runQuery: (query: string) => void;\n  setQuery: (query: string) => void;\n}\n\nexport class QueryHistoryComponent\n  implements m.ClassComponent<QueryHistoryComponentAttrs>\n{\n  view({attrs}: m.CVnode<QueryHistoryComponentAttrs>): m.Child {\n    const runQuery = attrs.runQuery;\n    const setQuery = attrs.setQuery;\n    const unstarred: HistoryItemComponentAttrs[] = [];\n    const starred: HistoryItemComponentAttrs[] = [];\n    for (let i = queryHistoryStorage.data.length - 1; i >= 0; i--) {\n      const entry = queryHistoryStorage.data[i];\n      const arr = entry.starred ? starred : unstarred;\n      arr.push({trace: attrs.trace, index: i, entry, runQuery, setQuery});\n    }\n    return m(\n      '.query-history',\n      m(\n        'header.overview',\n        `Query history (${queryHistoryStorage.data.length} queries)`,\n      ),\n      starred.map((attrs) => m(HistoryItemComponent, attrs)),\n      unstarred.map((attrs) => m(HistoryItemComponent, attrs)),\n    );\n  }\n}\n\nexport interface HistoryItemComponentAttrs {\n  trace: Trace;\n  index: number;\n  entry: QueryHistoryEntry;\n  runQuery: (query: string) => void;\n  setQuery: (query: string) => void;\n}\n\nexport class HistoryItemComponent\n  implements m.ClassComponent<HistoryItemComponentAttrs>\n{\n  view(vnode: m.Vnode<HistoryItemComponentAttrs>): m.Child {\n    const query = vnode.attrs.entry.query;\n    return m(\n      '.history-item',\n      m(\n        '.history-item-buttons',\n        m(\n          'button',\n          {\n            onclick: () => {\n              queryHistoryStorage.setStarred(\n                vnode.attrs.index,\n                !vnode.attrs.entry.starred,\n              );\n              vnode.attrs.trace.scheduleFullRedraw();\n            },\n          },\n          m(Icon, {icon: Icons.Star, filled: vnode.attrs.entry.starred}),\n        ),\n        m(\n          'button',\n          {\n            onclick: () => vnode.attrs.setQuery(query),\n          },\n          m(Icon, {icon: 'edit'}),\n        ),\n        m(\n          'button',\n          {\n            onclick: () => vnode.attrs.runQuery(query),\n          },\n          m(Icon, {icon: 'play_arrow'}),\n        ),\n        m(\n          'button',\n          {\n            onclick: () => {\n              queryHistoryStorage.remove(vnode.attrs.index);\n              vnode.attrs.trace.scheduleFullRedraw();\n            },\n          },\n          m(Icon, {icon: 'delete'}),\n        ),\n      ),\n      m(\n        'pre',\n        {\n          onclick: () => vnode.attrs.setQuery(query),\n          ondblclick: () => vnode.attrs.runQuery(query),\n        },\n        query,\n      ),\n    );\n  }\n}\n\nclass HistoryStorage {\n  data: QueryHistory;\n  maxItems = 50;\n\n  constructor() {\n    this.data = this.load();\n  }\n\n  saveQuery(query: string) {\n    const items = this.data;\n    let firstUnstarred = -1;\n    let countUnstarred = 0;\n    for (let i = 0; i < items.length; i++) {\n      if (!items[i].starred) {\n        countUnstarred++;\n        if (firstUnstarred === -1) {\n          firstUnstarred = i;\n        }\n      }\n\n      if (items[i].query === query) {\n        // Query is already in the history, no need to save\n        return;\n      }\n    }\n\n    if (countUnstarred >= this.maxItems) {\n      assertTrue(firstUnstarred !== -1);\n      items.splice(firstUnstarred, 1);\n    }\n\n    items.push({query, starred: false});\n    this.save();\n  }\n\n  setStarred(index: number, starred: boolean) {\n    assertTrue(index >= 0 && index < this.data.length);\n    this.data[index].starred = starred;\n    this.save();\n  }\n\n  remove(index: number) {\n    assertTrue(index >= 0 && index < this.data.length);\n    this.data.splice(index, 1);\n    this.save();\n  }\n\n  private load(): QueryHistory {\n    const value = window.localStorage.getItem(QUERY_HISTORY_KEY);\n    if (value === null) {\n      return [];\n    }\n    const res = QUERY_HISTORY_SCHEMA.safeParse(JSON.parse(value));\n    return res.success ? res.data : [];\n  }\n\n  private save() {\n    window.localStorage.setItem(QUERY_HISTORY_KEY, JSON.stringify(this.data));\n  }\n}\n\nconst QUERY_HISTORY_ENTRY_SCHEMA = z.object({\n  query: z.string(),\n  starred: z.boolean().default(false),\n});\n\ntype QueryHistoryEntry = z.infer<typeof QUERY_HISTORY_ENTRY_SCHEMA>;\n\nconst QUERY_HISTORY_SCHEMA = z.array(QUERY_HISTORY_ENTRY_SCHEMA);\n\ntype QueryHistory = z.infer<typeof QUERY_HISTORY_SCHEMA>;\n\nexport const queryHistoryStorage = new HistoryStorage();\n"]}