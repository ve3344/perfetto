{"version":3,"file":"query_page.js","sourceRoot":"","sources":["../../../../src/plugins/dev.perfetto.QueryPage/query_page.ts"],"names":[],"mappings":";AAAA,qDAAqD;AACrD,EAAE;AACF,kEAAkE;AAClE,mEAAmE;AACnE,0CAA0C;AAC1C,EAAE;AACF,kDAAkD;AAClD,EAAE;AACF,sEAAsE;AACtE,oEAAoE;AACpE,2EAA2E;AAC3E,sEAAsE;AACtE,iCAAiC;;;;AAEjC,8DAAwB;AACxB,gEAAgE;AAChE,0DAAsE;AACtE,kEAA6E;AAC7E,mDAA8C;AAC9C,iDAA4C;AAE5C,mDAA2E;AAE3E,oFAAiF;AACjF,0EAAoE;AAUpE,MAAM,KAAK,GAAmB;IAC5B,WAAW,EAAE,EAAE;IACf,QAAQ,EAAE,OAAO;IACjB,UAAU,EAAE,CAAC;CACd,CAAC;AAEF,SAAS,cAAc,CAAC,KAAY,EAAE,KAAa;IACjD,KAAK,CAAC,aAAa,GAAG,KAAK,CAAC;IAC5B,KAAK,CAAC,WAAW,GAAG,SAAS,CAAC;IAC9B,IAAA,kBAAQ,EAAC,IAAA,4CAA6B,EAAC,KAAK,CAAC,EAAE,KAAK,CAAC,MAAM,CAAC,CAAC,IAAI,CAC/D,CAAC,IAAmB,EAAE,EAAE;QACtB,IAAA,qCAAkB,EAChB,KAAK,EACL;YACE,KAAK,EAAE,KAAK;YACZ,KAAK,EAAE,kBAAkB;YACzB,kBAAkB,EAAE,IAAI;SACzB,EACD,oBAAoB,CACrB,CAAC;QACF,oEAAoE;QACpE,QAAQ;QACR,IAAI,KAAK,CAAC,aAAa,KAAK,KAAK,EAAE,CAAC;YAClC,OAAO;QACT,CAAC;QACD,KAAK,CAAC,WAAW,GAAG,IAAI,CAAC;QACzB,KAAK,CAAC,kBAAkB,EAAE,CAAC;IAC7B,CAAC,CACF,CAAC;AACJ,CAAC;AAID,MAAM,UAAU;IACN,MAAM,CAAc;IAE5B,QAAQ,CAAC,EAAC,GAAG,EAA+B;QAC1C,IAAI,CAAC,MAAM,GAAG,IAAI,sCAAoB,CAAC,GAAG,EAAE,GAAG,EAAE;YAC/C,KAAK,CAAC,QAAQ,GAAI,GAAmB,CAAC,KAAK,CAAC,MAAM,CAAC;QACrD,CAAC,CAAC,CAAC;QACF,GAAmB,CAAC,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,QAAQ,CAAC;IACrD,CAAC;IAED,QAAQ;QACN,IAAI,IAAI,CAAC,MAAM,EAAE,CAAC;YAChB,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,CAAC;YAC9B,IAAI,CAAC,MAAM,GAAG,SAAS,CAAC;QAC1B,CAAC;IACH,CAAC;IAED,IAAI,CAAC,EAAC,KAAK,EAA4B;QACrC,OAAO,IAAA,iBAAC,EAAC,eAAM,EAAE;YACf,UAAU,EAAE,KAAK,CAAC,UAAU;YAC5B,WAAW,EAAE,KAAK,CAAC,WAAW;YAE9B,SAAS,EAAE,CAAC,IAAY,EAAE,EAAE;gBAC1B,IAAI,CAAC,IAAI,EAAE,CAAC;oBACV,OAAO;gBACT,CAAC;gBACD,mCAAmB,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;gBACpC,cAAc,CAAC,KAAK,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC;YACpC,CAAC;YAED,QAAQ,EAAE,CAAC,IAAY,EAAE,EAAE;gBACzB,KAAK,CAAC,WAAW,GAAG,IAAI,CAAC;gBACzB,KAAK,CAAC,KAAK,CAAC,kBAAkB,EAAE,CAAC;YACnC,CAAC;SACF,CAAC,CAAC;IACL,CAAC;CACF;AAED,MAAa,SAAS;IACpB,IAAI,CAAC,EAAC,KAAK,EAA+B;QACxC,OAAO,IAAA,iBAAC,EACN,aAAa,EACb,IAAA,iBAAC,EAAC,iBAAO,EAAE,wCAAwC,CAAC,EACpD,KAAK,CAAC,WAAW,CAAC,QAAQ,CAAC,GAAG,CAAC;YAC7B,IAAA,iBAAC,EACC,iBAAO,EACP,EAAC,IAAI,EAAE,SAAS,EAAC,EACjB,yEAAyE;gBACvE,4EAA4E;gBAC5E,yDAAyD,CAC5D,EACH,IAAA,iBAAC,EAAC,UAAU,EAAE,KAAK,CAAC,EACpB,KAAK,CAAC,aAAa,KAAK,SAAS;YAC/B,CAAC,CAAC,IAAI;YACN,CAAC,CAAC,IAAA,iBAAC,EAAC,wBAAU,EAAE;gBACZ,KAAK,EAAE,KAAK,CAAC,KAAK;gBAClB,KAAK,EAAE,KAAK,CAAC,aAAa;gBAC1B,IAAI,EAAE,KAAK,CAAC,WAAW;gBACvB,UAAU,EAAE,KAAK;aAClB,CAAC,EACN,IAAA,iBAAC,EAAC,qCAAqB,EAAE;YACvB,KAAK,EAAE,KAAK,CAAC,KAAK;YAClB,QAAQ,EAAE,CAAC,CAAS,EAAE,EAAE,CAAC,cAAc,CAAC,KAAK,CAAC,KAAK,EAAE,CAAC,CAAC;YACvD,QAAQ,EAAE,CAAC,CAAS,EAAE,EAAE;gBACtB,KAAK,CAAC,WAAW,GAAG,CAAC,CAAC;gBACtB,KAAK,CAAC,UAAU,EAAE,CAAC;gBACnB,KAAK,CAAC,KAAK,CAAC,kBAAkB,EAAE,CAAC;YACnC,CAAC;SACF,CAAC,CACH,CAAC;IACJ,CAAC;CACF;AAjCD,8BAiCC","sourcesContent":["// Copyright (C) 2020 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {SimpleResizeObserver} from '../../base/resize_observer';\nimport {undoCommonChatAppReplacements} from '../../base/string_utils';\nimport {QueryResponse, runQuery} from '../../components/query_table/queries';\nimport {Callout} from '../../widgets/callout';\nimport {Editor} from '../../widgets/editor';\nimport {PageWithTraceAttrs} from '../../public/page';\nimport {QueryHistoryComponent, queryHistoryStorage} from './query_history';\nimport {Trace, TraceAttrs} from '../../public/trace';\nimport {addQueryResultsTab} from '../../components/query_table/query_result_tab';\nimport {QueryTable} from '../../components/query_table/query_table';\n\ninterface QueryPageState {\n  enteredText: string;\n  executedQuery?: string;\n  queryResult?: QueryResponse;\n  heightPx: string;\n  generation: number;\n}\n\nconst state: QueryPageState = {\n  enteredText: '',\n  heightPx: '100px',\n  generation: 0,\n};\n\nfunction runManualQuery(trace: Trace, query: string) {\n  state.executedQuery = query;\n  state.queryResult = undefined;\n  runQuery(undoCommonChatAppReplacements(query), trace.engine).then(\n    (resp: QueryResponse) => {\n      addQueryResultsTab(\n        trace,\n        {\n          query: query,\n          title: 'Standalone Query',\n          prefetchedResponse: resp,\n        },\n        'analyze_page_query',\n      );\n      // We might have started to execute another query. Ignore it in that\n      // case.\n      if (state.executedQuery !== query) {\n        return;\n      }\n      state.queryResult = resp;\n      trace.scheduleFullRedraw();\n    },\n  );\n}\n\nexport type QueryInputAttrs = TraceAttrs;\n\nclass QueryInput implements m.ClassComponent<QueryInputAttrs> {\n  private resize?: Disposable;\n\n  oncreate({dom}: m.CVnodeDOM<QueryInputAttrs>): void {\n    this.resize = new SimpleResizeObserver(dom, () => {\n      state.heightPx = (dom as HTMLElement).style.height;\n    });\n    (dom as HTMLElement).style.height = state.heightPx;\n  }\n\n  onremove(): void {\n    if (this.resize) {\n      this.resize[Symbol.dispose]();\n      this.resize = undefined;\n    }\n  }\n\n  view({attrs}: m.CVnode<QueryInputAttrs>) {\n    return m(Editor, {\n      generation: state.generation,\n      initialText: state.enteredText,\n\n      onExecute: (text: string) => {\n        if (!text) {\n          return;\n        }\n        queryHistoryStorage.saveQuery(text);\n        runManualQuery(attrs.trace, text);\n      },\n\n      onUpdate: (text: string) => {\n        state.enteredText = text;\n        attrs.trace.scheduleFullRedraw();\n      },\n    });\n  }\n}\n\nexport class QueryPage implements m.ClassComponent<PageWithTraceAttrs> {\n  view({attrs}: m.CVnode<PageWithTraceAttrs>) {\n    return m(\n      '.query-page',\n      m(Callout, 'Enter query and press Cmd/Ctrl + Enter'),\n      state.enteredText.includes('\"') &&\n        m(\n          Callout,\n          {icon: 'warning'},\n          `\" (double quote) character observed in query; if this is being used to ` +\n            `define a string, please use ' (single quote) instead. Using double quotes ` +\n            `can cause subtle problems which are very hard to debug.`,\n        ),\n      m(QueryInput, attrs),\n      state.executedQuery === undefined\n        ? null\n        : m(QueryTable, {\n            trace: attrs.trace,\n            query: state.executedQuery,\n            resp: state.queryResult,\n            fillParent: false,\n          }),\n      m(QueryHistoryComponent, {\n        trace: attrs.trace,\n        runQuery: (q: string) => runManualQuery(attrs.trace, q),\n        setQuery: (q: string) => {\n          state.enteredText = q;\n          state.generation++;\n          attrs.trace.scheduleFullRedraw();\n        },\n      }),\n    );\n  }\n}\n"]}