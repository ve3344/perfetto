{"version":3,"file":"chrome_settings.js","sourceRoot":"","sources":["../../../../src/plugins/dev.perfetto.RecordTrace/chrome_settings.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2022 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {DataSource} from './recordingV2/recording_interfaces_v2';\nimport {\n  RecordingState,\n  getBuiltinChromeCategoryList,\n  isChromeTarget,\n} from './state';\nimport {\n  MultiSelect,\n  MultiSelectDiff,\n  Option as MultiSelectOption,\n} from '../../widgets/multiselect';\nimport {Section} from '../../widgets/section';\nimport {CategoryGetter, CompactProbe, Toggle} from './record_widgets';\nimport {RecordingSectionAttrs} from './recording_sections';\n\nfunction extractChromeCategories(\n  dataSources: DataSource[],\n): string[] | undefined {\n  for (const dataSource of dataSources) {\n    if (dataSource.name === 'chromeCategories') {\n      return dataSource.descriptor as string[];\n    }\n  }\n  return undefined;\n}\n\nclass ChromeCategoriesSelection\n  implements m.ClassComponent<RecordingSectionAttrs>\n{\n  private recState: RecordingState;\n  private defaultCategoryOptions: MultiSelectOption[] | undefined = undefined;\n  private disabledByDefaultCategoryOptions: MultiSelectOption[] | undefined =\n    undefined;\n\n  constructor({attrs}: m.CVnode<RecordingSectionAttrs>) {\n    this.recState = attrs.recState;\n  }\n\n  private updateValue(attrs: CategoryGetter, diffs: MultiSelectDiff[]) {\n    const values = attrs.get(this.recState.recordConfig);\n    for (const diff of diffs) {\n      const value = diff.id;\n      const index = values.indexOf(value);\n      const enabled = diff.checked;\n      if (enabled && index === -1) {\n        values.push(value);\n      }\n      if (!enabled && index !== -1) {\n        values.splice(index, 1);\n      }\n    }\n  }\n\n  view({attrs}: m.CVnode<RecordingSectionAttrs>) {\n    const categoryConfigGetter: CategoryGetter = {\n      get: (cfg) => cfg.chromeCategoriesSelected,\n      set: (cfg, val) => (cfg.chromeCategoriesSelected = val),\n    };\n\n    if (\n      this.defaultCategoryOptions === undefined ||\n      this.disabledByDefaultCategoryOptions === undefined\n    ) {\n      // If we are attempting to record via the Chrome extension, we receive the\n      // list of actually supported categories via DevTools. Otherwise, we fall\n      // back to an integrated list of categories from a recent version of\n      // Chrome.\n      const enabled = new Set(\n        categoryConfigGetter.get(this.recState.recordConfig),\n      );\n      let categories =\n        attrs.recState.chromeCategories ||\n        extractChromeCategories(attrs.dataSources);\n      if (!categories || !isChromeTarget(attrs.recState.recordingTarget)) {\n        categories = getBuiltinChromeCategoryList();\n      }\n      this.defaultCategoryOptions = [];\n      this.disabledByDefaultCategoryOptions = [];\n      const disabledPrefix = 'disabled-by-default-';\n      categories.forEach((cat) => {\n        const checked = enabled.has(cat);\n\n        if (\n          cat.startsWith(disabledPrefix) &&\n          this.disabledByDefaultCategoryOptions !== undefined\n        ) {\n          this.disabledByDefaultCategoryOptions.push({\n            id: cat,\n            name: cat.replace(disabledPrefix, ''),\n            checked: checked,\n          });\n        } else if (\n          !cat.startsWith(disabledPrefix) &&\n          this.defaultCategoryOptions !== undefined\n        ) {\n          this.defaultCategoryOptions.push({\n            id: cat,\n            name: cat,\n            checked: checked,\n          });\n        }\n      });\n    }\n\n    return m(\n      'div.chrome-categories',\n      m(\n        Section,\n        {title: 'Additional Categories'},\n        m(MultiSelect, {\n          options: this.defaultCategoryOptions,\n          repeatCheckedItemsAtTop: false,\n          fixedSize: false,\n          onChange: (diffs: MultiSelectDiff[]) => {\n            diffs.forEach(({id, checked}) => {\n              if (this.defaultCategoryOptions === undefined) {\n                return;\n              }\n              for (const option of this.defaultCategoryOptions) {\n                if (option.id == id) {\n                  option.checked = checked;\n                }\n              }\n            });\n            this.updateValue(categoryConfigGetter, diffs);\n          },\n        }),\n      ),\n      m(\n        Section,\n        {title: 'High Overhead Categories'},\n        m(MultiSelect, {\n          options: this.disabledByDefaultCategoryOptions,\n          repeatCheckedItemsAtTop: false,\n          fixedSize: false,\n          onChange: (diffs: MultiSelectDiff[]) => {\n            diffs.forEach(({id, checked}) => {\n              if (this.disabledByDefaultCategoryOptions === undefined) {\n                return;\n              }\n              for (const option of this.disabledByDefaultCategoryOptions) {\n                if (option.id == id) {\n                  option.checked = checked;\n                }\n              }\n            });\n            this.updateValue(categoryConfigGetter, diffs);\n          },\n        }),\n      ),\n    );\n  }\n}\n\nexport class ChromeSettings implements m.ClassComponent<RecordingSectionAttrs> {\n  view({attrs}: m.CVnode<RecordingSectionAttrs>) {\n    const recCfg = attrs.recState.recordConfig;\n    return m(\n      `.record-section${attrs.cssClass}`,\n      CompactProbe({\n        title: 'Task scheduling',\n        setEnabled: (cfg, val) => (cfg.taskScheduling = val),\n        isEnabled: (cfg) => cfg.taskScheduling,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'IPC flows',\n        setEnabled: (cfg, val) => (cfg.ipcFlows = val),\n        isEnabled: (cfg) => cfg.ipcFlows,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'Javascript execution',\n        setEnabled: (cfg, val) => (cfg.jsExecution = val),\n        isEnabled: (cfg) => cfg.jsExecution,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'Web content rendering, layout and compositing',\n        setEnabled: (cfg, val) => (cfg.webContentRendering = val),\n        isEnabled: (cfg) => cfg.webContentRendering,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'UI rendering & surface compositing',\n        setEnabled: (cfg, val) => (cfg.uiRendering = val),\n        isEnabled: (cfg) => cfg.uiRendering,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'Input events',\n        setEnabled: (cfg, val) => (cfg.inputEvents = val),\n        isEnabled: (cfg) => cfg.inputEvents,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'Navigation & Loading',\n        setEnabled: (cfg, val) => (cfg.navigationAndLoading = val),\n        isEnabled: (cfg) => cfg.navigationAndLoading,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'Chrome Logs',\n        setEnabled: (cfg, val) => (cfg.chromeLogs = val),\n        isEnabled: (cfg) => cfg.chromeLogs,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'Audio',\n        setEnabled: (cfg, val) => (cfg.audio = val),\n        isEnabled: (cfg) => cfg.audio,\n        recCfg,\n      }),\n      CompactProbe({\n        title: 'Video',\n        setEnabled: (cfg, val) => (cfg.video = val),\n        isEnabled: (cfg) => cfg.video,\n        recCfg,\n      }),\n      m(Toggle, {\n        title: 'Remove untyped and sensitive data like URLs from the trace',\n        descr:\n          'Not recommended unless you intend to share the trace' +\n          ' with third-parties.',\n        setEnabled: (cfg, val) => (cfg.chromePrivacyFiltering = val),\n        isEnabled: (cfg) => cfg.chromePrivacyFiltering,\n        recCfg,\n      }),\n      m(ChromeCategoriesSelection, attrs),\n    );\n  }\n}\n"]}