{"version":3,"file":"error_dialog.js","sourceRoot":"","sources":["../../../src/frontend/error_dialog.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2019 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {ErrorDetails} from '../base/logging';\nimport {GcsUploader} from '../base/gcs_uploader';\nimport {raf} from '../core/raf_scheduler';\nimport {VERSION} from '../gen/perfetto_version';\nimport {getCurrentModalKey, showModal} from '../widgets/modal';\nimport {globals} from './globals';\nimport {AppImpl} from '../core/app_impl';\nimport {Router} from '../core/router';\n\nconst MODAL_KEY = 'crash_modal';\n\n// Never show more than one dialog per 10s.\nconst MIN_REPORT_PERIOD_MS = 10000;\nlet timeLastReport = 0;\n\nexport function maybeShowErrorDialog(err: ErrorDetails) {\n  const now = performance.now();\n\n  // Here we rely on the exception message from onCannotGrowMemory function\n  if (\n    err.message.includes('Cannot enlarge memory') ||\n    err.stack.some((entry) => entry.name.includes('OutOfMemoryHandler')) ||\n    err.stack.some((entry) => entry.name.includes('_emscripten_resize_heap')) ||\n    err.stack.some((entry) => entry.name.includes('sbrk')) ||\n    /^out of memory$/m.exec(err.message)\n  ) {\n    showOutOfMemoryDialog();\n    // Refresh timeLastReport to prevent a different error showing a dialog\n    timeLastReport = now;\n    return;\n  }\n\n  if (err.message.includes('Unable to claim interface')) {\n    showWebUSBError();\n    timeLastReport = now;\n    return;\n  }\n\n  if (\n    err.message.includes('A transfer error has occurred') ||\n    err.message.includes('The device was disconnected') ||\n    err.message.includes('The transfer was cancelled')\n  ) {\n    showConnectionLostError();\n    timeLastReport = now;\n    return;\n  }\n\n  if (err.message.includes('(ERR:fmt)')) {\n    showUnknownFileError();\n    return;\n  }\n\n  if (err.message.includes('(ERR:rpc_seq)')) {\n    showRpcSequencingError();\n    return;\n  }\n\n  if (err.message.includes('(ERR:ws)')) {\n    showWebsocketConnectionIssue(err.message);\n    return;\n  }\n\n  // This is only for older version of the UI and for ease of tracking across\n  // cherry-picks. Newer versions don't have this exception anymore.\n  if (err.message.includes('State hash does not match')) {\n    showNewerStateError();\n    return;\n  }\n\n  if (timeLastReport > 0 && now - timeLastReport <= MIN_REPORT_PERIOD_MS) {\n    console.log('Suppressing crash dialog, last error notified too soon.');\n    return;\n  }\n  timeLastReport = now;\n\n  // If we are already showing a crash dialog, don't overwrite it with a newer\n  // crash. Usually the first crash matters, the rest avalanching effects.\n  if (getCurrentModalKey() === MODAL_KEY) {\n    return;\n  }\n\n  showModal({\n    key: MODAL_KEY,\n    title: 'Oops, something went wrong. Please file a bug.',\n    content: () => m(ErrorDialogComponent, err),\n  });\n}\n\nclass ErrorDialogComponent implements m.ClassComponent<ErrorDetails> {\n  private traceState:\n    | 'NOT_AVAILABLE'\n    | 'NOT_UPLOADED'\n    | 'UPLOADING'\n    | 'UPLOADED';\n  private traceType: string = 'No trace loaded';\n  private traceData?: ArrayBuffer | File;\n  private traceUrl?: string;\n  private attachTrace = false;\n  private uploadStatus = '';\n  private userDescription = '';\n  private errorMessage = '';\n  private uploader?: GcsUploader;\n\n  constructor() {\n    this.traceState = 'NOT_AVAILABLE';\n    const traceSource = AppImpl.instance.trace?.traceInfo.source;\n    if (traceSource === undefined) return;\n    this.traceType = traceSource.type;\n    // If the trace is either already uploaded, or comes from a postmessage+url\n    // we don't need any re-upload.\n    if ('url' in traceSource && traceSource.url !== undefined) {\n      this.traceUrl = traceSource.url;\n      this.traceState = 'UPLOADED';\n      // The trace is already uploaded, so assume the user is fine attaching to\n      // the bugreport (this make the checkbox ticked by default).\n      this.attachTrace = true;\n      return;\n    }\n\n    // If the user is not a googler, don't even offer the option to upload it.\n    if (!globals.isInternalUser) return;\n\n    if (traceSource.type === 'FILE') {\n      this.traceState = 'NOT_UPLOADED';\n      this.traceData = traceSource.file;\n      // this.traceSize = this.traceData.size;\n    } else if (traceSource.type === 'ARRAY_BUFFER') {\n      this.traceData = traceSource.buffer;\n      // this.traceSize = this.traceData.byteLength;\n    } else {\n      return; // Can't upload HTTP+RPC.\n    }\n    this.traceState = 'NOT_UPLOADED';\n  }\n\n  view(vnode: m.Vnode<ErrorDetails>) {\n    const err = vnode.attrs;\n    let msg = `UI: ${location.protocol}//${location.host}/${VERSION}\\n\\n`;\n\n    // Append the trace stack.\n    msg += `${err.message}\\n`;\n    for (const entry of err.stack) {\n      msg += ` - ${entry.name} (${entry.location})\\n`;\n    }\n    msg += '\\n';\n\n    // Append the trace URL.\n    if (this.attachTrace && this.traceUrl) {\n      msg += `Trace: ${this.traceUrl}\\n`;\n    } else if (this.attachTrace && this.traceState === 'UPLOADING') {\n      msg += `Trace: uploading...\\n`;\n    } else {\n      msg += `Trace: not available (${this.traceType}). Provide repro steps.\\n`;\n    }\n    msg += `UA: ${navigator.userAgent}\\n`;\n    msg += `Referrer: ${document.referrer}\\n`;\n    this.errorMessage = msg;\n\n    let shareTraceSection: m.Vnode | null = null;\n    if (this.traceState !== 'NOT_AVAILABLE') {\n      shareTraceSection = m(\n        'div',\n        m(\n          'label',\n          m(`input[type=checkbox]`, {\n            checked: this.attachTrace,\n            oninput: (ev: InputEvent) => {\n              const checked = (ev.target as HTMLInputElement).checked;\n              this.onUploadCheckboxChange(checked);\n            },\n          }),\n          this.traceState === 'UPLOADING'\n            ? `Uploading trace... ${this.uploadStatus}`\n            : 'Tick to share the current trace and help debugging',\n        ), // m('label')\n        m(\n          'div.modal-small',\n          `This will upload the trace and attach a link to the bug.\n          You may leave it unchecked and attach the trace manually to the bug\n          if preferred.`,\n        ),\n      );\n    } // if (this.traceState !== 'NOT_AVAILABLE')\n\n    return [\n      m(\n        'div',\n        m('.modal-logs', msg),\n        m(\n          'span',\n          `Please provide any additional details describing\n        how the crash occurred:`,\n        ),\n        m('textarea.modal-textarea', {\n          rows: 3,\n          maxlength: 1000,\n          oninput: (ev: InputEvent) => {\n            this.userDescription = (ev.target as HTMLTextAreaElement).value;\n          },\n          onkeydown: (e: Event) => e.stopPropagation(),\n          onkeyup: (e: Event) => e.stopPropagation(),\n        }),\n        shareTraceSection,\n      ),\n      m(\n        'footer',\n        m(\n          'button.modal-btn.modal-btn-primary',\n          {onclick: () => this.fileBug(err)},\n          'File a bug (Googlers only)',\n        ),\n      ),\n    ];\n  }\n\n  private onUploadCheckboxChange(checked: boolean) {\n    raf.scheduleFullRedraw();\n    this.attachTrace = checked;\n\n    if (\n      checked &&\n      this.traceData !== undefined &&\n      this.traceState === 'NOT_UPLOADED'\n    ) {\n      this.traceState = 'UPLOADING';\n      this.uploadStatus = '';\n      const uploader = new GcsUploader(this.traceData, {\n        onProgress: () => {\n          raf.scheduleFullRedraw('force');\n          this.uploadStatus = uploader.getEtaString();\n          if (uploader.state === 'UPLOADED') {\n            this.traceState = 'UPLOADED';\n            this.traceUrl = uploader.uploadedUrl;\n          } else if (uploader.state === 'ERROR') {\n            this.traceState = 'NOT_UPLOADED';\n            this.uploadStatus = uploader.error;\n          }\n        },\n      });\n      this.uploader = uploader;\n    } else if (!checked && this.uploader) {\n      this.uploader.abort();\n    }\n  }\n\n  private fileBug(err: ErrorDetails) {\n    const errTitle = err.message.split('\\n', 1)[0].substring(0, 80);\n    let url = 'https://goto.google.com/perfetto-ui-bug';\n    url += '?title=' + encodeURIComponent(`UI Error: ${errTitle}`);\n    url += '&description=';\n    if (this.userDescription !== '') {\n      url += encodeURIComponent(\n        'User description:\\n' + this.userDescription + '\\n\\n',\n      );\n    }\n    url += encodeURIComponent(this.errorMessage);\n    // 8kb is common limit on request size so restrict links to that long:\n    url = url.substring(0, 8000);\n    window.open(url, '_blank');\n  }\n}\n\nfunction showOutOfMemoryDialog() {\n  const url =\n    'https://perfetto.dev/docs/quickstart/trace-analysis#get-trace-processor';\n\n  const tpCmd =\n    'curl -LO https://get.perfetto.dev/trace_processor\\n' +\n    'chmod +x ./trace_processor\\n' +\n    'trace_processor --httpd /path/to/trace.pftrace\\n' +\n    '# Reload the UI, it will prompt to use the HTTP+RPC interface';\n  showModal({\n    title: 'Oops! Your WASM trace processor ran out of memory',\n    content: m(\n      'div',\n      m(\n        'span',\n        'The in-memory representation of the trace is too big ' +\n          'for the browser memory limits (typically 2GB per tab).',\n      ),\n      m('br'),\n      m(\n        'span',\n        'You can work around this problem by using the trace_processor ' +\n          'native binary as an accelerator for the UI as follows:',\n      ),\n      m('br'),\n      m('br'),\n      m('.modal-bash', tpCmd),\n      m('br'),\n      m('span', 'For details see '),\n      m('a', {href: url, target: '_blank'}, url),\n    ),\n  });\n}\n\nfunction showUnknownFileError() {\n  showModal({\n    title: 'Cannot open this file',\n    content: m(\n      'div',\n      m(\n        'p',\n        \"The file opened doesn't look like a Perfetto trace or any \" +\n          'other format recognized by the Perfetto TraceProcessor.',\n      ),\n      m('p', 'Formats supported:'),\n      m(\n        'ul',\n        m('li', 'Perfetto protobuf trace'),\n        m('li', 'chrome://tracing JSON'),\n        m('li', 'Android systrace'),\n        m('li', 'Fuchsia trace'),\n        m('li', 'Ninja build log'),\n      ),\n    ),\n  });\n}\n\nfunction showWebUSBError() {\n  showModal({\n    title: 'A WebUSB error occurred',\n    content: m(\n      'div',\n      m(\n        'span',\n        `Is adb already running on the host? Run this command and\n      try again.`,\n      ),\n      m('br'),\n      m('.modal-bash', '> adb kill-server'),\n      m('br'),\n      m('span', 'For details see '),\n      m('a', {href: 'http://b/159048331', target: '_blank'}, 'b/159048331'),\n    ),\n  });\n}\n\nfunction showRpcSequencingError() {\n  showModal({\n    title: 'A TraceProcessor RPC error occurred',\n    content: m(\n      'div',\n      m('p', 'The trace processor RPC sequence ID was broken'),\n      m(\n        'p',\n        `This can happen when using a HTTP trace processor instance and\neither accidentally sharing this between multiple tabs or\nrestarting the trace processor while still in use by UI.`,\n      ),\n      m(\n        'p',\n        `Please refresh this tab and ensure that trace processor is used\nat most one tab at a time.`,\n      ),\n    ),\n  });\n}\n\nfunction showNewerStateError() {\n  showModal({\n    title: 'Cannot deserialize the permalink',\n    content: m(\n      'div',\n      m('p', \"The state hash doesn't match.\"),\n      m(\n        'p',\n        'This usually happens when the permalink is generated by a version ' +\n          'the UI that is newer than the current version, e.g., when a ' +\n          'colleague created the permalink using the Canary or Autopush ' +\n          'channel and you are trying to open it using Stable channel.',\n      ),\n      m(\n        'p',\n        'Try switching to Canary or Autopush channel from the Flags page ' +\n          ' and try again.',\n      ),\n    ),\n    buttons: [\n      {\n        text: 'Take me to the flags page',\n        primary: true,\n        action: () => Router.navigate('#!/flags/releaseChannel'),\n      },\n    ],\n  });\n}\n\nfunction showWebsocketConnectionIssue(message: string): void {\n  showModal({\n    title: 'Unable to connect to the device via websocket',\n    content: m(\n      'div',\n      m('div', 'trace_processor_shell --httpd is unreachable or crashed.'),\n      m('pre', message),\n    ),\n  });\n}\n\nfunction showConnectionLostError(): void {\n  showModal({\n    title: 'Connection with the ADB device lost',\n    content: m(\n      'div',\n      m('span', `Please connect the device again to restart the recording.`),\n      m('br'),\n    ),\n  });\n}\n"]}