{"version":3,"file":"rpc_http_dialog.js","sourceRoot":"","sources":["../../../src/frontend/rpc_http_dialog.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2018 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport protos from '../protos';\nimport {assertExists} from '../base/logging';\nimport {VERSION} from '../gen/perfetto_version';\nimport {HttpRpcEngine} from '../trace_processor/http_rpc_engine';\nimport {showModal} from '../widgets/modal';\nimport {AppImpl} from '../core/app_impl';\n\nconst CURRENT_API_VERSION =\n  protos.TraceProcessorApiVersion.TRACE_PROCESSOR_CURRENT_API_VERSION;\n\nfunction getPromptMessage(tpStatus: protos.StatusResult): string {\n  return `Trace Processor detected on ${HttpRpcEngine.hostAndPort} with:\n${tpStatus.loadedTraceName}\n\nYES, use loaded trace:\nWill load from the current state of Trace Processor. If you did run\ntrace_processor_shell --httpd file.pftrace this is likely what you want.\n\nYES, but reset state:\nUse this if you want to open another trace but still use the\naccelerator. This is the equivalent of killing and restarting\ntrace_processor_shell --httpd.\n\nNO, Use builtin WASM:\nWill not use the accelerator in this tab.\n\nUsing the native accelerator has some minor caveats:\n- Only one tab can be using the accelerator.\n- Sharing, downloading and conversion-to-legacy aren't supported.\n`;\n}\n\nfunction getIncompatibleRpcMessage(tpStatus: protos.StatusResult): string {\n  return `The Trace Processor instance on ${HttpRpcEngine.hostAndPort} is too old.\n\nThis UI requires TraceProcessor features that are not present in the\nTrace Processor native accelerator you are currently running.\nIf you continue, this is almost surely going to cause UI failures.\n\nPlease update your local Trace Processor binary:\n\ncurl -LO https://get.perfetto.dev/trace_processor\nchmod +x ./trace_processor\n./trace_processor --httpd\n\nUI version code: ${VERSION}\nUI RPC API: ${CURRENT_API_VERSION}\n\nTrace processor version: ${tpStatus.humanReadableVersion}\nTrace processor version code: ${tpStatus.versionCode}\nTrace processor RPC API: ${tpStatus.apiVersion}\n`;\n}\n\nfunction getVersionMismatchMessage(tpStatus: protos.StatusResult): string {\n  return `The Trace Processor instance on ${HttpRpcEngine.hostAndPort} is a different build from the UI.\n\nThis may cause problems. Where possible it is better to use the matched version of the UI.\nYou can do this by clicking the button below.\n\nUI version code: ${VERSION}\nUI RPC API: ${CURRENT_API_VERSION}\n\nTrace processor version: ${tpStatus.humanReadableVersion}\nTrace processor version code: ${tpStatus.versionCode}\nTrace processor RPC API: ${tpStatus.apiVersion}\n`;\n}\n\n// The flow is fairly complicated:\n// +-----------------------------------+\n// |        User loads the UI          |\n// +-----------------+-----------------+\n//                   |\n// +-----------------+-----------------+\n// |   Is trace_processor present at   |\n// |   HttpRpcEngine.hostAndPort?      |\n// +--------------------------+--------+\n//    |No                     |Yes\n//    |        +--------------+-------------------------------+\n//    |        |  Does version code of UI and TP match?       |\n//    |        +--------------+----------------------------+--+\n//    |                       |No                          |Yes\n//    |                       |                            |\n//    |                       |                            |\n//    |         +-------------+-------------+              |\n//    |         |Is a build of the UI at the|              |\n//    |         |TP version code existant   |              |\n//    |         |and reachable?             |              |\n//    |         +---+----------------+------+              |\n//    |             | No             | Yes                 |\n//    |             |                |                     |\n//    |             |       +--------+-------+             |\n//    |             |       |Dialog: Mismatch|             |\n//    |             |       |Load matched UI +-------------------------------+\n//    |             |       |Continue        +-+           |                 |\n//    |             |       +----------------+ |           |                 |\n//    |             |                          |           |                 |\n//    |      +------+--------------------------+----+      |                 |\n//    |      |TP RPC version >= UI RPC version      |      |                 |\n//    |      +----+-------------------+-------------+      |                 |\n//    |           | No                |Yes                 |                 |\n//    |      +----+--------------+    |                    |                 |\n//    |      |Dialog: Bad RPC    |    |                    |                 |\n//    |  +---+Use built-in WASM  |    |                    |                 |\n//    |  |   |Continue anyway    +----|                    |                 |\n//    |  |   +-------------------+    |        +-----------+-----------+     |\n//    |  |                            +--------+TP has preloaded trace?|     |\n//    |  |                                     +-+---------------+-----+     |\n//    |  |                                       |No             |Yes        |\n//    |  |                                       |  +---------------------+  |\n//    |  |                                       |  | Dialog: Preloaded?  |  |\n//    |  |                                       |  + YES, use loaded trace  |\n//    |  |                                 +--------| YES, but reset state|  |\n//    |  |  +---------------------------------------| NO, Use builtin Wasm|  |\n//    |  |  |                              |     |  +---------------------+  |\n//    |  |  |                              |     |                           |\n//    |  |  |                           Reset TP |                           |\n//    |  |  |                              |     |                           |\n//    |  |  |                              |     |                           |\n//  Show the UI                         Show the UI                  Link to\n//  (WASM mode)                         (RPC mode)                   matched UI\n\n// There are three options in the end:\n// - Show the UI (WASM mode)\n// - Show the UI (RPC mode)\n// - Redirect to a matched version of the UI\n\n// Try to connect to the external Trace Processor HTTP RPC accelerator (if\n// available, often it isn't). If connected it will populate the\n// |httpRpcState| in the frontend local state. In turn that will show the UI\n// chip in the sidebar. trace_controller.ts will repeat this check before\n// trying to load a new trace. We do this ahead of time just to have a\n// consistent UX (i.e. so that the user can tell if the RPC is working without\n// having to open a trace).\nexport async function CheckHttpRpcConnection(): Promise<void> {\n  const state = await HttpRpcEngine.checkConnection();\n  AppImpl.instance.httpRpc.httpRpcAvailable = state.connected;\n  if (!state.connected) {\n    // No RPC = exit immediately to the WASM UI.\n    return;\n  }\n  const tpStatus = assertExists(state.status);\n\n  function forceWasm() {\n    AppImpl.instance.httpRpc.newEngineMode = 'FORCE_BUILTIN_WASM';\n  }\n\n  // Check short version:\n  if (tpStatus.versionCode !== '' && tpStatus.versionCode !== VERSION) {\n    const url = await isVersionAvailable(tpStatus.versionCode);\n    if (url !== undefined) {\n      // If matched UI available show a dialog asking the user to\n      // switch.\n      const result = await showDialogVersionMismatch(tpStatus, url);\n      switch (result) {\n        case MismatchedVersionDialog.Dismissed:\n        case MismatchedVersionDialog.UseMatchingUi:\n          navigateToVersion(tpStatus.versionCode);\n          return;\n        case MismatchedVersionDialog.UseMismatchedRpc:\n          break;\n        case MismatchedVersionDialog.UseWasm:\n          forceWasm();\n          return;\n        default:\n          const x: never = result;\n          throw new Error(`Unsupported result ${x}`);\n      }\n    }\n  }\n\n  // Check the RPC version:\n  if (tpStatus.apiVersion < CURRENT_API_VERSION) {\n    const result = await showDialogIncompatibleRPC(tpStatus);\n    switch (result) {\n      case IncompatibleRpcDialogResult.Dismissed:\n      case IncompatibleRpcDialogResult.UseWasm:\n        forceWasm();\n        return;\n      case IncompatibleRpcDialogResult.UseIncompatibleRpc:\n        break;\n      default:\n        const x: never = result;\n        throw new Error(`Unsupported result ${x}`);\n    }\n  }\n\n  // Check if pre-loaded:\n  if (tpStatus.loadedTraceName) {\n    // If a trace is already loaded in the trace processor (e.g., the user\n    // launched trace_processor_shell -D trace_file.pftrace), prompt the user to\n    // initialize the UI with the already-loaded trace.\n    const result = await showDialogToUsePreloadedTrace(tpStatus);\n    switch (result) {\n      case PreloadedDialogResult.Dismissed:\n      case PreloadedDialogResult.UseRpcWithPreloadedTrace:\n        AppImpl.instance.openTraceFromHttpRpc();\n        return;\n      case PreloadedDialogResult.UseRpc:\n        // Resetting state is the default.\n        return;\n      case PreloadedDialogResult.UseWasm:\n        forceWasm();\n        return;\n      default:\n        const x: never = result;\n        throw new Error(`Unsupported result ${x}`);\n    }\n  }\n}\n\nenum MismatchedVersionDialog {\n  UseMatchingUi = 'useMatchingUi',\n  UseWasm = 'useWasm',\n  UseMismatchedRpc = 'useMismatchedRpc',\n  Dismissed = 'dismissed',\n}\n\nasync function showDialogVersionMismatch(\n  tpStatus: protos.StatusResult,\n  url: string,\n): Promise<MismatchedVersionDialog> {\n  let result = MismatchedVersionDialog.Dismissed;\n  await showModal({\n    title: 'Version mismatch',\n    content: m('.modal-pre', getVersionMismatchMessage(tpStatus)),\n    buttons: [\n      {\n        primary: true,\n        text: `Open ${url}`,\n        action: () => {\n          result = MismatchedVersionDialog.UseMatchingUi;\n        },\n      },\n      {\n        text: 'Use builtin Wasm',\n        action: () => {\n          result = MismatchedVersionDialog.UseWasm;\n        },\n      },\n      {\n        text: 'Use mismatched version regardless (might crash)',\n        action: () => {\n          result = MismatchedVersionDialog.UseMismatchedRpc;\n        },\n      },\n    ],\n  });\n  return result;\n}\n\nenum IncompatibleRpcDialogResult {\n  UseWasm = 'useWasm',\n  UseIncompatibleRpc = 'useIncompatibleRpc',\n  Dismissed = 'dismissed',\n}\n\nasync function showDialogIncompatibleRPC(\n  tpStatus: protos.StatusResult,\n): Promise<IncompatibleRpcDialogResult> {\n  let result = IncompatibleRpcDialogResult.Dismissed;\n  await showModal({\n    title: 'Incompatible RPC version',\n    content: m('.modal-pre', getIncompatibleRpcMessage(tpStatus)),\n    buttons: [\n      {\n        text: 'Use builtin Wasm',\n        primary: true,\n        action: () => {\n          result = IncompatibleRpcDialogResult.UseWasm;\n        },\n      },\n      {\n        text: 'Use old version regardless (will crash)',\n        action: () => {\n          result = IncompatibleRpcDialogResult.UseIncompatibleRpc;\n        },\n      },\n    ],\n  });\n  return result;\n}\n\nenum PreloadedDialogResult {\n  UseRpcWithPreloadedTrace = 'useRpcWithPreloadedTrace',\n  UseRpc = 'useRpc',\n  UseWasm = 'useWasm',\n  Dismissed = 'dismissed',\n}\n\nasync function showDialogToUsePreloadedTrace(\n  tpStatus: protos.StatusResult,\n): Promise<PreloadedDialogResult> {\n  let result = PreloadedDialogResult.Dismissed;\n  await showModal({\n    title: 'Use trace processor native acceleration?',\n    content: m('.modal-pre', getPromptMessage(tpStatus)),\n    buttons: [\n      {\n        text: 'YES, use loaded trace',\n        primary: true,\n        action: () => {\n          result = PreloadedDialogResult.UseRpcWithPreloadedTrace;\n        },\n      },\n      {\n        text: 'YES, but reset state',\n        action: () => {\n          result = PreloadedDialogResult.UseRpc;\n        },\n      },\n      {\n        text: 'NO, Use builtin WASM',\n        action: () => {\n          result = PreloadedDialogResult.UseWasm;\n        },\n      },\n    ],\n  });\n  return result;\n}\n\nfunction getUrlForVersion(versionCode: string): string {\n  const url = `${window.location.origin}/${versionCode}/`;\n  return url;\n}\n\nasync function isVersionAvailable(\n  versionCode: string,\n): Promise<string | undefined> {\n  if (versionCode === '') {\n    return undefined;\n  }\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 1000);\n  const url = getUrlForVersion(versionCode);\n  let r;\n  try {\n    r = await fetch(url, {signal: controller.signal});\n  } catch (e) {\n    console.error(\n      `No UI version for ${versionCode} at ${url}. ` +\n        `This is an error if ${versionCode} is a released Perfetto version`,\n    );\n    return undefined;\n  } finally {\n    clearTimeout(timeoutId);\n  }\n  if (!r.ok) {\n    return undefined;\n  }\n  return url;\n}\n\nfunction navigateToVersion(versionCode: string): void {\n  const url = getUrlForVersion(versionCode);\n  if (url === undefined) {\n    throw new Error(`No URL known for UI version ${versionCode}.`);\n  }\n  window.location.replace(url);\n}\n"]}