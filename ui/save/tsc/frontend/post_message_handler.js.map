{"version":3,"file":"post_message_handler.js","sourceRoot":"","sources":["../../../src/frontend/post_message_handler.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2019 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {Time} from '../base/time';\nimport {PostedTrace} from '../core/trace_source';\nimport {showModal} from '../widgets/modal';\nimport {initCssConstants} from './css_constants';\nimport {toggleHelp} from './help_modal';\nimport {scrollTo} from '../public/scroll_helper';\nimport {AppImpl} from '../core/app_impl';\n\nconst TRUSTED_ORIGINS_KEY = 'trustedOrigins';\n\ninterface PostedTraceWrapped {\n  perfetto: PostedTrace;\n}\n\ninterface PostedScrollToRangeWrapped {\n  perfetto: PostedScrollToRange;\n}\n\ninterface PostedScrollToRange {\n  timeStart: number;\n  timeEnd: number;\n  viewPercentage?: number;\n}\n\n// Returns whether incoming traces should be opened automatically or should\n// instead require a user interaction.\nexport function isTrustedOrigin(origin: string): boolean {\n  const TRUSTED_ORIGINS = [\n    'https://chrometto.googleplex.com',\n    'https://uma.googleplex.com',\n    'https://android-build.googleplex.com',\n  ];\n  if (origin === window.origin) return true;\n  if (origin === 'null') return false;\n  if (TRUSTED_ORIGINS.includes(origin)) return true;\n  if (isUserTrustedOrigin(origin)) return true;\n\n  const hostname = new URL(origin).hostname;\n  if (hostname.endsWith('.corp.google.com')) return true;\n  if (hostname.endsWith('.c.googlers.com')) return true;\n  if (\n    hostname === 'localhost' ||\n    hostname === '127.0.0.1' ||\n    hostname === '[::1]'\n  ) {\n    return true;\n  }\n  return false;\n}\n\n// Returns whether the user saved this as an always-trusted origin.\nfunction isUserTrustedOrigin(hostname: string): boolean {\n  const trustedOrigins = window.localStorage.getItem(TRUSTED_ORIGINS_KEY);\n  if (trustedOrigins === null) return false;\n  try {\n    return JSON.parse(trustedOrigins).includes(hostname);\n  } catch {\n    return false;\n  }\n}\n\n// Saves the given hostname as a trusted origin.\n// This is used for user convenience: if it fails for any reason, it's not a\n// big deal.\nfunction saveUserTrustedOrigin(hostname: string) {\n  const s = window.localStorage.getItem(TRUSTED_ORIGINS_KEY);\n  let origins: string[];\n  try {\n    origins = JSON.parse(s ?? '[]');\n    if (origins.includes(hostname)) return;\n    origins.push(hostname);\n    window.localStorage.setItem(TRUSTED_ORIGINS_KEY, JSON.stringify(origins));\n  } catch (e) {\n    console.warn('unable to save trusted origins to localStorage', e);\n  }\n}\n\n// Returns whether we should ignore a given message based on the value of\n// the 'perfettoIgnore' field in the event data.\nfunction shouldGracefullyIgnoreMessage(messageEvent: MessageEvent) {\n  return messageEvent.data.perfettoIgnore === true;\n}\n\n// The message handler supports loading traces from an ArrayBuffer.\n// There is no other requirement than sending the ArrayBuffer as the |data|\n// property. However, since this will happen across different origins, it is not\n// possible for the source website to inspect whether the message handler is\n// ready, so the message handler always replies to a 'PING' message with 'PONG',\n// which indicates it is ready to receive a trace.\nexport function postMessageHandler(messageEvent: MessageEvent) {\n  if (shouldGracefullyIgnoreMessage(messageEvent)) {\n    // This message should not be handled in this handler,\n    // because it will be handled elsewhere.\n    return;\n  }\n\n  if (messageEvent.origin === 'https://tagassistant.google.com') {\n    // The GA debugger, does a window.open() and sends messages to the GA\n    // script. Ignore them.\n    return;\n  }\n\n  if (document.readyState !== 'complete') {\n    console.error('Ignoring message - document not ready yet.');\n    return;\n  }\n\n  const fromOpener = messageEvent.source === window.opener;\n  const fromIframeHost = messageEvent.source === window.parent;\n  // This adds support for the folowing flow:\n  // * A (page that whats to open a trace in perfetto) opens B\n  // * B (does something to get the traceBuffer)\n  // * A is navigated to Perfetto UI\n  // * B sends the traceBuffer to A\n  // * closes itself\n  const fromOpenee = (messageEvent.source as WindowProxy).opener === window;\n\n  if (\n    messageEvent.source === null ||\n    !(fromOpener || fromIframeHost || fromOpenee)\n  ) {\n    // This can happen if an extension tries to postMessage.\n    return;\n  }\n\n  if (!('data' in messageEvent)) {\n    throw new Error('Incoming message has no data property');\n  }\n\n  if (messageEvent.data === 'PING') {\n    // Cross-origin messaging means we can't read |messageEvent.source|, but\n    // it still needs to be of the correct type to be able to invoke the\n    // correct version of postMessage(...).\n    const windowSource = messageEvent.source as Window;\n\n    // Use '*' for the reply because in cases of cross-domain isolation, we\n    // see the messageEvent.origin as 'null'. PONG doen't disclose any\n    // interesting information, so there is no harm sending that to the wrong\n    // origin in the worst case.\n    windowSource.postMessage('PONG', '*');\n    return;\n  }\n\n  if (messageEvent.data === 'SHOW-HELP') {\n    toggleHelp();\n    return;\n  }\n\n  if (messageEvent.data === 'RELOAD-CSS-CONSTANTS') {\n    initCssConstants();\n    return;\n  }\n\n  let postedScrollToRange: PostedScrollToRange;\n  if (isPostedScrollToRange(messageEvent.data)) {\n    postedScrollToRange = messageEvent.data.perfetto;\n    scrollToTimeRange(postedScrollToRange);\n    return;\n  }\n\n  let postedTrace: PostedTrace;\n  let keepApiOpen = false;\n  if (isPostedTraceWrapped(messageEvent.data)) {\n    postedTrace = sanitizePostedTrace(messageEvent.data.perfetto);\n    if (postedTrace.keepApiOpen) {\n      keepApiOpen = true;\n    }\n  } else if (messageEvent.data instanceof ArrayBuffer) {\n    postedTrace = {title: 'External trace', buffer: messageEvent.data};\n  } else {\n    console.warn(\n      'Unknown postMessage() event received. If you are trying to open a ' +\n        'trace via postMessage(), this is a bug in your code. If not, this ' +\n        'could be due to some Chrome extension.',\n    );\n    console.log('origin:', messageEvent.origin, 'data:', messageEvent.data);\n    return;\n  }\n\n  if (postedTrace.buffer.byteLength === 0) {\n    throw new Error('Incoming message trace buffer is empty');\n  }\n\n  if (!keepApiOpen) {\n    /* Removing this event listener to avoid callers posting the trace multiple\n     * times. If the callers add an event listener which upon receiving 'PONG'\n     * posts the trace to ui.perfetto.dev, the callers can receive multiple\n     * 'PONG' messages and accidentally post the trace multiple times. This was\n     * part of the cause of b/182502595.\n     */\n    window.removeEventListener('message', postMessageHandler);\n  }\n\n  const openTrace = () => {\n    // For external traces, we need to disable other features such as\n    // downloading and sharing a trace.\n    postedTrace.localOnly = true;\n    AppImpl.instance.openTraceFromBuffer(postedTrace);\n  };\n\n  const trustAndOpenTrace = () => {\n    saveUserTrustedOrigin(messageEvent.origin);\n    openTrace();\n  };\n\n  // If the origin is trusted open the trace directly.\n  if (isTrustedOrigin(messageEvent.origin)) {\n    openTrace();\n    return;\n  }\n\n  // If not ask the user if they expect this and trust the origin.\n  let originTxt = messageEvent.origin;\n  let originUnknown = false;\n  if (originTxt === 'null') {\n    originTxt = 'An unknown origin';\n    originUnknown = true;\n  }\n  showModal({\n    title: 'Open trace?',\n    content: m(\n      'div',\n      m('div', `${originTxt} is trying to open a trace file.`),\n      m('div', 'Do you trust the origin and want to proceed?'),\n    ),\n    buttons: [\n      {text: 'No', primary: true},\n      {text: 'Yes', primary: false, action: openTrace},\n    ].concat(\n      originUnknown\n        ? []\n        : {text: 'Always trust', primary: false, action: trustAndOpenTrace},\n    ),\n  });\n}\n\nfunction sanitizePostedTrace(postedTrace: PostedTrace): PostedTrace {\n  const result: PostedTrace = {\n    title: sanitizeString(postedTrace.title),\n    buffer: postedTrace.buffer,\n    keepApiOpen: postedTrace.keepApiOpen,\n  };\n  if (postedTrace.url !== undefined) {\n    result.url = sanitizeString(postedTrace.url);\n  }\n  result.pluginArgs = postedTrace.pluginArgs;\n  return result;\n}\n\nfunction sanitizeString(str: string): string {\n  return str.replace(/[^A-Za-z0-9.\\-_#:/?=&;%+$ ]/g, ' ');\n}\n\nconst _maxScrollToRangeAttempts = 20;\nasync function scrollToTimeRange(\n  postedScrollToRange: PostedScrollToRange,\n  maxAttempts?: number,\n) {\n  const ready = AppImpl.instance.trace && !AppImpl.instance.isLoadingTrace;\n  if (!ready) {\n    if (maxAttempts === undefined) {\n      maxAttempts = 0;\n    }\n    if (maxAttempts > _maxScrollToRangeAttempts) {\n      console.warn('Could not scroll to time range. Trace viewer not ready.');\n      return;\n    }\n    setTimeout(scrollToTimeRange, 200, postedScrollToRange, maxAttempts + 1);\n  } else {\n    const start = Time.fromSeconds(postedScrollToRange.timeStart);\n    const end = Time.fromSeconds(postedScrollToRange.timeEnd);\n    scrollTo({\n      time: {start, end, viewPercentage: postedScrollToRange.viewPercentage},\n    });\n  }\n}\n\nfunction isPostedScrollToRange(\n  obj: unknown,\n): obj is PostedScrollToRangeWrapped {\n  const wrapped = obj as PostedScrollToRangeWrapped;\n  if (wrapped.perfetto === undefined) {\n    return false;\n  }\n  return (\n    wrapped.perfetto.timeStart !== undefined ||\n    wrapped.perfetto.timeEnd !== undefined\n  );\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction isPostedTraceWrapped(obj: any): obj is PostedTraceWrapped {\n  const wrapped = obj as PostedTraceWrapped;\n  if (wrapped.perfetto === undefined) {\n    return false;\n  }\n  return (\n    wrapped.perfetto.buffer !== undefined &&\n    wrapped.perfetto.title !== undefined\n  );\n}\n"]}