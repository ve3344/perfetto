{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/frontend/index.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2018 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// Keep this import first.\nimport '../base/disposable_polyfill';\nimport '../base/static_initializers';\nimport NON_CORE_PLUGINS from '../gen/all_plugins';\nimport CORE_PLUGINS from '../gen/all_core_plugins';\nimport m from 'mithril';\nimport {defer} from '../base/deferred';\nimport {addErrorHandler, reportError} from '../base/logging';\nimport {featureFlags} from '../core/feature_flags';\nimport {initLiveReload} from '../core/live_reload';\nimport {raf} from '../core/raf_scheduler';\nimport {initWasm} from '../trace_processor/wasm_engine_proxy';\nimport {setScheduleFullRedraw} from '../widgets/raf';\nimport {UiMain} from './ui_main';\nimport {initCssConstants} from './css_constants';\nimport {registerDebugGlobals} from './debug';\nimport {maybeShowErrorDialog} from './error_dialog';\nimport {installFileDropHandler} from './file_drop_handler';\nimport {globals} from './globals';\nimport {HomePage} from './home_page';\nimport {postMessageHandler} from './post_message_handler';\nimport {Route, Router} from '../core/router';\nimport {CheckHttpRpcConnection} from './rpc_http_dialog';\nimport {maybeOpenTraceFromRoute} from './trace_url_handler';\nimport {ViewerPage} from './viewer_page/viewer_page';\nimport {HttpRpcEngine} from '../trace_processor/http_rpc_engine';\nimport {showModal} from '../widgets/modal';\nimport {IdleDetector} from './idle_detector';\nimport {IdleDetectorWindow} from './idle_detector_interface';\nimport {AppImpl} from '../core/app_impl';\nimport {addLegacyTableTab} from '../components/details/sql_table_tab';\nimport {configureExtensions} from '../components/extensions';\nimport {\n  addDebugCounterTrack,\n  addDebugSliceTrack,\n} from '../components/tracks/debug_tracks';\nimport {addVisualizedArgTracks} from '../components/tracks/visualized_args_tracks';\nimport {addQueryResultsTab} from '../components/query_table/query_result_tab';\nimport {assetSrc, initAssets} from '../base/assets';\n\nconst CSP_WS_PERMISSIVE_PORT = featureFlags.register({\n  id: 'cspAllowAnyWebsocketPort',\n  name: 'Relax Content Security Policy for 127.0.0.1:*',\n  description:\n    'Allows simultaneous usage of several trace_processor_shell ' +\n    '-D --http-port 1234 by opening ' +\n    'https://ui.perfetto.dev/#!/?rpc_port=1234',\n  defaultValue: false,\n});\n\nfunction routeChange(route: Route) {\n  raf.scheduleFullRedraw('force', () => {\n    if (route.fragment) {\n      // This needs to happen after the next redraw call. It's not enough\n      // to use setTimeout(..., 0); since that may occur before the\n      // redraw scheduled above.\n      const e = document.getElementById(route.fragment);\n      if (e) {\n        e.scrollIntoView();\n      }\n    }\n  });\n  maybeOpenTraceFromRoute(route);\n}\n\nfunction setupContentSecurityPolicy() {\n  // Note: self and sha-xxx must be quoted, urls data: and blob: must not.\n\n  let rpcPolicy = [\n    'http://127.0.0.1:9001', // For trace_processor_shell --httpd.\n    'ws://127.0.0.1:9001', // Ditto, for the websocket RPC.\n  ];\n  if (CSP_WS_PERMISSIVE_PORT.get()) {\n    const route = Router.parseUrl(window.location.href);\n    if (/^\\d+$/.exec(route.args.rpc_port ?? '')) {\n      rpcPolicy = [\n        `http://127.0.0.1:${route.args.rpc_port}`,\n        `ws://127.0.0.1:${route.args.rpc_port}`,\n      ];\n    }\n  }\n  const policy = {\n    'default-src': [\n      `'self'`,\n      // Google Tag Manager bootstrap.\n      `'sha256-LirUKeorCU4uRNtNzr8tlB11uy8rzrdmqHCX38JSwHY='`,\n    ],\n    'script-src': [\n      `'self'`,\n      // TODO(b/201596551): this is required for Wasm after crrev.com/c/3179051\n      // and should be replaced with 'wasm-unsafe-eval'.\n      `'unsafe-eval'`,\n      'https://*.google.com',\n      'https://*.googleusercontent.com',\n      'https://www.googletagmanager.com',\n      'https://*.google-analytics.com',\n    ],\n    'object-src': ['none'],\n    'connect-src': [\n      `'self'`,\n      'ws://127.0.0.1:8037', // For the adb websocket server.\n      'https://*.google-analytics.com',\n      'https://*.googleapis.com', // For Google Cloud Storage fetches.\n      'blob:',\n      'data:',\n    ].concat(rpcPolicy),\n    'img-src': [\n      `'self'`,\n      'data:',\n      'blob:',\n      'https://*.google-analytics.com',\n      'https://www.googletagmanager.com',\n      'https://*.googleapis.com',\n    ],\n    'style-src': [`'self'`, `'unsafe-inline'`],\n    'navigate-to': ['https://*.perfetto.dev', 'self'],\n  };\n  const meta = document.createElement('meta');\n  meta.httpEquiv = 'Content-Security-Policy';\n  let policyStr = '';\n  for (const [key, list] of Object.entries(policy)) {\n    policyStr += `${key} ${list.join(' ')}; `;\n  }\n  meta.content = policyStr;\n  document.head.appendChild(meta);\n}\n\nfunction main() {\n  // Setup content security policy before anything else.\n  setupContentSecurityPolicy();\n  initAssets();\n  AppImpl.initialize({\n    initialRouteArgs: Router.parseUrl(window.location.href).args,\n  });\n\n  // Wire up raf for widgets.\n  setScheduleFullRedraw((force?: 'force') => raf.scheduleFullRedraw(force));\n\n  // Load the css. The load is asynchronous and the CSS is not ready by the time\n  // appendChild returns.\n  const cssLoadPromise = defer<void>();\n  const css = document.createElement('link');\n  css.rel = 'stylesheet';\n  css.href = assetSrc('perfetto.css');\n  css.onload = () => cssLoadPromise.resolve();\n  css.onerror = (err) => cssLoadPromise.reject(err);\n  const favicon = document.head.querySelector('#favicon');\n  if (favicon instanceof HTMLLinkElement) {\n    favicon.href = assetSrc('assets/favicon.png');\n  }\n\n  // Load the script to detect if this is a Googler (see comments on globals.ts)\n  // and initialize GA after that (or after a timeout if something goes wrong).\n  function initAnalyticsOnScriptLoad() {\n    AppImpl.instance.analytics.initialize(globals.isInternalUser);\n  }\n  const script = document.createElement('script');\n  script.src =\n    'https://storage.cloud.google.com/perfetto-ui-internal/is_internal_user.js';\n  script.async = true;\n  script.onerror = () => initAnalyticsOnScriptLoad();\n  script.onload = () => initAnalyticsOnScriptLoad();\n  setTimeout(() => initAnalyticsOnScriptLoad(), 5000);\n\n  document.head.append(script, css);\n\n  // Route errors to both the UI bugreport dialog and Analytics (if enabled).\n  addErrorHandler(maybeShowErrorDialog);\n  addErrorHandler((e) => AppImpl.instance.analytics.logError(e));\n\n  // Add Error handlers for JS error and for uncaught exceptions in promises.\n  window.addEventListener('error', (e) => reportError(e));\n  window.addEventListener('unhandledrejection', (e) => reportError(e));\n\n  initWasm();\n  AppImpl.instance.serviceWorkerController.install();\n\n  // Put debug variables in the global scope for better debugging.\n  registerDebugGlobals();\n\n  // Prevent pinch zoom.\n  document.body.addEventListener(\n    'wheel',\n    (e: MouseEvent) => {\n      if (e.ctrlKey) e.preventDefault();\n    },\n    {passive: false},\n  );\n\n  cssLoadPromise.then(() => onCssLoaded());\n\n  if (AppImpl.instance.testingMode) {\n    document.body.classList.add('testing');\n  }\n\n  (window as {} as IdleDetectorWindow).waitForPerfettoIdle = (ms?: number) => {\n    return new IdleDetector().waitForPerfettoIdle(ms);\n  };\n}\n\nfunction onCssLoaded() {\n  initCssConstants();\n  // Clear all the contents of the initial page (e.g. the <pre> error message)\n  // And replace it with the root <main> element which will be used by mithril.\n  document.body.innerHTML = '';\n\n  const pages = AppImpl.instance.pages;\n  const traceless = true;\n  pages.registerPage({route: '/', traceless, page: HomePage});\n  pages.registerPage({route: '/viewer', page: ViewerPage});\n  const router = new Router();\n  router.onRouteChanged = routeChange;\n\n  // Mount the main mithril component. This also forces a sync render pass.\n  raf.mount(document.body, UiMain);\n\n  if (\n    (location.origin.startsWith('http://localhost:') ||\n      location.origin.startsWith('http://127.0.0.1:')) &&\n    !AppImpl.instance.embeddedMode &&\n    !AppImpl.instance.testingMode\n  ) {\n    initLiveReload();\n  }\n\n  // Will update the chip on the sidebar footer that notifies that the RPC is\n  // connected. Has no effect on the controller (which will repeat this check\n  // before creating a new engine).\n  // Don't auto-open any trace URLs until we get a response here because we may\n  // accidentially clober the state of an open trace processor instance\n  // otherwise.\n  maybeChangeRpcPortFromFragment();\n  CheckHttpRpcConnection().then(() => {\n    const route = Router.parseUrl(window.location.href);\n    if (!AppImpl.instance.embeddedMode) {\n      installFileDropHandler();\n    }\n\n    // Don't allow postMessage or opening trace from route when the user says\n    // that they want to reuse the already loaded trace in trace processor.\n    const traceSource = AppImpl.instance.trace?.traceInfo.source;\n    if (traceSource && traceSource.type === 'HTTP_RPC') {\n      return;\n    }\n\n    // Add support for opening traces from postMessage().\n    window.addEventListener('message', postMessageHandler, {passive: true});\n\n    // Handles the initial ?local_cache_key=123 or ?s=permalink or ?url=...\n    // cases.\n    routeChange(route);\n  });\n\n  // Initialize plugins, now that we are ready to go.\n  const pluginManager = AppImpl.instance.plugins;\n  CORE_PLUGINS.forEach((p) => pluginManager.registerPlugin(p));\n  NON_CORE_PLUGINS.forEach((p) => pluginManager.registerPlugin(p));\n  const route = Router.parseUrl(window.location.href);\n  const overrides = (route.args.enablePlugins ?? '').split(',');\n  pluginManager.activatePlugins(overrides);\n}\n\n// If the URL is /#!?rpc_port=1234, change the default RPC port.\n// For security reasons, this requires toggling a flag. Detect this and tell the\n// user what to do in this case.\nfunction maybeChangeRpcPortFromFragment() {\n  const route = Router.parseUrl(window.location.href);\n  if (route.args.rpc_port !== undefined) {\n    if (!CSP_WS_PERMISSIVE_PORT.get()) {\n      showModal({\n        title: 'Using a different port requires a flag change',\n        content: m(\n          'div',\n          m(\n            'span',\n            'For security reasons before connecting to a non-standard ' +\n              'TraceProcessor port you need to manually enable the flag to ' +\n              'relax the Content Security Policy and restart the UI.',\n          ),\n        ),\n        buttons: [\n          {\n            text: 'Take me to the flags page',\n            primary: true,\n            action: () => Router.navigate('#!/flags/cspAllowAnyWebsocketPort'),\n          },\n        ],\n      });\n    } else {\n      HttpRpcEngine.rpcPort = route.args.rpc_port;\n    }\n  }\n}\n\n// TODO(primiano): this injection is to break a cirular dependency. See\n// comment in sql_table_tab_interface.ts. Remove once we add an extension\n// point for context menus.\nconfigureExtensions({\n  addDebugCounterTrack,\n  addDebugSliceTrack,\n  addVisualizedArgTracks,\n  addLegacySqlTableTab: addLegacyTableTab,\n  addQueryResultsTab,\n});\n\nmain();\n"]}