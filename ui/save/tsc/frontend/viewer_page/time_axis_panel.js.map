{"version":3,"file":"time_axis_panel.js","sourceRoot":"","sources":["../../../../src/frontend/viewer_page/time_axis_panel.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2018 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use size file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {canvasClip} from '../../base/canvas_utils';\nimport {Size2D} from '../../base/geom';\nimport {assertUnreachable} from '../../base/logging';\nimport {Time, time, toISODateOnly} from '../../base/time';\nimport {TimeScale} from '../../base/time_scale';\nimport {timestampFormat} from '../../core/timestamp_format';\nimport {TimestampFormat} from '../../public/timeline';\nimport {Trace} from '../../public/trace';\nimport {TRACK_SHELL_WIDTH} from '../css_constants';\nimport {\n  generateTicks,\n  getMaxMajorTicks,\n  MIN_PX_PER_STEP,\n  TickType,\n} from './gridline_helper';\nimport {Panel} from './panel_container';\n\nexport class TimeAxisPanel implements Panel {\n  readonly kind = 'panel';\n  readonly selectable = false;\n  readonly id = 'time-axis-panel';\n\n  constructor(private readonly trace: Trace) {}\n\n  render(): m.Children {\n    return m('.time-axis-panel');\n  }\n\n  renderCanvas(ctx: CanvasRenderingContext2D, size: Size2D) {\n    ctx.fillStyle = '#999';\n    ctx.textAlign = 'left';\n    ctx.font = '11px Roboto Condensed';\n\n    this.renderOffsetTimestamp(ctx);\n\n    const trackSize = {...size, width: size.width - TRACK_SHELL_WIDTH};\n    ctx.save();\n    ctx.translate(TRACK_SHELL_WIDTH, 0);\n    canvasClip(ctx, 0, 0, trackSize.width, trackSize.height);\n    this.renderPanel(ctx, trackSize);\n    ctx.restore();\n\n    ctx.fillRect(TRACK_SHELL_WIDTH - 2, 0, 2, size.height);\n  }\n\n  private renderOffsetTimestamp(ctx: CanvasRenderingContext2D): void {\n    const offset = this.trace.timeline.timestampOffset();\n    const timestampFormat = this.trace.timeline.timestampFormat;\n    switch (timestampFormat) {\n      case TimestampFormat.TraceNs:\n      case TimestampFormat.TraceNsLocale:\n        break;\n      case TimestampFormat.Seconds:\n      case TimestampFormat.Milliseconds:\n      case TimestampFormat.Microseconds:\n      case TimestampFormat.Timecode:\n        const width = renderTimestamp(ctx, offset, 6, 10, MIN_PX_PER_STEP);\n        ctx.fillText('+', 6 + width + 2, 10, 6);\n        break;\n      case TimestampFormat.UTC:\n        const offsetDate = Time.toDate(\n          this.trace.traceInfo.utcOffset,\n          this.trace.traceInfo.realtimeOffset,\n        );\n        const dateStr = toISODateOnly(offsetDate);\n        ctx.fillText(`UTC ${dateStr}`, 6, 10);\n        break;\n      case TimestampFormat.TraceTz:\n        const offsetTzDate = Time.toDate(\n          this.trace.traceInfo.traceTzOffset,\n          this.trace.traceInfo.realtimeOffset,\n        );\n        const dateTzStr = toISODateOnly(offsetTzDate);\n        ctx.fillText(dateTzStr, 6, 10);\n        break;\n      default:\n        assertUnreachable(timestampFormat);\n    }\n  }\n\n  private renderPanel(ctx: CanvasRenderingContext2D, size: Size2D): void {\n    const visibleWindow = this.trace.timeline.visibleWindow;\n    const timescale = new TimeScale(visibleWindow, {\n      left: 0,\n      right: size.width,\n    });\n    const timespan = visibleWindow.toTimeSpan();\n    const offset = this.trace.timeline.timestampOffset();\n\n    // Draw time axis.\n    if (size.width > 0 && timespan.duration > 0n) {\n      const maxMajorTicks = getMaxMajorTicks(size.width);\n      const tickGen = generateTicks(timespan, maxMajorTicks, offset);\n      for (const {type, time} of tickGen) {\n        if (type === TickType.MAJOR) {\n          const position = Math.floor(timescale.timeToPx(time));\n          ctx.fillRect(position, 0, 1, size.height);\n          const domainTime = this.trace.timeline.toDomainTime(time);\n          renderTimestamp(ctx, domainTime, position + 5, 10, MIN_PX_PER_STEP);\n        }\n      }\n    }\n  }\n}\n\nfunction renderTimestamp(\n  ctx: CanvasRenderingContext2D,\n  time: time,\n  x: number,\n  y: number,\n  minWidth: number,\n) {\n  const fmt = timestampFormat();\n  switch (fmt) {\n    case TimestampFormat.UTC:\n    case TimestampFormat.TraceTz:\n    case TimestampFormat.Timecode:\n      return renderTimecode(ctx, time, x, y, minWidth);\n    case TimestampFormat.TraceNs:\n      return renderRawTimestamp(ctx, time.toString(), x, y, minWidth);\n    case TimestampFormat.TraceNsLocale:\n      return renderRawTimestamp(ctx, time.toLocaleString(), x, y, minWidth);\n    case TimestampFormat.Seconds:\n      return renderRawTimestamp(ctx, Time.formatSeconds(time), x, y, minWidth);\n    case TimestampFormat.Milliseconds:\n      return renderRawTimestamp(\n        ctx,\n        Time.formatMilliseconds(time),\n        x,\n        y,\n        minWidth,\n      );\n    case TimestampFormat.Microseconds:\n      return renderRawTimestamp(\n        ctx,\n        Time.formatMicroseconds(time),\n        x,\n        y,\n        minWidth,\n      );\n    default:\n      const z: never = fmt;\n      throw new Error(`Invalid timestamp ${z}`);\n  }\n}\n\n// Print a time on the canvas in raw format.\nfunction renderRawTimestamp(\n  ctx: CanvasRenderingContext2D,\n  time: string,\n  x: number,\n  y: number,\n  minWidth: number,\n) {\n  ctx.font = '11px Roboto Condensed';\n  ctx.fillText(time, x, y, minWidth);\n  return ctx.measureText(time).width;\n}\n\n// Print a timecode over 2 lines with this formatting:\n// DdHH:MM:SS\n// mmm uuu nnn\n// Returns the resultant width of the timecode.\nfunction renderTimecode(\n  ctx: CanvasRenderingContext2D,\n  time: time,\n  x: number,\n  y: number,\n  minWidth: number,\n): number {\n  const timecode = Time.toTimecode(time);\n  ctx.font = '11px Roboto Condensed';\n\n  const {dhhmmss} = timecode;\n  const thinSpace = '\\u2009';\n  const subsec = timecode.subsec(thinSpace);\n  ctx.fillText(dhhmmss, x, y, minWidth);\n  const {width: firstRowWidth} = ctx.measureText(subsec);\n\n  ctx.font = '10.5px Roboto Condensed';\n  ctx.fillText(subsec, x, y + 10, minWidth);\n  const {width: secondRowWidth} = ctx.measureText(subsec);\n\n  return Math.max(firstRowWidth, secondRowWidth);\n}\n"]}