{"version":3,"file":"pan_and_zoom_handler.js","sourceRoot":"","sources":["../../../../src/frontend/viewer_page/pan_and_zoom_handler.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2018 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {DisposableStack} from '../../base/disposable_stack';\nimport {currentTargetOffset, elementIsEditable} from '../../base/dom_utils';\nimport {DragGestureHandler} from '../../base/drag_gesture_handler';\nimport {raf} from '../../core/raf_scheduler';\nimport {Animation} from '../animation';\n\n// When first starting to pan or zoom, move at least this many units.\nconst INITIAL_PAN_STEP_PX = 50;\nconst INITIAL_ZOOM_STEP = 0.1;\n\n// The snappiness (spring constant) of pan and zoom animations [0..1].\nconst SNAP_FACTOR = 0.4;\n\n// How much the velocity of a pan or zoom animation increases per millisecond.\nconst ACCELERATION_PER_MS = 1 / 50;\n\n// The default duration of a pan or zoom animation. The animation may run longer\n// if the user keeps holding the respective button down or shorter if the button\n// is released. This value so chosen so that it is longer than the typical key\n// repeat timeout to avoid breaks in the animation.\nconst DEFAULT_ANIMATION_DURATION = 700;\n\n// The minimum number of units to pan or zoom per frame (before the\n// ACCELERATION_PER_MS multiplier is applied).\nconst ZOOM_RATIO_PER_FRAME = 0.008;\nconst KEYBOARD_PAN_PX_PER_FRAME = 8;\n\n// Scroll wheel animation steps.\nconst HORIZONTAL_WHEEL_PAN_SPEED = 1;\nconst WHEEL_ZOOM_SPEED = -0.02;\n\nconst EDITING_RANGE_CURSOR = 'ew-resize';\nconst DRAG_CURSOR = 'default';\nconst PAN_CURSOR = 'move';\n\n// Use key mapping based on the 'KeyboardEvent.code' property vs the\n// 'KeyboardEvent.key', because the former corresponds to the physical key\n// position rather than the glyph printed on top of it, and is unaffected by\n// the user's keyboard layout.\n// For example, 'KeyW' always corresponds to the key at the physical location of\n// the 'w' key on an English QWERTY keyboard, regardless of the user's keyboard\n// layout, or at least the layout they have configured in their OS.\n// Seeing as most users use the keys in the English QWERTY \"WASD\" position for\n// controlling kb+mouse applications like games, it's a good bet that these are\n// the keys most poeple are going to find natural for navigating the UI.\n// See https://www.w3.org/TR/uievents-code/#key-alphanumeric-writing-system\nexport enum KeyMapping {\n  KEY_PAN_LEFT = 'KeyA',\n  KEY_PAN_RIGHT = 'KeyD',\n  KEY_ZOOM_IN = 'KeyW',\n  KEY_ZOOM_OUT = 'KeyS',\n}\n\nenum Pan {\n  None = 0,\n  Left = -1,\n  Right = 1,\n}\nfunction keyToPan(e: KeyboardEvent): Pan {\n  if (e.code === KeyMapping.KEY_PAN_LEFT) return Pan.Left;\n  if (e.code === KeyMapping.KEY_PAN_RIGHT) return Pan.Right;\n  return Pan.None;\n}\n\nenum Zoom {\n  None = 0,\n  In = 1,\n  Out = -1,\n}\nfunction keyToZoom(e: KeyboardEvent): Zoom {\n  if (e.code === KeyMapping.KEY_ZOOM_IN) return Zoom.In;\n  if (e.code === KeyMapping.KEY_ZOOM_OUT) return Zoom.Out;\n  return Zoom.None;\n}\n\n/**\n * Enables horizontal pan and zoom with mouse-based drag and WASD navigation.\n */\nexport class PanAndZoomHandler implements Disposable {\n  private mousePositionX: number | null = null;\n  private boundOnMouseMove = this.onMouseMove.bind(this);\n  private boundOnWheel = this.onWheel.bind(this);\n  private boundOnKeyDown = this.onKeyDown.bind(this);\n  private boundOnKeyUp = this.onKeyUp.bind(this);\n  private shiftDown = false;\n  private panning: Pan = Pan.None;\n  private panOffsetPx = 0;\n  private targetPanOffsetPx = 0;\n  private zooming: Zoom = Zoom.None;\n  private zoomRatio = 0;\n  private targetZoomRatio = 0;\n  private panAnimation = new Animation(this.onPanAnimationStep.bind(this));\n  private zoomAnimation = new Animation(this.onZoomAnimationStep.bind(this));\n\n  private element: HTMLElement;\n  private onPanned: (movedPx: number) => void;\n  private onZoomed: (zoomPositionPx: number, zoomRatio: number) => void;\n  private editSelection: (currentPx: number) => boolean;\n  private onSelection: (\n    dragStartX: number,\n    dragStartY: number,\n    prevX: number,\n    currentX: number,\n    currentY: number,\n    editing: boolean,\n  ) => void;\n  private endSelection: (edit: boolean) => void;\n  private trash: DisposableStack;\n\n  constructor({\n    element,\n    onPanned,\n    onZoomed,\n    editSelection,\n    onSelection,\n    endSelection,\n  }: {\n    element: HTMLElement;\n    onPanned: (movedPx: number) => void;\n    onZoomed: (zoomPositionPx: number, zoomRatio: number) => void;\n    editSelection: (currentPx: number) => boolean;\n    onSelection: (\n      dragStartX: number,\n      dragStartY: number,\n      prevX: number,\n      currentX: number,\n      currentY: number,\n      editing: boolean,\n    ) => void;\n    endSelection: (edit: boolean) => void;\n  }) {\n    this.element = element;\n    this.onPanned = onPanned;\n    this.onZoomed = onZoomed;\n    this.editSelection = editSelection;\n    this.onSelection = onSelection;\n    this.endSelection = endSelection;\n    this.trash = new DisposableStack();\n\n    document.body.addEventListener('keydown', this.boundOnKeyDown);\n    document.body.addEventListener('keyup', this.boundOnKeyUp);\n    this.element.addEventListener('mousemove', this.boundOnMouseMove);\n    this.element.addEventListener('wheel', this.boundOnWheel, {passive: true});\n    this.trash.defer(() => {\n      this.element.removeEventListener('wheel', this.boundOnWheel);\n      this.element.removeEventListener('mousemove', this.boundOnMouseMove);\n      document.body.removeEventListener('keyup', this.boundOnKeyUp);\n      document.body.removeEventListener('keydown', this.boundOnKeyDown);\n    });\n\n    let prevX = -1;\n    let dragStartX = -1;\n    let dragStartY = -1;\n    let edit = false;\n    this.trash.use(\n      new DragGestureHandler(\n        this.element,\n        /* onDrag */ (x, y) => {\n          if (this.shiftDown) {\n            this.onPanned(prevX - x);\n          } else {\n            this.onSelection(dragStartX, dragStartY, prevX, x, y, edit);\n          }\n          prevX = x;\n        },\n        /* onDragStarted */ (x, y) => {\n          prevX = x;\n          dragStartX = x;\n          dragStartY = y;\n          edit = this.editSelection(x);\n          // Set the cursor style based on where the cursor is when the drag\n          // starts.\n          if (edit) {\n            this.element.style.cursor = EDITING_RANGE_CURSOR;\n          } else if (!this.shiftDown) {\n            this.element.style.cursor = DRAG_CURSOR;\n          }\n        },\n        /* onDragFinished */ () => {\n          // Reset the cursor now the drag has ended.\n          this.element.style.cursor = this.shiftDown ? PAN_CURSOR : DRAG_CURSOR;\n          dragStartX = -1;\n          dragStartY = -1;\n          this.endSelection(edit);\n        },\n      ),\n    );\n  }\n\n  [Symbol.dispose]() {\n    this.trash.dispose();\n  }\n\n  private onPanAnimationStep(msSinceStartOfAnimation: number) {\n    const step = (this.targetPanOffsetPx - this.panOffsetPx) * SNAP_FACTOR;\n    if (this.panning !== Pan.None) {\n      const velocity = 1 + msSinceStartOfAnimation * ACCELERATION_PER_MS;\n      // Pan at least as fast as the snapping animation to avoid a\n      // discontinuity.\n      const targetStep = Math.max(KEYBOARD_PAN_PX_PER_FRAME * velocity, step);\n      this.targetPanOffsetPx += this.panning * targetStep;\n    }\n    this.panOffsetPx += step;\n    if (Math.abs(step) > 1e-1) {\n      this.onPanned(step);\n    } else {\n      this.panAnimation.stop();\n    }\n  }\n\n  private onZoomAnimationStep(msSinceStartOfAnimation: number) {\n    if (this.mousePositionX === null) return;\n    const step = (this.targetZoomRatio - this.zoomRatio) * SNAP_FACTOR;\n    if (this.zooming !== Zoom.None) {\n      const velocity = 1 + msSinceStartOfAnimation * ACCELERATION_PER_MS;\n      // Zoom at least as fast as the snapping animation to avoid a\n      // discontinuity.\n      const targetStep = Math.max(ZOOM_RATIO_PER_FRAME * velocity, step);\n      this.targetZoomRatio += this.zooming * targetStep;\n    }\n    this.zoomRatio += step;\n    if (Math.abs(step) > 1e-6) {\n      this.onZoomed(this.mousePositionX, step);\n    } else {\n      this.zoomAnimation.stop();\n    }\n  }\n\n  private onMouseMove(e: MouseEvent) {\n    this.mousePositionX = currentTargetOffset(e).x;\n\n    // Only change the cursor when hovering, the DragGestureHandler handles\n    // changing the cursor during drag events. This avoids the problem of\n    // the cursor flickering between styles if you drag fast and get too\n    // far from the current time range.\n    if (e.buttons === 0) {\n      if (this.editSelection(this.mousePositionX)) {\n        this.element.style.cursor = EDITING_RANGE_CURSOR;\n      } else {\n        this.element.style.cursor = this.shiftDown ? PAN_CURSOR : DRAG_CURSOR;\n      }\n    }\n  }\n\n  private onWheel(e: WheelEvent) {\n    if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {\n      this.onPanned(e.deltaX * HORIZONTAL_WHEEL_PAN_SPEED);\n      raf.scheduleCanvasRedraw();\n    } else if (e.ctrlKey && this.mousePositionX !== null) {\n      const sign = e.deltaY < 0 ? -1 : 1;\n      const deltaY = sign * Math.log2(1 + Math.abs(e.deltaY));\n      this.onZoomed(this.mousePositionX, deltaY * WHEEL_ZOOM_SPEED);\n      raf.scheduleCanvasRedraw();\n    }\n  }\n\n  // Due to a bug in chrome, we get onKeyDown events fired where the payload is\n  // not a KeyboardEvent when selecting an item from an autocomplete suggestion.\n  // See https://issues.chromium.org/issues/41425904\n  // Thus, we can't assume we get an KeyboardEvent and must check manually.\n  private onKeyDown(e: Event) {\n    if (e instanceof KeyboardEvent) {\n      if (elementIsEditable(e.target)) return;\n\n      this.updateShift(e.shiftKey);\n\n      if (e.ctrlKey || e.metaKey) return;\n\n      if (keyToPan(e) !== Pan.None) {\n        if (this.panning !== keyToPan(e)) {\n          this.panAnimation.stop();\n          this.panOffsetPx = 0;\n          this.targetPanOffsetPx = keyToPan(e) * INITIAL_PAN_STEP_PX;\n        }\n        this.panning = keyToPan(e);\n        this.panAnimation.start(DEFAULT_ANIMATION_DURATION);\n      }\n\n      if (keyToZoom(e) !== Zoom.None) {\n        if (this.zooming !== keyToZoom(e)) {\n          this.zoomAnimation.stop();\n          this.zoomRatio = 0;\n          this.targetZoomRatio = keyToZoom(e) * INITIAL_ZOOM_STEP;\n        }\n        this.zooming = keyToZoom(e);\n        this.zoomAnimation.start(DEFAULT_ANIMATION_DURATION);\n      }\n    }\n  }\n\n  private onKeyUp(e: Event) {\n    if (e instanceof KeyboardEvent) {\n      this.updateShift(e.shiftKey);\n\n      if (e.ctrlKey || e.metaKey) return;\n\n      if (keyToPan(e) === this.panning) {\n        this.panning = Pan.None;\n      }\n      if (keyToZoom(e) === this.zooming) {\n        this.zooming = Zoom.None;\n      }\n    }\n  }\n\n  // TODO(hjd): Move this shift handling into the viewer page.\n  private updateShift(down: boolean) {\n    if (down === this.shiftDown) return;\n    this.shiftDown = down;\n    if (this.shiftDown) {\n      this.element.style.cursor = PAN_CURSOR;\n    } else if (this.mousePositionX !== null) {\n      this.element.style.cursor = DRAG_CURSOR;\n    }\n  }\n}\n"]}