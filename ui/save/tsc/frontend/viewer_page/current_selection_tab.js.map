{"version":3,"file":"current_selection_tab.js","sourceRoot":"","sources":["../../../../src/frontend/viewer_page/current_selection_tab.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2024 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {raf} from '../../core/raf_scheduler';\nimport {TraceImpl} from '../../core/trace_impl';\nimport {DetailsShell} from '../../widgets/details_shell';\nimport {EmptyState} from '../../widgets/empty_state';\nimport {GridLayout, GridLayoutColumn} from '../../widgets/grid_layout';\nimport {Section} from '../../widgets/section';\nimport {Tree, TreeNode} from '../../widgets/tree';\n\nexport interface CurrentSelectionTabAttrs {\n  readonly trace: TraceImpl;\n}\n\nexport class CurrentSelectionTab\n  implements m.ClassComponent<CurrentSelectionTabAttrs>\n{\n  private readonly fadeContext = new FadeContext();\n\n  view({attrs}: m.Vnode<CurrentSelectionTabAttrs>): m.Children {\n    const section = this.renderCSTabContent(attrs.trace);\n    if (section.isLoading) {\n      return m(FadeIn, section.content);\n    } else {\n      return m(FadeOut, {context: this.fadeContext}, section.content);\n    }\n  }\n\n  private renderCSTabContent(trace: TraceImpl): {\n    isLoading: boolean;\n    content: m.Children;\n  } {\n    const currentSelection = trace.selection.selection;\n\n    switch (currentSelection.kind) {\n      case 'empty':\n        return {\n          isLoading: false,\n          content: m(\n            EmptyState,\n            {\n              className: 'pf-noselection',\n              title: 'Nothing selected',\n            },\n            'Selection details will appear here',\n          ),\n        };\n      case 'track':\n        return {\n          isLoading: false,\n          content: this.renderTrackDetailsPanel(\n            trace,\n            currentSelection.trackUri,\n          ),\n        };\n      case 'track_event':\n        const detailsPanel = trace.selection.getDetailsPanelForSelection();\n        if (detailsPanel) {\n          return {\n            isLoading: detailsPanel.isLoading,\n            content: detailsPanel.render(),\n          };\n        }\n        break;\n    }\n\n    // Get the first \"truthy\" details panel\n    const panel = trace.tabs.detailsPanels\n      .map((dp) => {\n        return {\n          content: dp.render(currentSelection),\n          isLoading: dp.isLoading?.() ?? false,\n        };\n      })\n      .find(({content}) => content);\n\n    if (panel) {\n      return panel;\n    } else {\n      return {\n        isLoading: false,\n        content: m(\n          EmptyState,\n          {\n            className: 'pf-noselection',\n            title: 'No details available',\n            icon: 'warning',\n          },\n          `Selection kind: '${currentSelection.kind}'`,\n        ),\n      };\n    }\n  }\n\n  private renderTrackDetailsPanel(trace: TraceImpl, trackUri: string) {\n    const track = trace.tracks.getTrack(trackUri);\n    if (track) {\n      return m(\n        DetailsShell,\n        {title: 'Track', description: track.title},\n        m(\n          GridLayout,\n          m(\n            GridLayoutColumn,\n            m(\n              Section,\n              {title: 'Details'},\n              m(\n                Tree,\n                m(TreeNode, {left: 'Name', right: track.title}),\n                m(TreeNode, {left: 'URI', right: track.uri}),\n                m(TreeNode, {left: 'Plugin ID', right: track.pluginId}),\n                m(\n                  TreeNode,\n                  {left: 'Tags'},\n                  track.tags &&\n                    Object.entries(track.tags).map(([key, value]) => {\n                      return m(TreeNode, {left: key, right: value?.toString()});\n                    }),\n                ),\n              ),\n            ),\n          ),\n        ),\n      );\n    } else {\n      return undefined; // TODO show something sensible here\n    }\n  }\n}\n\nconst FADE_TIME_MS = 50;\n\nclass FadeContext {\n  private resolver = () => {};\n\n  putResolver(res: () => void) {\n    this.resolver = res;\n  }\n\n  resolve() {\n    this.resolver();\n    this.resolver = () => {};\n  }\n}\n\ninterface FadeOutAttrs {\n  readonly context: FadeContext;\n}\n\nclass FadeOut implements m.ClassComponent<FadeOutAttrs> {\n  onbeforeremove({attrs}: m.VnodeDOM<FadeOutAttrs>): Promise<void> {\n    return new Promise((res) => {\n      attrs.context.putResolver(res);\n      setTimeout(res, FADE_TIME_MS);\n    });\n  }\n\n  oncreate({attrs}: m.VnodeDOM<FadeOutAttrs>) {\n    attrs.context.resolve();\n  }\n\n  view(vnode: m.Vnode<FadeOutAttrs>): void | m.Children {\n    return vnode.children;\n  }\n}\n\nclass FadeIn implements m.ClassComponent {\n  private show = false;\n\n  oncreate(_: m.VnodeDOM) {\n    setTimeout(() => {\n      this.show = true;\n      raf.scheduleFullRedraw();\n    }, FADE_TIME_MS);\n  }\n\n  view(vnode: m.Vnode): m.Children {\n    return this.show ? vnode.children : undefined;\n  }\n}\n"]}