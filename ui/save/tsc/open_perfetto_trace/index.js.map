{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/open_perfetto_trace/index.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2024 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// open-perfetto-trace is a standalone JS/TS library that can be used in other\n// projects to facilitate the deep linking into perfetto. It allows opening\n// trace files or URL with ui.perfetto.dev, handling all the handshake with it.\n\nconst PERFETTO_UI_URL = 'https://ui.perfetto.dev';\n\ninterface OpenTraceOptions {\n  // If true (default) shows a popup dialog with a progress bar that informs\n  // about the status of the fetch. This is only relevant when the trace source\n  // is a url.\n  statusDialog?: boolean;\n\n  // Opens the trace in a new tab.\n  newTab?: boolean;\n\n  // Override the referrer. Useful for scripts such as\n  // record_android_trace to record where the trace is coming from.\n  referrer?: string;\n\n  // For the 'mode' of the UI. For example when the mode is 'embedded'\n  // some features are disabled.\n  mode: 'embedded' | undefined;\n\n  // Hides the sidebar in the opened perfetto UI.\n  hideSidebar?: boolean;\n\n  ts?: string;\n\n  dur?: string;\n  tid?: string;\n  pid?: string;\n  query?: string;\n  visStart?: string;\n  visEnd?: string;\n\n  // Used to override ui.perfetto.dev with a custom hosted URL.\n  // Useful for testing.\n  uiUrl?: string;\n}\n\n// Opens a trace in the Perfetto UI.\n// `source` can be either:\n// - A blob (e.g. a File).\n// - A URL.\nexport default function openPerfettoTrace(\n  source: Blob | string,\n  opts?: OpenTraceOptions,\n) {\n  if (source instanceof Blob) {\n    return openTraceBlob(source, opts);\n  } else if (typeof source === 'string') {\n    return fetchAndOpenTrace(source, opts);\n  }\n}\n\nfunction openTraceBlob(blob: Blob, opts?: OpenTraceOptions) {\n  const form = document.createElement('form');\n  form.method = 'POST';\n  form.style.visibility = 'hidden';\n  form.enctype = 'multipart/form-data';\n  const uiUrl = opts?.uiUrl ?? PERFETTO_UI_URL;\n  form.action = `${uiUrl}/_open_trace/${Date.now()}`;\n  if (opts?.newTab === true) {\n    form.target = '_blank';\n  }\n  const fileInput = document.createElement('input');\n  fileInput.name = 'trace';\n  fileInput.type = 'file';\n  const dataTransfer = new DataTransfer();\n  dataTransfer.items.add(new File([blob], 'trace.file'));\n  fileInput.files = dataTransfer.files;\n  form.appendChild(fileInput);\n  for (const [key, value] of Object.entries(opts ?? {})) {\n    const varInput = document.createElement('input');\n    varInput.type = 'hidden';\n    varInput.name = key;\n    varInput.value = value;\n    form.appendChild(varInput);\n  }\n  document.body.appendChild(form);\n  form.submit();\n}\n\nfunction fetchAndOpenTrace(url: string, opts?: OpenTraceOptions) {\n  updateProgressDiv({status: 'Fetching trace'}, opts);\n  const xhr = new XMLHttpRequest();\n  xhr.addEventListener('progress', (event) => {\n    if (event.lengthComputable) {\n      updateProgressDiv(\n        {\n          status: `Fetching trace (${Math.round(event.loaded / 1000)} KB)`,\n          progress: event.loaded / event.total,\n        },\n        opts,\n      );\n    }\n  });\n  xhr.addEventListener('loadend', () => {\n    if (xhr.readyState === 4 && xhr.status === 200) {\n      const blob = xhr.response as Blob;\n      updateProgressDiv({status: 'Opening trace'}, opts);\n      openTraceBlob(blob, opts);\n      updateProgressDiv({close: true}, opts);\n    }\n  });\n  xhr.addEventListener('error', () => {\n    updateProgressDiv({status: 'Failed to fetch trace'}, opts);\n  });\n  xhr.responseType = 'blob';\n  xhr.overrideMimeType('application/octet-stream');\n  xhr.open('GET', url);\n  xhr.send();\n}\n\ninterface ProgressDivOpts {\n  status?: string;\n  progress?: number;\n  close?: boolean;\n}\n\nfunction updateProgressDiv(progress: ProgressDivOpts, opts?: OpenTraceOptions) {\n  if (opts?.statusDialog === false) return;\n\n  const kDivId = 'open_perfetto_trace';\n  let div = document.getElementById(kDivId);\n  if (!div) {\n    div = document.createElement('div');\n    div.id = kDivId;\n    div.style.all = 'initial';\n    div.style.position = 'fixed';\n    div.style.bottom = '10px';\n    div.style.left = '0';\n    div.style.right = '0';\n    div.style.width = 'fit-content';\n    div.style.height = '20px';\n    div.style.padding = '10px';\n    div.style.zIndex = '99';\n    div.style.margin = 'auto';\n    div.style.backgroundColor = '#fff';\n    div.style.color = '#333';\n    div.style.fontFamily = 'monospace';\n    div.style.fontSize = '12px';\n    div.style.border = '1px solid #eee';\n    div.style.boxShadow = '0 0 20px #aaa';\n    div.style.display = 'flex';\n    div.style.flexDirection = 'column';\n\n    const title = document.createElement('div');\n    title.className = 'perfetto-open-title';\n    title.innerText = 'Opening perfetto trace';\n    title.style.fontWeight = '12px';\n    title.style.textAlign = 'center';\n    div.appendChild(title);\n\n    const progressbar = document.createElement('progress');\n    progressbar.className = 'perfetto-open-progress';\n    progressbar.style.width = '200px';\n    progressbar.value = 0;\n    div.appendChild(progressbar);\n\n    document.body.appendChild(div);\n  }\n  const title = div.querySelector('.perfetto-open-title') as HTMLElement;\n  if (progress.status !== undefined) {\n    title.innerText = progress.status;\n  }\n  const bar = div.querySelector('.perfetto-open-progress') as HTMLInputElement;\n  if (progress.progress === undefined) {\n    bar.style.visibility = 'hidden';\n  } else {\n    bar.style.visibility = 'visible';\n    bar.value = `${progress.progress}`;\n  }\n  if (progress.close === true) {\n    div.remove();\n  }\n}\n"]}