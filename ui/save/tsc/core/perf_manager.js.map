{"version":3,"file":"perf_manager.js","sourceRoot":"","sources":["../../../src/core/perf_manager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2018 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport m from 'mithril';\nimport {raf} from './raf_scheduler';\nimport {PerfStats, PerfStatsContainer, runningStatStr} from './perf_stats';\n\nexport class PerfManager {\n  private _enabled = false;\n  readonly containers: PerfStatsContainer[] = [];\n\n  get enabled(): boolean {\n    return this._enabled;\n  }\n\n  set enabled(enabled: boolean) {\n    this._enabled = enabled;\n    raf.setPerfStatsEnabled(true);\n    this.containers.forEach((c) => c.setPerfStatsEnabled(enabled));\n  }\n\n  addContainer(container: PerfStatsContainer): Disposable {\n    this.containers.push(container);\n    return {\n      [Symbol.dispose]: () => {\n        const i = this.containers.indexOf(container);\n        this.containers.splice(i, 1);\n      },\n    };\n  }\n\n  renderPerfStats(): m.Children {\n    if (!this._enabled) return;\n    // The rendering of the perf stats UI is atypical. The main issue is that we\n    // want to redraw the mithril component even if there is no full DOM redraw\n    // happening (and we don't want to force redraws as a side effect). So we\n    // return here just a container and handle its rendering ourselves.\n    const perfMgr = this;\n    let removed = false;\n    return m('.perf-stats', {\n      oncreate(vnode: m.VnodeDOM) {\n        const animationFrame = (dom: Element) => {\n          if (removed) return;\n          m.render(dom, m(PerfStatsUi, {perfMgr}));\n          requestAnimationFrame(() => animationFrame(dom));\n        };\n        animationFrame(vnode.dom);\n      },\n      onremove() {\n        removed = true;\n      },\n    });\n  }\n}\n\n// The mithril component that draws the contents of the perf stats box.\n\ninterface PerfStatsUiAttrs {\n  perfMgr: PerfManager;\n}\n\nclass PerfStatsUi implements m.ClassComponent<PerfStatsUiAttrs> {\n  view({attrs}: m.Vnode<PerfStatsUiAttrs>) {\n    return m(\n      '.perf-stats',\n      {},\n      m('section', this.renderRafSchedulerStats()),\n      m(\n        'button.close-button',\n        {\n          onclick: () => (attrs.perfMgr.enabled = false),\n        },\n        m('i.material-icons', 'close'),\n      ),\n      attrs.perfMgr.containers.map((c, i) =>\n        m('section', m('div', `Panel Container ${i + 1}`), c.renderPerfStats()),\n      ),\n    );\n  }\n\n  renderRafSchedulerStats() {\n    return m(\n      'div',\n      m('div', [\n        m(\n          'button',\n          {onclick: () => raf.scheduleCanvasRedraw()},\n          'Do Canvas Redraw',\n        ),\n        '   |   ',\n        m(\n          'button',\n          {onclick: () => raf.scheduleFullRedraw()},\n          'Do Full Redraw',\n        ),\n      ]),\n      m('div', 'Raf Timing ' + '(Total may not add up due to imprecision)'),\n      m(\n        'table',\n        this.statTableHeader(),\n        this.statTableRow('Actions', raf.perfStats.rafActions),\n        this.statTableRow('Dom', raf.perfStats.rafDom),\n        this.statTableRow('Canvas', raf.perfStats.rafCanvas),\n        this.statTableRow('Total', raf.perfStats.rafTotal),\n      ),\n      m(\n        'div',\n        'Dom redraw: ' +\n          `Count: ${raf.perfStats.domRedraw.count} | ` +\n          runningStatStr(raf.perfStats.domRedraw),\n      ),\n    );\n  }\n\n  statTableHeader() {\n    return m(\n      'tr',\n      m('th', ''),\n      m('th', 'Last (ms)'),\n      m('th', 'Avg (ms)'),\n      m('th', 'Avg-10 (ms)'),\n    );\n  }\n\n  statTableRow(title: string, stat: PerfStats) {\n    return m(\n      'tr',\n      m('td', title),\n      m('td', stat.last.toFixed(2)),\n      m('td', stat.mean.toFixed(2)),\n      m('td', stat.bufferMean.toFixed(2)),\n    );\n  }\n}\n"]}