{"version":3,"file":"popup.js","sourceRoot":"","sources":["../../../src/widgets/popup.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (C) 2023 The Android Open Source Project\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport {createPopper, Instance, OptionsGeneric} from '@popperjs/core';\nimport type {Modifier, StrictModifiers} from '@popperjs/core';\nimport m from 'mithril';\nimport {MountOptions, Portal, PortalAttrs} from './portal';\nimport {classNames} from '../base/classnames';\nimport {findRef, isOrContains, toHTMLElement} from '../base/dom_utils';\nimport {assertExists} from '../base/logging';\nimport {scheduleFullRedraw} from './raf';\n\ntype CustomModifier = Modifier<'sameWidth', {}>;\ntype ExtendedModifiers = StrictModifiers | CustomModifier;\n\n// Note: We could just use the Placement type from popper.js instead, which is a\n// union of string literals corresponding to the values in this enum, but having\n// the emun makes it possible to enumerate the possible options, which is a\n// feature used in the widgets page.\nexport enum PopupPosition {\n  Auto = 'auto',\n  AutoStart = 'auto-start',\n  AutoEnd = 'auto-end',\n  Top = 'top',\n  TopStart = 'top-start',\n  TopEnd = 'top-end',\n  Bottom = 'bottom',\n  BottomStart = 'bottom-start',\n  BottomEnd = 'bottom-end',\n  Right = 'right',\n  RightStart = 'right-start',\n  RightEnd = 'right-end',\n  Left = 'left',\n  LeftStart = 'left-start',\n  LeftEnd = 'left-end',\n}\n\ntype OnChangeCallback = (shouldOpen: boolean) => void;\n\nexport interface PopupAttrs {\n  // Which side of the trigger to place to popup.\n  // Defaults to \"Auto\"\n  position?: PopupPosition;\n  // The element used to open and close the popup, and the target which the near\n  // which the popup should hover.\n  // Beware this element will have its `onclick`, `ref`, and `active` attributes\n  // overwritten.\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  trigger: m.Vnode<any, any>;\n  // Close when the escape key is pressed\n  // Defaults to true.\n  closeOnEscape?: boolean;\n  // Close on mouse down somewhere other than the popup or trigger.\n  // Defaults to true.\n  closeOnOutsideClick?: boolean;\n  // Controls whether the popup is open or not.\n  // If omitted, the popup operates in uncontrolled mode.\n  isOpen?: boolean;\n  // Called when the popup isOpen state should be changed in controlled mode.\n  onChange?: OnChangeCallback;\n  // Space delimited class names applied to the popup div.\n  className?: string;\n  // Whether to show a little arrow pointing to our trigger element.\n  // Defaults to true.\n  showArrow?: boolean;\n  // Whether this popup should form a new popup group.\n  // When nesting popups, grouping controls how popups are closed.\n  // When closing popups via the Escape key, each group is closed one by one,\n  // starting at the topmost group in the stack.\n  // When using a magic button to close groups (see DISMISS_POPUP_GROUP_CLASS),\n  // only the group in which the button lives and it's children will be closed.\n  // Defaults to true.\n  createNewGroup?: boolean;\n  // Called when the popup mounts, passing the popup's dom element.\n  onPopupMount?: (dom: HTMLElement) => void;\n  // Called when the popup unmounts, padding the popup's dom element.\n  onPopupUnMount?: (dom: HTMLElement) => void;\n  // Popup matches the width of the trigger element. Default = false.\n  matchWidth?: boolean;\n  // Distance in px between the popup and its trigger. Default = 0.\n  offset?: number;\n  // Cross-axial popup offset in px. Defaults to 0.\n  // When position is *-end or *-start, this setting specifies where start and\n  // end is as an offset from the edge of the popup.\n  // Positive values move the positioning away from the edge towards the center\n  // of the popup.\n  // If position is not *-end or *-start, this setting has no effect.\n  edgeOffset?: number;\n}\n\n// A popup is a portal whose position is dynamically updated so that it floats\n// next to a trigger element. It is also styled with a nice backdrop, and\n// a little arrow pointing at the trigger element.\n// Useful for displaying things like popup menus.\nexport class Popup implements m.ClassComponent<PopupAttrs> {\n  private isOpen: boolean = false;\n  private triggerElement?: Element;\n  private popupElement?: HTMLElement;\n  private popper?: Instance;\n  private onChange: OnChangeCallback = () => {};\n  private closeOnEscape?: boolean;\n  private closeOnOutsideClick?: boolean;\n\n  private static readonly TRIGGER_REF = 'trigger';\n  private static readonly POPUP_REF = 'popup';\n  static readonly POPUP_GROUP_CLASS = 'pf-popup-group';\n\n  // Any element with this class will close its containing popup group on click\n  static readonly DISMISS_POPUP_GROUP_CLASS = 'pf-dismiss-popup-group';\n\n  view({attrs, children}: m.CVnode<PopupAttrs>): m.Children {\n    const {\n      trigger,\n      isOpen = this.isOpen,\n      onChange = () => {},\n      closeOnEscape = true,\n      closeOnOutsideClick = true,\n    } = attrs;\n\n    this.isOpen = isOpen;\n    this.onChange = onChange;\n    this.closeOnEscape = closeOnEscape;\n    this.closeOnOutsideClick = closeOnOutsideClick;\n\n    return [\n      this.renderTrigger(trigger),\n      isOpen && this.renderPopup(attrs, children),\n    ];\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  private renderTrigger(trigger: m.Vnode<any, any>): m.Children {\n    trigger.attrs = {\n      ...trigger.attrs,\n      ref: Popup.TRIGGER_REF,\n      onclick: (e: MouseEvent) => {\n        this.togglePopup();\n        e.preventDefault();\n      },\n      active: this.isOpen,\n    };\n    return trigger;\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  private renderPopup(attrs: PopupAttrs, children: any): m.Children {\n    const {\n      className,\n      showArrow = true,\n      createNewGroup = true,\n      onPopupMount = () => {},\n      onPopupUnMount = () => {},\n    } = attrs;\n\n    const portalAttrs: PortalAttrs = {\n      className: 'pf-popup-portal',\n      onBeforeContentMount: (dom: Element): MountOptions => {\n        // Check to see if dom is a descendant of a popup\n        // If so, get the popup's \"container\" and put it in there instead\n        // This handles the case where popups are placed inside the other popups\n        // we nest outselves in their containers instead of document body which\n        // means we become part of their hitbox for mouse events.\n        const closestPopup = dom.closest(`[ref=${Popup.POPUP_REF}]`);\n        return {container: closestPopup ?? undefined};\n      },\n      onContentMount: (dom: HTMLElement) => {\n        const popupElement = toHTMLElement(\n          assertExists(findRef(dom, Popup.POPUP_REF)),\n        );\n        this.popupElement = popupElement;\n        this.createOrUpdatePopper(attrs);\n        document.addEventListener('mousedown', this.handleDocMouseDown);\n        document.addEventListener('keydown', this.handleDocKeyPress);\n        dom.addEventListener('click', this.handleContentClick);\n        onPopupMount(popupElement);\n      },\n      onContentUpdate: () => {\n        // The content inside the portal has updated, so we call popper to\n        // recompute the popup's position, in case it has changed size.\n        this.popper && this.popper.update();\n      },\n      onContentUnmount: (dom: HTMLElement) => {\n        if (this.popupElement) {\n          onPopupUnMount(this.popupElement);\n        }\n        dom.removeEventListener('click', this.handleContentClick);\n        document.removeEventListener('keydown', this.handleDocKeyPress);\n        document.removeEventListener('mousedown', this.handleDocMouseDown);\n        this.popper && this.popper.destroy();\n        this.popper = undefined;\n        this.popupElement = undefined;\n      },\n    };\n\n    return m(\n      Portal,\n      portalAttrs,\n      m(\n        '.pf-popup',\n        {\n          class: classNames(\n            className,\n            createNewGroup && Popup.POPUP_GROUP_CLASS,\n          ),\n          ref: Popup.POPUP_REF,\n        },\n        showArrow && m('.pf-popup-arrow[data-popper-arrow]'),\n        m('.pf-popup-content', children),\n      ),\n    );\n  }\n\n  oncreate({dom}: m.VnodeDOM<PopupAttrs, this>) {\n    this.triggerElement = assertExists(findRef(dom, Popup.TRIGGER_REF));\n  }\n\n  onupdate({attrs}: m.VnodeDOM<PopupAttrs, this>) {\n    // We might have some new popper options, or the trigger might have changed\n    // size, so we call popper to recompute the popup's position.\n    this.createOrUpdatePopper(attrs);\n  }\n\n  onremove(_: m.VnodeDOM<PopupAttrs, this>) {\n    this.triggerElement = undefined;\n  }\n\n  private createOrUpdatePopper(attrs: PopupAttrs) {\n    const {\n      position = PopupPosition.Auto,\n      showArrow = true,\n      matchWidth = false,\n      offset = 0,\n      edgeOffset = 0,\n    } = attrs;\n\n    let matchWidthModifier: Modifier<'sameWidth', {}>[];\n    if (matchWidth) {\n      matchWidthModifier = [\n        {\n          name: 'sameWidth',\n          enabled: true,\n          phase: 'beforeWrite',\n          requires: ['computeStyles'],\n          fn: ({state}) => {\n            state.styles.popper.width = `${state.rects.reference.width}px`;\n          },\n          effect: ({state}) => {\n            const trigger = state.elements.reference as HTMLElement;\n            state.elements.popper.style.width = `${trigger.offsetWidth}px`;\n          },\n        },\n      ];\n    } else {\n      matchWidthModifier = [];\n    }\n\n    const options: Partial<OptionsGeneric<ExtendedModifiers>> = {\n      placement: position,\n      modifiers: [\n        // Move the popup away from the target allowing room for the arrow\n        {\n          name: 'offset',\n          options: {\n            offset: ({placement}) => {\n              let skid = 0;\n              if (placement.includes('-end')) {\n                skid = edgeOffset;\n              } else if (placement.includes('-start')) {\n                skid = -edgeOffset;\n              }\n              return [skid, showArrow ? offset + 8 : offset];\n            },\n          },\n        },\n        // Don't let the popup touch the edge of the viewport\n        {name: 'preventOverflow', options: {padding: 8}},\n        // Don't let the arrow reach the end of the popup, which looks odd when\n        // the popup has rounded corners\n        {name: 'arrow', options: {padding: 2}},\n        ...matchWidthModifier,\n      ],\n    };\n\n    if (this.popper) {\n      this.popper.setOptions(options);\n    } else {\n      if (this.popupElement && this.triggerElement) {\n        this.popper = createPopper<ExtendedModifiers>(\n          this.triggerElement,\n          this.popupElement,\n          options,\n        );\n      }\n    }\n  }\n\n  private eventInPopupOrTrigger(e: Event): boolean {\n    const target = e.target as HTMLElement;\n    const onTrigger = isOrContains(assertExists(this.triggerElement), target);\n    const onPopup = isOrContains(assertExists(this.popupElement), target);\n    return onTrigger || onPopup;\n  }\n\n  private handleDocMouseDown = (e: Event) => {\n    if (this.closeOnOutsideClick && !this.eventInPopupOrTrigger(e)) {\n      this.closePopup();\n    }\n  };\n\n  private handleDocKeyPress = (e: KeyboardEvent) => {\n    // Close on escape keypress if we are in the toplevel group\n    const nextGroupElement = this.popupElement?.querySelector(\n      `.${Popup.POPUP_GROUP_CLASS}`,\n    );\n    if (!nextGroupElement) {\n      if (this.closeOnEscape && e.key === 'Escape') {\n        this.closePopup();\n      }\n    }\n  };\n\n  private handleContentClick = (e: Event) => {\n    // Close the popup if the clicked element:\n    // - Is in the same group as this class\n    // - Has the magic class\n    const target = e.target as HTMLElement;\n    const childPopup = this.popupElement?.querySelector(\n      `.${Popup.POPUP_GROUP_CLASS}`,\n    );\n    if (childPopup) {\n      if (childPopup.contains(target)) {\n        return;\n      }\n    }\n    if (target.closest(`.${Popup.DISMISS_POPUP_GROUP_CLASS}`)) {\n      this.closePopup();\n    }\n  };\n\n  private closePopup() {\n    if (this.isOpen) {\n      this.isOpen = false;\n      this.onChange(this.isOpen);\n      scheduleFullRedraw('force');\n    }\n  }\n\n  private togglePopup() {\n    this.isOpen = !this.isOpen;\n    this.onChange(this.isOpen);\n    scheduleFullRedraw('force');\n  }\n}\n"]}